<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Compensation Tickets Dashboard</title>
  
  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Custom CSS -->
  <style>
    :root {
      --crispy-red: #d32f2f;
      --crispy-dark: #b71c1c;
      --crispy-light: #ffebee;
      --crispy-accent: #ff7043;
      --bg: #fafafa;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    html, body {
      height: 100%;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text-primary);
    }
    
    .navbar {
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
      padding: 0.8rem 0;
    }
    
    .navbar .navbar-brand {
      color: #fff;
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    .container-page {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }
    
    .card-ghost {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card-ghost:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      padding: 24px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(211,47,47,0.05), rgba(211,47,47,0.1));
      border-left: 6px solid var(--crispy-red);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .stat-card h2 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      color: var(--crispy-red);
    }
    
    .stat-card .text-muted {
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    .tickets-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .tickets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .tickets-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .tickets-header .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      flex: 1;
      margin-bottom: 16px;
    }
    
    .tickets-header .search-input {
      min-width: 200px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 8px 12px;
      font-size: 0.95rem;
    }
    
    .tickets-header .filter-select {
      min-width: 160px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.95rem;
    }
    
    .tickets-header .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .tickets-header .btn {
      border-radius: 8px;
      font-weight: 600;
      padding: 8px 16px;
    }
    
    .tickets-table-container {
      height: 600px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      background: var(--card-bg);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .tickets-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card-bg);
      font-size: 0.95rem;
    }
    
    .tickets-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      color: white;
    }
    
    .tickets-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      position: relative;
    }
    
    .tickets-table th:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 1px;
      background: rgba(255, 255, 255, 0.2);
    }
    
    .tickets-table td {
      padding: 16px 12px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      vertical-align: middle;
      white-space: nowrap;
    }
    
    .tickets-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .tickets-table tbody tr:hover {
      background: rgba(0, 0, 0, 0.02);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .ticket-order-id {
      font-weight: 700;
      color: var(--crispy-dark);
      font-size: 1rem;
    }
    
    .ticket-branch {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .ticket-platform {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .ticket-platform.noon {
      background: rgba(255, 112, 67, 0.1);
      color: var(--crispy-accent);
    }
    
    .ticket-platform.careem {
      background: rgba(126, 87, 194, 0.1);
      color: #7e57c2;
    }
    
    .ticket-issue {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      vertical-align: middle;
    }
    
    .ticket-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .status-open {
      background: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
    
    .status-sent {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }
    
    .status-closed {
      background: rgba(25, 135, 84, 0.1);
      color: #198754;
    }
    
    .status-rejected {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }
    
    .status-escalated {
      background: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
    
    .ticket-amount {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .ticket-amount.compensation {
      color: var(--crispy-red);
    }
    
    .ticket-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    
    .ticket-actions .btn {
      padding: 4px 6px;
      font-size: 0.75rem;
      border-radius: 4px;
      transition: all 0.2s ease;
      margin: 0;
    }
    
    .ticket-actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-whatsapp {
      background-color: #25D366;
      border-color: #25D366;
      color: white;
    }
    
    .btn-whatsapp:hover {
      background-color: #128C7E;
      border-color: #128C7E;
      color: white;
    }
    
    .back-to-top {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .back-to-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, var(--crispy-dark), var(--crispy-red));
    }
    
    .back-to-top.show {
      display: flex;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      background-color: rgba(0,0,0,0.02);
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 16px;
    }
    
    .empty-state h5 {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .empty-state p {
      margin-bottom: 24px;
    }
    
    .chart-container {
      height: 300px;
      margin: 20px 0;
    }
    
    .platform-card {
      padding: 30px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,112,67,0.05), rgba(255,112,67,0.1));
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(255,112,67,0.1);
    }
    
    .platform-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .platform-card h3 {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 15px 0;
      color: var(--crispy-accent);
    }
    
    .platform-card .percentage {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--crispy-accent);
      margin-top: 8px;
    }
    
    .dispute-card {
      padding: 24px;
      border-radius: 16px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .dispute-card.urgent {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.1));
      border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .dispute-card.pending {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 193, 7, 0.1));
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .dispute-card.escalated {
      background: linear-gradient(135deg, rgba(13, 110, 253, 0.05), rgba(13, 110, 253, 0.1));
      border: 1px solid rgba(13, 110, 253, 0.2);
    }
    
    .dispute-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .dispute-card.urgent .dispute-badge {
      background: rgba(220, 53, 69, 0.9);
      color: white;
    }
    
    .dispute-card.pending .dispute-badge {
      background: rgba(255, 193, 7, 0.9);
      color: white;
    }
    
    .dispute-card.escalated .dispute-badge {
      background: rgba(13, 110, 253, 0.9);
      color: white;
    }
    
    .dispute-card h6 {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 15px 0 10px;
      color: var(--text-primary);
    }
    
    .dispute-count {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    .dispute-card.urgent .dispute-count {
      color: var(--crispy-red);
    }
    
    .dispute-card.pending .dispute-count {
      color: #ffc107;
    }
    
    .dispute-card.escalated .dispute-count {
      color: #0d6efd;
    }
    
    .summary-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .summary-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .metric-item {
      text-align: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .metric-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .metric-change {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 4px;
    }
    
    .metric-change.positive {
      color: #198754;
    }
    
    .metric-change.negative {
      color: #dc3545;
    }
    
    .metric-change.neutral {
      color: #6c757d;
    }
    
    .case-badge {
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .badge-high {
      background: var(--crispy-light);
      color: var(--crispy-red);
    }
    
    .badge-medium {
      background: #fff3e0;
      color: #ef6c00;
    }
    
    .badge-low {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .branch-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
    }
    
    .branch-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .branch-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .branch-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .branch-stat-item {
      text-align: center;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .branch-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .branch-stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .case-reasons {
      margin-top: 20px;
    }
    
    .case-reasons h6 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .case-reason-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .case-reason-item:last-child {
      border-bottom: none;
    }
    
    .case-reason-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .case-reason-name {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .case-reason-count {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .case-reason-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin-top: 6px;
      overflow: hidden;
    }
    
    .case-reason-progress {
      height: 100%;
      background: var(--crispy-red);
      border-radius: 4px;
    }
    
    .timeline-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid var(--crispy-red);
    }
    
    .timeline-time {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-right: 15px;
      white-space: nowrap;
    }
    
    .timeline-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
    }
    
    .refund-table-container {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .refund-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .refund-table th {
      background: #f1f3f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .refund-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .refund-table tr:hover {
      background: #f8f9fa;
    }
    
    .status-refunded {
      background: #d4edda;
      color: #155724;
    }
    
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 16px;
      color: #fff;
      z-index: 3000;
      display: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-width: 400px;
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .notification.show {
      display: block;
    }
    
    .notification.success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(56, 142, 60, 0.9));
    }
    
    .notification.error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.9), rgba(211, 47, 47, 0.9));
    }
    
    .notification.warning {
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.9), rgba(245, 124, 0, 0.9));
    }
    
    .notification.info {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(25, 118, 210, 0.9));
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @media (max-width: 768px) {
      .tickets-header .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tickets-header .search-input,
      .tickets-header .filter-select {
        min-width: 100%;
      }
      
      .tickets-header .action-buttons {
        justify-content: stretch;
      }
      
      .tickets-header .action-buttons .btn {
        flex: 1;
      }
      
      .tickets-table {
        font-size: 0.85rem;
      }
      
      .ticket-issue {
        max-width: 150px;
      }
      
      .ticket-actions {
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .platform-cards {
        grid-template-columns: 1fr;
      }
      
      .branch-analysis-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ===== NAVIGATION ===== -->
  <nav class="navbar navbar-expand-lg">
    <div class="container container-page">
      <a class="navbar-brand" href="#"><i class="bi bi-fire-fill me-2" style="font-size:1.6rem"></i> Crispy Chicken — Compensation Tickets</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-white fw-semibold" href="#">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- ===== MAIN CONTENT ===== -->
  <main class="container-page">
    <!-- ===== STATS SECTION ===== -->
    <section class="stats-grid">
      <div class="stat-card text-center">
        <div class="text-muted">Total Cases</div>
        <h2 id="totalTickets">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#0d6efd;">
        <div class="text-muted">Open</div>
        <h2 id="openTickets" style="color:#0d6efd;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#ffc107;">
        <div class="text-muted">Sent</div>
        <h2 id="sentTickets" style="color:#ffc107;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#198754;">
        <div class="text-muted">Closed</div>
        <h2 id="closedTickets" style="color:#198754;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#28a745;">
        <div class="text-muted">Resolved Disputes</div>
        <h2 id="resolvedDisputes" style="color:#28a745;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#17a2b8;">
        <div class="text-muted">Active Compensations</div>
        <h2 id="activeCompensations" style="color:#17a2b8;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Total Compensation</div>
        <h2 id="totalCompensationAmount" style="color:#dc3545;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Rejected</div>
        <h2 id="rejectedTickets" style="color:#dc3545;">0</h2>
      </div>
    </section>
    
    <!-- ===== SUMMARY SECTION ===== -->
    <section class="card-ghost">
      <div class="summary-header">
        <h5>Dashboard Summary</h5>
        <div class="text-muted">
          <i class="bi bi-calendar3 me-1"></i>
          <span id="summaryDate"></span>
        </div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <h6>Financial Overview</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="totalOriginalAmount">0</div>
              <div class="metric-label">Total Original Amount</div>
              <div class="metric-change" id="originalAmountChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalCompensation">0</div>
              <div class="metric-label">Total Compensation</div>
              <div class="metric-change" id="compensationChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalRefunded">0</div>
              <div class="metric-label">Total Refunded</div>
              <div class="metric-change" id="refundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="netCompensation">0</div>
              <div class="metric-label">Net Compensation</div>
              <div class="metric-change" id="netCompensationChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="chart-container">
              <canvas id="amountChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Platform Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="noonTickets">0</div>
              <div class="metric-label">Noon Cases</div>
              <div class="metric-change" id="noonTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemTickets">0</div>
              <div class="metric-label">Careem Cases</div>
              <div class="metric-change" id="careemTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="noonRefunded">0</div>
              <div class="metric-label">Noon Refunded</div>
              <div class="metric-change" id="noonRefundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemRefunded">0</div>
              <div class="metric-label">Careem Refunded</div>
              <div class="metric-change" id="careemRefundedChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="chart-container">
              <canvas id="platformTicketsChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="platformCompensationChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Branch Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="topBranch">-</div>
              <div class="metric-label">Top Branch</div>
              <div class="metric-change" id="topBranchCases">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="topCase">-</div>
              <div class="metric-label">Top Case</div>
              <div class="metric-change" id="topCaseCount">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="caseRate">0%</div>
              <div class="metric-label">Case Rate</div>
              <div class="metric-change" id="caseRateChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="avgOriginalAmount">0</div>
              <div class="metric-label">Avg. Original Amount</div>
              <div class="metric-change" id="avgOriginalAmountChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="chart-container">
              <canvas id="branchCasesChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="caseTypesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ===== DISPUTE SECTION ===== -->
    <section class="card-ghost">
      <div class="dispute-header">
        <h5>Dispute Management</h5>
        <div class="text-muted">
          <i class="bi bi-exclamation-triangle me-1"></i>
          Active disputes requiring attention
        </div>
      </div>
      
      <div class="dispute-grid">
        <div class="dispute-card urgent">
          <div class="dispute-badge">Urgent</div>
          <h6>High Compensation Cases</h6>
          <div class="dispute-count" id="urgentCases">0</div>
          <button class="btn btn-sm btn-danger" onclick="viewUrgentCases()">
            View All
          </button>
        </div>
        
        <div class="dispute-card pending">
          <div class="dispute-badge">Pending</div>
          <h6>Evidence Required</h6>
          <div class="dispute-count" id="evidencePending">0</div>
          <button class="btn btn-sm btn-warning" onclick="requestEvidenceForAll()">
            Request Evidence
          </button>
        </div>
        
        <div class="dispute-card escalated">
          <div class="dispute-badge">Escalated</div>
          <h6>Management Review</h6>
          <div class="dispute-count" id="escalatedCases">0</div>
          <button class="btn btn-sm btn-info" onclick="viewEscalatedCases()">
            Track Progress
          </button>
        </div>
      </div>
      
      <div class="dispute-timeline">
        <h6>Recent Dispute Actions</h6>
        <div id="disputeTimeline">
          <!-- Timeline items will be populated here -->
        </div>
      </div>
    </section>
    
    <!-- ===== PLATFORM CARDS ===== -->
    <section class="platform-cards">
      <div class="platform-card">
        <div class="text-muted">Noon Cases</div>
        <h3 id="noonCount">0</h3>
        <div class="percentage" id="noonPercentage">0%</div>
      </div>
      <div class="platform-card">
        <div class="text-muted">Careem Cases</div>
        <h3 id="careemCount">0</h3>
        <div class="percentage" id="careemPercentage">0%</div>
      </div>
    </section>
    
    <!-- ===== CASE ANALYSIS SECTION ===== -->
    <section class="card-ghost">
      <div class="case-analysis-header">
        <h5>Case Analysis Causing Compensation</h5>
        <div id="caseAnalysisBadge" class="case-badge badge-high">High Level</div>
      </div>
      <div id="branchAnalysisContainer">
        <!-- Branch analysis will be populated here -->
      </div>
    </section>
    
    <!-- ===== TICKETS SECTION ===== -->
    <section class="tickets-section">
      <div class="tickets-header">
        <h5>Compensation Cases</h5>
        <div class="filters">
          <input id="searchInput" class="form-control search-input" placeholder="Search case / branch / issue" />
          <select id="filterBranch" class="form-select filter-select">
            <option value="">All Branches</option>
          </select>
          <select id="filterPlatform" class="form-select filter-select">
            <option value="">All Platforms</option>
            <option>Noon</option>
            <option>Careem</option>
          </select>
          <select id="filterStatus" class="form-select filter-select">
            <option value="">All Status</option>
            <option>Open</option>
            <option>Sent</option>
            <option>Closed</option>
            <option>Rejected</option>
            <option>Escalated</option>
          </select>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle me-1"></i> Add
            </button>
            <button class="btn btn-success" onclick="addSample()">
              <i class="bi bi-flask me-1"></i> Sample
            </button>
            <button class="btn btn-outline-secondary" onclick="exportData()">
              <i class="bi bi-download me-1"></i> Export
            </button>
          </div>
        </div>
      </div>
      <div id="ticketsContainer">
        <!-- Tickets table will be populated here -->
      </div>
    </section>
  </main>
  
  <!-- ===== ADD/EDIT TICKET MODAL ===== -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ticketModalTitle">Add New Compensation Case</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="ticketForm">
            <input type="hidden" id="ticketId">
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="orderId" class="form-label">Order ID</label>
                  <input type="text" class="form-control" id="orderId" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="branch" class="form-label">Branch</label>
                  <select class="form-select" id="branch" required>
                    <option value="">Select Branch</option>
                    <option value="Downtown">Downtown</option>
                    <option value="Mall">Mall</option>
                    <option value="Airport">Airport</option>
                    <option value="North">North</option>
                    <option value="South">South</option>
                    <option value="East">East</option>
                    <option value="West">West</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="platform" class="form-label">Platform</label>
                  <select class="form-select" id="platform" required>
                    <option value="">Select Platform</option>
                    <option value="Noon">Noon</option>
                    <option value="Careem">Careem</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="status" class="form-label">Status</label>
                  <select class="form-select" id="status" required>
                    <option value="Open">Open</option>
                    <option value="Sent">Sent</option>
                    <option value="Closed">Closed</option>
                    <option value="Rejected">Rejected</option>
                    <option value="Escalated">Escalated</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="originalAmount" class="form-label">Original Amount (AED)</label>
                  <input type="number" class="form-control" id="originalAmount" step="0.01" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="compensationAmount" class="form-label">Compensation Amount (AED)</label>
                  <input type="number" class="form-control" id="compensationAmount" step="0.01" required>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="refundMethod" class="form-label">Refund Method</label>
                  <select class="form-select" id="refundMethod">
                    <option value="">Not Refunded</option>
                    <option value="Careem Pay">Careem Pay</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="refundedAmount" class="form-label">Refunded Amount (AED)</label>
                  <input type="number" class="form-control" id="refundedAmount" step="0.01">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="issue" class="form-label">Issue Description</label>
              <textarea class="form-control" id="issue" rows="3" required></textarea>
            </div>
            
            <div class="mb-3">
              <label for="notes" class="form-label">Additional Notes</label>
              <textarea class="form-control" id="notes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTicket()">Save Case</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== BACK TO TOP BUTTON ===== -->
  <button id="backToTop" class="back-to-top" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
  </button>
  
  <!-- ===== NOTIFICATION ===== -->
  <div id="notification" class="notification"></div>
  
  <!-- ===== JAVASCRIPT ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ===== GLOBAL VARIABLES =====
    let tickets = [];
    let branches = ['Downtown', 'Mall', 'Airport', 'North', 'South', 'East', 'West'];
    
    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // Load data from localStorage
      loadData();
      
      // Initialize UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      updateDisputeDashboard();
      
      // Set current date for summary
      const today = new Date();
      document.getElementById('summaryDate').textContent = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Setup event listeners
      setupEventListeners();
      
      // Show notification
      showNotification('Dashboard loaded successfully', 'success');
    });
    
    // ===== DATA MANAGEMENT =====
    function loadData() {
      // Load tickets
      const ticketsData = localStorage.getItem('compensationTickets');
      if (ticketsData) {
        try {
          tickets = JSON.parse(ticketsData);
        } catch (e) {
          console.error('Error parsing tickets data:', e);
          tickets = [];
        }
      } else {
        // Initialize with empty array if no data exists
        tickets = [];
      }
    }
    
    function saveData() {
      localStorage.setItem('compensationTickets', JSON.stringify(tickets));
    }
    
    // ===== UI UPDATE FUNCTIONS =====
    function updateStats() {
      // Total tickets
      document.getElementById('totalTickets').textContent = tickets.length;
      
      // Status counts
      const openTickets = tickets.filter(t => t.status === 'Open').length;
      const sentTickets = tickets.filter(t => t.status === 'Sent').length;
      const closedTickets = tickets.filter(t => t.status === 'Closed').length;
      const rejectedTickets = tickets.filter(t => t.status === 'Rejected').length;
      const escalatedTickets = tickets.filter(t => t.status === 'Escalated').length;
      
      document.getElementById('openTickets').textContent = openTickets;
      document.getElementById('sentTickets').textContent = sentTickets;
      document.getElementById('closedTickets').textContent = closedTickets;
      document.getElementById('rejectedTickets').textContent = rejectedTickets;
      
      // Resolved disputes (closed tickets with refunded amount)
      const resolvedDisputes = tickets.filter(t => t.status === 'Closed' && t.refundedAmount > 0).length;
      document.getElementById('resolvedDisputes').textContent = resolvedDisputes;
      
      // Active compensations (open or sent tickets)
      const activeCompensations = tickets.filter(t => t.status === 'Open' || t.status === 'Sent').length;
      document.getElementById('activeCompensations').textContent = activeCompensations;
      
      // Total compensation amount
      const totalCompensation = tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0);
      document.getElementById('totalCompensationAmount').textContent = totalCompensation.toFixed(2);
    }
    
    function updateSummarySection() {
      // Financial Overview
      const totalOriginalAmount = tickets.reduce((sum, t) => sum + parseFloat(t.originalAmount || 0), 0);
      const totalCompensation = tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0);
      const totalRefunded = tickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0);
      const netCompensation = totalCompensation - totalRefunded;
      
      document.getElementById('totalOriginalAmount').textContent = totalOriginalAmount.toFixed(2);
      document.getElementById('totalCompensation').textContent = totalCompensation.toFixed(2);
      document.getElementById('totalRefunded').textContent = totalRefunded.toFixed(2);
      document.getElementById('netCompensation').textContent = netCompensation.toFixed(2);
      
      // Platform Performance
      const noonTickets = tickets.filter(t => t.platform === 'Noon');
      const careemTickets = tickets.filter(t => t.platform === 'Careem');
      const noonRefunded = noonTickets.filter(t => t.refundedAmount > 0).length;
      const careemRefunded = careemTickets.filter(t => t.refundedAmount > 0).length;
      
      document.getElementById('noonTickets').textContent = noonTickets.length;
      document.getElementById('careemTickets').textContent = careemTickets.length;
      document.getElementById('noonRefunded').textContent = noonRefunded;
      document.getElementById('careemRefunded').textContent = careemRefunded;
      
      // Branch Performance
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranch = Object.keys(branchCounts).reduce((a, b) => 
        branchCounts[a] > branchCounts[b] ? a : b, '-');
      
      document.getElementById('topBranch').textContent = topBranch;
      document.getElementById('topBranchCases').textContent = 
        topBranch !== '-' ? `${branchCounts[topBranch]} cases` : '0 cases';
      
      // Top case type
      const caseTypes = {};
      tickets.forEach(t => {
        // Extract case type from issue description (simplified)
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCase = Object.keys(caseTypes).reduce((a, b) => 
        caseTypes[a] > caseTypes[b] ? a : b, '-');
      
      document.getElementById('topCase').textContent = topCase;
      document.getElementById('topCaseCount').textContent = 
        topCase !== '-' ? `${caseTypes[topCase]} cases` : '0 cases';
      
      // Case rate (cases per 100 orders - simplified calculation)
      const caseRate = tickets.length > 0 ? 
        ((tickets.length / (tickets.length * 10)) * 100).toFixed(1) : 0;
      document.getElementById('caseRate').textContent = `${caseRate}%`;
      
      // Average original amount
      const avgOriginalAmount = tickets.length > 0 ? 
        (totalOriginalAmount / tickets.length).toFixed(2) : 0;
      document.getElementById('avgOriginalAmount').textContent = avgOriginalAmount;
      
      // Update charts
      updateSummaryCharts();
    }
    
    function updateSummaryCharts() {
      // Amount Chart
      const amountCtx = document.getElementById('amountChart').getContext('2d');
      new Chart(amountCtx, {
        type: 'bar',
        data: {
          labels: ['Original', 'Compensation', 'Refunded', 'Net'],
          datasets: [{
            data: [
              tickets.reduce((sum, t) => sum + parseFloat(t.originalAmount || 0), 0),
              tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0),
              tickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0),
              tickets.reduce((sum, t) => sum + (parseFloat(t.compensationAmount || 0) - parseFloat(t.refundedAmount || 0)), 0)
            ],
            backgroundColor: [
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 99, 132, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Status Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Open', 'Sent', 'Closed', 'Rejected', 'Escalated'],
          datasets: [{
            data: [
              tickets.filter(t => t.status === 'Open').length,
              tickets.filter(t => t.status === 'Sent').length,
              tickets.filter(t => t.status === 'Closed').length,
              tickets.filter(t => t.status === 'Rejected').length,
              tickets.filter(t => t.status === 'Escalated').length
            ],
            backgroundColor: [
              'rgba(13, 110, 253, 0.5)',
              'rgba(255, 193, 7, 0.5)',
              'rgba(25, 135, 84, 0.5)',
              'rgba(220, 53, 69, 0.5)',
              'rgba(13, 110, 253, 0.5)'
            ],
            borderColor: [
              'rgba(13, 110, 253, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(25, 135, 84, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(13, 110, 253, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Platform Tickets Chart
      const platformTicketsCtx = document.getElementById('platformTicketsChart').getContext('2d');
      new Chart(platformTicketsCtx, {
        type: 'bar',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            label: 'Cases',
            data: [
              tickets.filter(t => t.platform === 'Noon').length,
              tickets.filter(t => t.platform === 'Careem').length
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Platform Compensation Chart
      const platformCompensationCtx = document.getElementById('platformCompensationChart').getContext('2d');
      new Chart(platformCompensationCtx, {
        type: 'pie',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            data: [
              tickets.filter(t => t.platform === 'Noon').reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0),
              tickets.filter(t => t.platform === 'Careem').reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0)
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
      
      // Branch Cases Chart
      const branchCasesCtx = document.getElementById('branchCasesChart').getContext('2d');
      const branchData = {};
      tickets.forEach(t => {
        branchData[t.branch] = (branchData[t.branch] || 0) + 1;
      });
      
      new Chart(branchCasesCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(branchData),
          datasets: [{
            label: 'Cases',
            data: Object.values(branchData),
            backgroundColor: 'rgba(211, 47, 47, 0.5)',
            borderColor: 'rgba(211, 47, 47, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Case Types Chart
      const caseTypesCtx = document.getElementById('caseTypesChart').getContext('2d');
      const caseTypes = {};
      tickets.forEach(t => {
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      new Chart(caseTypesCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(caseTypes),
          datasets: [{
            data: Object.values(caseTypes),
            backgroundColor: [
              'rgba(211, 47, 47, 0.5)',
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)',
              'rgba(13, 110, 253, 0.5)',
              'rgba(25, 135, 84, 0.5)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    function updatePlatformCards() {
      const noonTickets = tickets.filter(t => t.platform === 'Noon');
      const careemTickets = tickets.filter(t => t.platform === 'Careem');
      
      document.getElementById('noonCount').textContent = noonTickets.length;
      document.getElementById('careemCount').textContent = careemTickets.length;
      
      const total = tickets.length;
      document.getElementById('noonPercentage').textContent = total > 0 ? 
        `${((noonTickets.length / total) * 100).toFixed(1)}%` : '0%';
      document.getElementById('careemPercentage').textContent = total > 0 ? 
        `${((careemTickets.length / total) * 100).toFixed(1)}%` : '0%';
    }
    
    function updateBranchAnalysis() {
      const container = document.getElementById('branchAnalysisContainer');
      
      if (tickets.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No data available for branch analysis</p>';
        return;
      }
      
      // Group tickets by branch
      const branchData = {};
      tickets.forEach(t => {
        if (!branchData[t.branch]) {
          branchData[t.branch] = {
            total: 0,
            compensation: 0,
            refunded: 0,
            issues: {}
          };
        }
        branchData[t.branch].total++;
        branchData[t.branch].compensation += parseFloat(t.compensationAmount || 0);
        branchData[t.branch].refunded += parseFloat(t.refundedAmount || 0);
        
        // Count issues
        const issueType = t.issue.split(' ')[0] || 'Other';
        branchData[t.branch].issues[issueType] = (branchData[t.branch].issues[issueType] || 0) + 1;
      });
      
      // Generate branch analysis cards
      const branchCards = Object.keys(branchData).map(branch => {
        const data = branchData[branch];
        const topIssue = Object.keys(data.issues).reduce((a, b) => 
          data.issues[a] > data.issues[b] ? a : b, '-');
        
        return `
          <div class="branch-card">
            <h6>${branch}</h6>
            <div class="branch-stats">
              <div class="branch-stat-item">
                <div class="branch-stat-value">${data.total}</div>
                <div class="branch-stat-label">Total Cases</div>
              </div>
              <div class="branch-stat-item">
                <div class="branch-stat-value">${data.compensation.toFixed(2)}</div>
                <div class="branch-stat-label">Compensation</div>
              </div>
              <div class="branch-stat-item">
                <div class="branch-stat-value">${data.refunded.toFixed(2)}</div>
                <div class="branch-stat-label">Refunded</div>
              </div>
              <div class="branch-stat-item">
                <div class="branch-stat-value">${topIssue}</div>
                <div class="branch-stat-label">Top Issue</div>
              </div>
            </div>
            <div class="case-reasons">
              <h6>Case Reasons</h6>
              ${Object.keys(data.issues).map(issue => `
                <div class="case-reason-item">
                  <div class="case-reason-info">
                    <div class="case-reason-name">${issue}</div>
                    <div class="case-reason-count">${data.issues[issue]} cases</div>
                  </div>
                  <div class="case-reason-bar">
                    <div class="case-reason-progress" style="width: ${(data.issues[issue] / data.total) * 100}%"></div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `<div class="branch-analysis-grid">${branchCards}</div>`;
    }
    
    function updateDisputeDashboard() {
      // Urgent cases (high compensation amount)
      const urgentCases = tickets.filter(t => parseFloat(t.compensationAmount || 0) > 100);
      document.getElementById('urgentCases').textContent = urgentCases.length;
      
      // Evidence pending cases (simplified - cases without notes)
      const evidencePending = tickets.filter(t => !t.notes || t.notes.trim() === '');
      document.getElementById('evidencePending').textContent = evidencePending.length;
      
      // Escalated cases
      const escalatedCases = tickets.filter(t => t.status === 'Escalated');
      document.getElementById('escalatedCases').textContent = escalatedCases.length;
      
      // Timeline (simplified - last 5 actions)
      const timeline = tickets.slice(-5).reverse().map(ticket => `
        <div class="timeline-item">
          <div class="timeline-time">${new Date(ticket.date).toLocaleString()}</div>
          <div class="timeline-text">
            <strong>${ticket.orderId}</strong> - ${ticket.status} - ${ticket.branch}
          </div>
        </div>
      `).join('');
      
      document.getElementById('disputeTimeline').innerHTML = timeline || '<p class="text-muted">No recent actions</p>';
    }
    
    function renderTicketsTable() {
      const container = document.getElementById('ticketsContainer');
      
      if (tickets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h5>No Cases Found</h5>
            <p>Start by adding a new compensation case or loading sample data.</p>
            <button class="btn btn-primary" onclick="addSample()">
              <i class="bi bi-flask me-1"></i> Load Sample Data
            </button>
          </div>
        `;
        return;
      }
      
      const table = `
        <div class="tickets-table-container">
          <table class="tickets-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Branch</th>
                <th>Platform</th>
                <th>Issue</th>
                <th>Status</th>
                <th>Original Amount</th>
                <th>Compensation</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${tickets.map(ticket => `
                <tr>
                  <td class="ticket-order-id">${ticket.orderId}</td>
                  <td class="ticket-branch">${ticket.branch}</td>
                  <td>
                    <span class="ticket-platform ${ticket.platform.toLowerCase()}">${ticket.platform}</span>
                  </td>
                  <td class="ticket-issue">${ticket.issue}</td>
                  <td>
                    <span class="ticket-status status-${ticket.status.toLowerCase()}">${ticket.status}</span>
                  </td>
                  <td class="ticket-amount">${ticket.originalAmount} AED</td>
                  <td class="ticket-amount compensation">${ticket.compensationAmount} AED</td>
                  <td class="ticket-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTicket(${ticket.id})">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success btn-whatsapp" onclick="sendWhatsApp(${ticket.id})">
                      <i class="bi bi-whatsapp"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTicket(${ticket.id})">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = table;
    }
    
    function updateBranchFilter() {
      const filter = document.getElementById('filterBranch');
      filter.innerHTML = '<option value="">All Branches</option>' +
        branches.map(branch => `<option value="${branch}">${branch}</option>`).join('');
    }
    
    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      // Search input
      document.getElementById('searchInput').addEventListener('input', filterTickets);
      
      // Filter dropdowns
      document.getElementById('filterBranch').addEventListener('change', filterTickets);
      document.getElementById('filterPlatform').addEventListener('change', filterTickets);
      document.getElementById('filterStatus').addEventListener('change', filterTickets);
      
      // Back to top button
      window.addEventListener('scroll', function() {
        const backToTopButton = document.getElementById('backToTop');
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });
    }
    
    // ===== TICKET MANAGEMENT =====
    function openAddModal() {
      document.getElementById('ticketModalTitle').textContent = 'Add New Compensation Case';
      document.getElementById('ticketForm').reset();
      document.getElementById('ticketId').value = '';
      new bootstrap.Modal(document.getElementById('ticketModal')).show();
    }
    
    function saveTicket() {
      const ticketId = document.getElementById('ticketId').value;
      const ticketData = {
        orderId: document.getElementById('orderId').value,
        branch: document.getElementById('branch').value,
        platform: document.getElementById('platform').value,
        status: document.getElementById('status').value,
        originalAmount: parseFloat(document.getElementById('originalAmount').value),
        compensationAmount: parseFloat(document.getElementById('compensationAmount').value),
        refundMethod: document.getElementById('refundMethod').value,
        refundedAmount: parseFloat(document.getElementById('refundedAmount').value) || 0,
        issue: document.getElementById('issue').value,
        notes: document.getElementById('notes').value,
        date: new Date().toISOString()
      };
      
      if (ticketId) {
        // Update existing ticket
        const index = tickets.findIndex(t => t.id === parseInt(ticketId));
        if (index !== -1) {
          tickets[index] = { ...tickets[index], ...ticketData };
        }
      } else {
        // Add new ticket
        ticketData.id = Date.now();
        tickets.push(ticketData);
      }
      
      saveData();
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      renderTicketsTable();
      updateDisputeDashboard();
      
      bootstrap.Modal.getInstance(document.getElementById('ticketModal')).hide();
      showNotification('Case saved successfully', 'success');
    }
    
    function editTicket(id) {
      const ticket = tickets.find(t => t.id === id);
      if (ticket) {
        document.getElementById('ticketModalTitle').textContent = 'Edit Compensation Case';
        document.getElementById('ticketId').value = ticket.id;
        document.getElementById('orderId').value = ticket.orderId;
        document.getElementById('branch').value = ticket.branch;
        document.getElementById('platform').value = ticket.platform;
        document.getElementById('status').value = ticket.status;
        document.getElementById('originalAmount').value = ticket.originalAmount;
        document.getElementById('compensationAmount').value = ticket.compensationAmount;
        document.getElementById('refundMethod').value = ticket.refundMethod || '';
        document.getElementById('refundedAmount').value = ticket.refundedAmount || '';
        document.getElementById('issue').value = ticket.issue;
        document.getElementById('notes').value = ticket.notes;
        
        new bootstrap.Modal(document.getElementById('ticketModal')).show();
      }
    }
    
    function deleteTicket(id) {
      if (confirm('Are you sure you want to delete this case?')) {
        tickets = tickets.filter(t => t.id !== id);
        saveData();
        updateStats();
        updateSummarySection();
        updatePlatformCards();
        updateCharts();
        updateBranchAnalysis();
        renderTicketsTable();
        updateDisputeDashboard();
        showNotification('Case deleted successfully', 'success');
      }
    }
    
    function addSample() {
      const sampleTickets = [
        {
          id: Date.now(),
          orderId: 'NC-001',
          branch: 'Downtown',
          platform: 'Noon',
          status: 'Open',
          originalAmount: 50.00,
          compensationAmount: 25.00,
          refundMethod: '',
          refundedAmount: 0,
          issue: 'Wrong item delivered',
          notes: 'Customer received incorrect order',
          date: new Date().toISOString()
        },
        {
          id: Date.now() + 1,
          orderId: 'CR-001',
          branch: 'Mall',
          platform: 'Careem',
          status: 'Sent',
          originalAmount: 30.00,
          compensationAmount: 15.00,
          refundMethod: 'Careem Pay',
          refundedAmount: 15.00,
          issue: 'Late delivery',
          notes: 'Delivery was 1 hour late',
          date: new Date(Date.now() - 86400000).toISOString()
        },
        {
          id: Date.now() + 2,
          orderId: 'NC-002',
          branch: 'Airport',
          platform: 'Noon',
          status: 'Closed',
          originalAmount: 70.00,
          compensationAmount: 35.00,
          refundMethod: 'Card',
          refundedAmount: 35.00,
          issue: 'Missing items',
          notes: 'Complete refund processed',
          date: new Date(Date.now() - 172800000).toISOString()
        },
        {
          id: Date.now() + 3,
          orderId: 'CR-002',
          branch: 'North',
          platform: 'Careem',
          status: 'Rejected',
          originalAmount: 40.00,
          compensationAmount: 0,
          refundMethod: '',
          refundedAmount: 0,
          issue: 'Quality issue',
          notes: 'Customer complaint denied',
          date: new Date(Date.now() - 259200000).toISOString()
        },
        {
          id: Date.now() + 4,
          orderId: 'NC-003',
          branch: 'South',
          platform: 'Noon',
          status: 'Escalated',
          originalAmount: 90.00,
          compensationAmount: 45.00,
          refundMethod: 'Bank Transfer',
          refundedAmount: 0,
          issue: 'Service issue',
          notes: 'Escalated to management',
          date: new Date(Date.now() - 345600000).toISOString()
        }
      ];
      
      tickets = [...tickets, ...sampleTickets];
      saveData();
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      renderTicketsTable();
      updateDisputeDashboard();
      showNotification('Sample data loaded successfully', 'success');
    }
    
    function sendWhatsApp(id) {
      const ticket = tickets.find(t => t.id === id);
      if (ticket) {
        const message = `Hello, regarding your compensation request for order ${ticket.orderId} at ${ticket.branch} branch. We have received your complaint about: ${ticket.issue}. Our team will review your case and respond shortly.`;
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }
    }
    
    function filterTickets() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const branchFilter = document.getElementById('filterBranch').value;
      const platformFilter = document.getElementById('filterPlatform').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      const filteredTickets = tickets.filter(ticket => {
        const matchesSearch = ticket.orderId.toLowerCase().includes(searchTerm) ||
                            ticket.branch.toLowerCase().includes(searchTerm) ||
                            ticket.issue.toLowerCase().includes(searchTerm);
        const matchesBranch = !branchFilter || ticket.branch === branchFilter;
        const matchesPlatform = !platformFilter || ticket.platform === platformFilter;
        const matchesStatus = !statusFilter || ticket.status === statusFilter;
        
        return matchesSearch && matchesBranch && matchesPlatform && matchesStatus;
      });
      
      const container = document.getElementById('ticketsContainer');
      
      if (filteredTickets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-search"></i>
            <h5>No Cases Found</h5>
            <p>No cases match your current search criteria.</p>
          </div>
        `;
        return;
      }
      
      const table = `
        <div class="tickets-table-container">
          <table class="tickets-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Branch</th>
                <th>Platform</th>
                <th>Issue</th>
                <th>Status</th>
                <th>Original Amount</th>
                <th>Compensation</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filteredTickets.map(ticket => `
                <tr>
                  <td class="ticket-order-id">${ticket.orderId}</td>
                  <td class="ticket-branch">${ticket.branch}</td>
                  <td>
                    <span class="ticket-platform ${ticket.platform.toLowerCase()}">${ticket.platform}</span>
                  </td>
                  <td class="ticket-issue">${ticket.issue}</td>
                  <td>
                    <span class="ticket-status status-${ticket.status.toLowerCase()}">${ticket.status}</span>
                  </td>
                  <td class="ticket-amount">${ticket.originalAmount} AED</td>
                  <td class="ticket-amount compensation">${ticket.compensationAmount} AED</td>
                  <td class="ticket-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTicket(${ticket.id})">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success btn-whatsapp" onclick="sendWhatsApp(${ticket.id})">
                      <i class="bi bi-whatsapp"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTicket(${ticket.id})">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = table;
    }
    
    function exportData() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Order ID,Branch,Platform,Status,Original Amount,Compensation Amount,Refund Method,Refunded Amount,Issue,Notes\n"
        + tickets.map(t => 
          `${t.orderId},${t.branch},${t.platform},${t.status},${t.originalAmount},${t.compensationAmount},${t.refundMethod || ''},${t.refundedAmount || 0},"${t.issue}","${t.notes || ''}"`
        ).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "compensation_tickets.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('Data exported successfully', 'success');
    }
    
    function viewUrgentCases() {
      filterTicketsByStatus('urgent');
    }
    
    function requestEvidenceForAll() {
      tickets.forEach(ticket => {
        if (!ticket.notes || ticket.notes.trim() === '') {
          ticket.notes = 'Evidence requested from customer';
        }
      });
      saveData();
      updateDisputeDashboard();
      renderTicketsTable();
      showNotification('Evidence requested for all pending cases', 'success');
    }
    
    function viewEscalatedCases() {
      filterTicketsByStatus('escalated');
    }
    
    function filterTicketsByStatus(status) {
      let statusFilter = '';
      switch(status) {
        case 'urgent':
          statusFilter = 'Open';
          break;
        case 'escalated':
          statusFilter = 'Escalated';
          break;
      }
      
      document.getElementById('filterStatus').value = statusFilter;
      filterTickets();
    }
    
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // ===== CHARTS =====
    function updateCharts() {
      // This function is called from updateSummaryCharts
      // Individual charts are created there
    }
  </script>
</body>
</html>
