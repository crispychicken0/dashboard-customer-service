<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Compensation Tickets Dashboard</title>
  
  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Custom CSS -->
  <style>
    /* ===== ROOT VARIABLES ===== */
    :root {
      --crispy-red: #d32f2f;
      --crispy-dark: #b71c1c;
      --crispy-light: #ffebee;
      --crispy-accent: #ff7043;
      --bg: #fafafa;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    /* ===== BASE STYLES ===== */
    html, body {
      height: 100%;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text-primary);
      direction: ltr;
    }
    
    /* ===== NAVBAR ===== */
    .navbar {
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
      padding: 0.8rem 0;
    }
    
    .navbar .navbar-brand {
      color: #fff;
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    /* ===== CONTAINER ===== */
    .container-page {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }
    
    /* ===== CARD STYLES ===== */
    .card-ghost {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card-ghost:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }
    
    /* ===== STATS SECTION ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      padding: 24px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(211,47,47,0.05), rgba(211,47,47,0.1));
      border-left: 6px solid var(--crispy-red);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .stat-card h2 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      color: var(--crispy-red);
    }
    
    .stat-card .text-muted {
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    /* ===== SUMMARY SECTION ===== */
    .summary-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .summary-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .summary-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .summary-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .summary-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .metric-item {
      text-align: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .metric-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .metric-change {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 4px;
    }
    
    .metric-change.positive {
      color: #198754;
    }
    
    .metric-change.negative {
      color: #dc3545;
    }
    
    .metric-change.neutral {
      color: #6c757d;
    }
    
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
    }
    
    .mini-chart {
      height: 150px;
    }
    
    /* ===== PLATFORM CARDS ===== */
    .platform-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }
    
    .platform-card {
      padding: 30px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,112,67,0.05), rgba(255,112,67,0.1));
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(255,112,67,0.1);
    }
    
    .platform-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .platform-card h3 {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 15px 0;
      color: var(--crispy-accent);
    }
    
    .platform-card .percentage {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--crispy-accent);
      margin-top: 8px;
    }
    
    /* ===== REPORTS SECTION ===== */
    #reports {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 30px;
    }
    
    .report-card {
      padding: 24px;
      border-radius: 16px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .report-card h5 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
    }
    
    .report-card .chart-container {
      position: relative;
      height: 220px;
    }
    
    /* ===== CASE ANALYSIS ===== */
    .case-analysis-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .case-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .case-analysis-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .case-badge {
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .badge-high {
      background: var(--crispy-light);
      color: var(--crispy-red);
    }
    
    .badge-medium {
      background: #fff3e0;
      color: #ef6c00;
    }
    
    .badge-low {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .branch-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
    }
    
    .branch-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .branch-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .branch-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .branch-stat-item {
      text-align: center;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .branch-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .branch-stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .case-reasons {
      margin-top: 20px;
    }
    
    .case-reasons h6 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .case-reason-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .case-reason-item:last-child {
      border-bottom: none;
    }
    
    .case-reason-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .case-reason-name {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .case-reason-count {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .case-reason-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin-top: 6px;
      overflow: hidden;
    }
    
    .case-reason-progress {
      height: 100%;
      background: var(--crispy-red);
      border-radius: 4px;
    }
    
    /* ===== COMPENSATION ANALYSIS ===== */
    .compensation-analysis-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .compensation-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .compensation-analysis-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .compensation-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .compensation-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .compensation-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .compensation-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .stat-item {
      text-align: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* ===== REJECTION ANALYSIS ===== */
    .rejection-analysis-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .rejection-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .rejection-analysis-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .rejection-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .rejection-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .rejection-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .rejection-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .rejection-metric-item {
      text-align: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .rejection-metric-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 4px;
    }
    
    .rejection-metric-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* ===== REFUND ANALYSIS ===== */
    .refund-analysis-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .refund-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .refund-analysis-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .refund-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .refund-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .refund-card h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--crispy-dark);
    }
    
    .refund-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .refund-metric-item {
      text-align: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .refund-metric-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 4px;
    }
    
    .refund-metric-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .refund-chart-container {
      height: 200px;
      margin-top: 20px;
    }
    
    .refund-table-container {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .refund-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .refund-table th {
      background: #f1f3f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .refund-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .refund-table tr:hover {
      background: #f8f9fa;
    }
    
    .refund-status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-refunded {
      background: #d4edda;
      color: #155724;
    }
    
    /* ===== TICKETS SECTION ===== */
    .tickets-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .tickets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .tickets-header h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
    }
    
    .tickets-header .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      flex: 1;
      margin-bottom: 16px;
    }
    
    .tickets-header .search-input {
      min-width: 200px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 8px 12px;
      font-size: 0.95rem;
    }
    
    .tickets-header .filter-select {
      min-width: 160px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.95rem;
    }
    
    .tickets-header .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .tickets-header .btn {
      border-radius: 8px;
      font-weight: 600;
      padding: 8px 16px;
    }
    
    /* ===== TABLE STYLES ===== */
    .tickets-table-container {
      height: 600px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      background: var(--card-bg);
      border: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
    }
    
    .tickets-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card-bg);
      font-size: 0.95rem;
    }
    
    .tickets-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      color: white;
    }
    
    .tickets-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      position: relative;
    }
    
    .tickets-table th:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 1px;
      background: rgba(255, 255, 255, 0.2);
    }
    
    .tickets-table td {
      padding: 16px 12px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      vertical-align: middle;
      white-space: nowrap;
    }
    
    .tickets-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .tickets-table tbody tr:hover {
      background: rgba(0, 0, 0, 0.02);
      transform: scale(1.005);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    /* ===== CUSTOM SCROLLBAR ===== */
    .tickets-table-container::-webkit-scrollbar {
      width: 10px;
    }
    
    .tickets-table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .tickets-table-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .tickets-table-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--crispy-dark), var(--crispy-red));
      transform: scale(1.1);
    }
    
    /* ===== BACK TO TOP BUTTON ===== */
    .back-to-top {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .back-to-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, var(--crispy-dark), var(--crispy-red));
    }
    
    .back-to-top.show {
      display: flex;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ===== COLUMN SPECIFIC STYLES ===== */
    .ticket-order-id {
      font-weight: 700;
      color: var(--crispy-dark);
      font-size: 1rem;
    }
    
    .ticket-branch {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .ticket-platform {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .ticket-platform.noon {
      background: rgba(255, 112, 67, 0.1);
      color: var(--crispy-accent);
    }
    
    .ticket-platform.careem {
      background: rgba(126, 87, 194, 0.1);
      color: #7e57c2;
    }
    
    .ticket-issue {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      vertical-align: middle;
    }
    
    .issue-expand {
      background: none;
      border: none;
      color: #0d6efd;
      text-decoration: underline;
      font-size: 0.9rem;
      cursor: pointer;
      padding-left: 8px;
      transition: color 0.2s ease;
    }
    
    .issue-expand:hover {
      color: #0b5ed7;
    }
    
    .ticket-evidence {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .ticket-evidence-link {
      color: #0d6efd;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    
    .ticket-evidence-link:hover {
      color: #0b5ed7;
      text-decoration: underline;
    }
    
    .ticket-evidence-none {
      color: var(--text-secondary);
      font-style: italic;
    }
    
    /* ===== EVIDENCE THUMBNAIL STYLES ===== */
    .evidence-thumbnail {
      display: inline-block;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .evidence-thumbnail:hover {
      transform: scale(1.1);
    }
    
    .evidence-thumbnail img {
      border: 2px solid transparent;
      transition: border-color 0.2s;
      border-radius: 4px;
    }
    
    .evidence-thumbnail:hover img {
      border-color: var(--crispy-red);
    }
    
    .ticket-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .ticket-amount {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .ticket-amount.compensation {
      color: var(--crispy-red);
    }
    
    .ticket-amount.refunded {
      color: #28a745;
    }
    
    .ticket-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    
    .ticket-actions .btn {
      padding: 4px 6px;
      font-size: 0.75rem;
      border-radius: 4px;
      transition: all 0.2s ease;
      margin: 0;
    }
    
    .ticket-actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* ===== WHATSAPP BUTTON STYLE ===== */
    .btn-whatsapp {
      background-color: #25D366;
      border-color: #25D366;
      color: white;
    }
    
    .btn-whatsapp:hover {
      background-color: #128C7E;
      border-color: #128C7E;
      color: white;
    }
    
    /* ===== ROW HIGHLIGHTING ===== */
    .tickets-table tbody tr.high-compensation {
      background-color: rgba(255, 235, 238, 0.6) !important;
    }
    
    .tickets-table tbody tr.high-compensation:hover {
      background-color: rgba(255, 235, 238, 0.8) !important;
    }
    
    .tickets-table tbody tr.refunded-case {
      background-color: rgba(220, 242, 220, 0.6) !important;
    }
    
    .tickets-table tbody tr.refunded-case:hover {
      background-color: rgba(220, 242, 220, 0.8) !important;
    }
    
    .tickets-table tbody tr.rejected-case {
      background-color: rgba(255, 236, 236, 0.6) !important;
    }
    
    .tickets-table tbody tr.rejected-case:hover {
      background-color: rgba(255, 236, 236, 0.8) !important;
    }
    
    .tickets-table tbody tr.restaurant-fault {
      background-color: rgba(255, 248, 220, 0.6) !important;
    }
    
    .tickets-table tbody tr.restaurant-fault:hover {
      background-color: rgba(255, 248, 220, 0.8) !important;
    }
    
    /* ===== STATUS BADGE COLORS ===== */
    .status-open {
      background: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }
    
    .status-sent {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }
    
    .status-closed {
      background: rgba(25, 135, 84, 0.1);
      color: #198754;
    }
    
    .status-rejected {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }
    
    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      background-color: rgba(0,0,0,0.02);
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 16px;
    }
    
    .empty-state h5 {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .empty-state p {
      margin-bottom: 24px;
    }
    
    /* ===== LOADING INDICATOR ===== */
    .table-loading {
      position: relative;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .table-loading::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(2px);
      z-index: 10;
    }
    
    .table-loading .loading-spinner {
      position: relative;
      z-index: 11;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(211, 47, 47, 0.1);
      border-top-color: var(--crispy-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ===== MODAL STYLES ===== */
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));
      color: #fff;
      border-radius: 16px 16px 0 0;
      padding: 20px 24px;
    }
    
    .modal-header .modal-title {
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .form-label {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 10px 14px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
      margin-bottom: 16px;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--crispy-red);
      box-shadow: 0 0 0 0.2rem rgba(211,47,47,0.12);
    }
    
    .form-check-label {
      font-size: 0.9rem;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      background-color: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .modal-footer .btn {
      border-radius: 8px;
      font-weight: 600;
      padding: 10px 20px;
    }
    
    /* ===== ENHANCED IMAGE UPLOAD STYLING ===== */
    .image-upload-container {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
      position: relative;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }
    
    .image-upload-container:hover {
      border-color: var(--crispy-red);
      background-color: rgba(211, 47, 47, 0.05);
    }
    
    .image-upload-container input[type="file"] {
      display: none;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .short-link-container {
      margin-top: 16px;
    }
    
    .short-link-input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 8px 12px;
      font-size: 0.95rem;
    }
    
    .short-link-button {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--crispy-red);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    /* ===== SECTION HEADERS ===== */
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--crispy-red);
    }
    
    .section-header i {
      font-size: 1.5rem;
      color: var(--crispy-red);
      margin-right: 10px;
    }
    
    .section-header h6 {
      margin: 0;
      font-weight: 700;
      color: var(--crispy-dark);
    }
    
    /* ===== UPLOAD PROGRESS ===== */
    .upload-progress {
      margin-top: 15px;
      height: 6px;
      background-color: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }
    
    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--crispy-red), var(--crispy-accent));
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* ===== IMAGE PREVIEW GRID ===== */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .image-preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .image-preview-item:hover {
      transform: translateY(-5px);
    }
    
    .image-preview-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    
    .image-preview-item .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .image-preview-item:hover .remove-btn {
      opacity: 1;
    }
    
    .image-preview-item .image-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      font-size: 0.75rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ===== RESPONSIVE STYLES ===== */
    @media (max-width: 1200px){
      .container-page{max-width:100%;padding:0 16px;}
      .tickets-table-container {
        height: 500px;
      }
      .ticket-issue {
        max-width: 200px;
      }
    }
    @media (max-width: 992px){
      #reports{grid-template-columns:1fr;}
      .branch-analysis-grid{grid-template-columns:1fr;}
      .branch-stats{grid-template-columns:repeat(2,1fr);}
      .summary-grid{grid-template-columns:1fr;}
      .chart-row{grid-template-columns:1fr;}
      .refund-grid{grid-template-columns:1fr;}
      .compensation-analysis-grid{grid-template-columns:1fr;}
      .rejection-analysis-grid{grid-template-columns:1fr;}
      .tickets-table-container {
        height: 400px;
      }
      .tickets-table th,
      .tickets-table td {
        padding: 12px 8px;
        font-size: 0.9rem;
      }
      .ticket-issue {
        max-width: 150px;
      }
      .ticket-actions {
        flex-direction: column;
        gap: 4px;
      }
    }
    @media (max-width: 768px){
      .stats-grid{grid-template-columns:1fr;}
      .platform-cards{grid-template-columns:1fr;}
      .tickets-header .filters{flex-direction:column;align-items:stretch;}
      .tickets-header .search-input,.tickets-header .filter-select{min-width:100%;}
      .tickets-header .action-buttons{justify-content:stretch;}
      .tickets-header .action-buttons .btn{flex:1;}
      .tickets-table{font-size:0.85rem;}
      .ticket-actions{justify-content:center;}
      .tickets-table-container {
        height: 350px;
      }
      .tickets-table th,
      .tickets-table td {
        padding: 10px 6px;
      }
      .ticket-issue {
        max-width: 120px;
      }
      .ticket-actions .btn {
        font-size: 0.75rem;
        padding: 4px 6px;
      }
      .image-preview-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
    }
    @media (max-width: 576px){
      .container-page{padding:0 12px;}
      .card-ghost{padding:16px;}
      .stat-card h2{font-size:2rem;}
      .platform-card h3{font-size:1.8rem;}
      .report-card{padding:16px;}
      .tickets-table th,.tickets-table td{padding:8px 4px;}
      .ticket-issue{max-width:80px;}
      .tickets-table-container {
        height: 300px;
      }
      .tickets-table {
        font-size: 0.8rem;
      }
      .ticket-actions {
        gap: 2px;
      }
      .ticket-actions .btn {
        padding: 3px 5px;
        font-size: 0.7rem;
      }
      .image-preview-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- ===== STORAGE INDICATOR ===== -->
  <div id="storageIndicator" class="storage-indicator">0% storage used</div>
  
  <!-- ===== NAVIGATION ===== -->
  <nav class="navbar navbar-expand-lg">
    <div class="container container-page">
      <a class="navbar-brand" href="#"><i class="bi bi-fire-fill me-2" style="font-size:1.6rem"></i> Crispy Chicken — Compensation Tickets</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-white fw-semibold" href="#">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- ===== MAIN CONTENT ===== -->
  <main class="container-page">
    <!-- ===== STATS SECTION ===== -->
    <section class="stats-grid">
      <div class="stat-card text-center">
        <div class="text-muted">Total Cases</div>
        <h2 id="totalTickets">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#0d6efd;">
        <div class="text-muted">Open</div>
        <h2 id="openTickets" style="color:#0d6efd;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#ffc107;">
        <div class="text-muted">Sent</div>
        <h2 id="sentTickets" style="color:#ffc107;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#198754;">
        <div class="text-muted">Closed</div>
        <h2 id="closedTickets" style="color:#198754;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#28a745;">
        <div class="text-muted">Resolved Disputes</div>
        <h2 id="resolvedDisputes" style="color:#28a745;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#17a2b8;">
        <div class="text-muted">Active Compensations</div>
        <h2 id="activeCompensations" style="color:#17a2b8;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Total Compensation</div>
        <h2 id="totalCompensationAmount" style="color:#dc3545;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Rejected</div>
        <h2 id="rejectedTickets" style="color:#dc3545;">0</h2>
      </div>
    </section>
    
    <!-- ===== SUMMARY SECTION ===== -->
    <section class="summary-section">
      <div class="summary-header">
        <h5>Dashboard Summary</h5>
        <div class="text-muted">
          <i class="bi bi-calendar3 me-1"></i>
          <span id="summaryDate"></span>
        </div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <h6>Financial Overview</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="totalOriginalAmount">0</div>
              <div class="metric-label">Total Original Amount</div>
              <div class="metric-change" id="originalAmountChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalCompensation">0</div>
              <div class="metric-label">Total Compensation</div>
              <div class="metric-change" id="compensationChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalRefunded">0</div>
              <div class="metric-label">Total Refunded</div>
              <div class="metric-change" id="refundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="netCompensation">0</div>
              <div class="metric-label">Net Compensation</div>
              <div class="metric-change" id="netCompensationChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="amountChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Platform Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="noonTickets">0</div>
              <div class="metric-label">Noon Cases</div>
              <div class="metric-change" id="noonTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemTickets">0</div>
              <div class="metric-label">Careem Cases</div>
              <div class="metric-change" id="careemTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="noonRefunded">0</div>
              <div class="metric-label">Noon Refunded</div>
              <div class="metric-change" id="noonRefundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemRefunded">0</div>
              <div class="metric-label">Careem Refunded</div>
              <div class="metric-change" id="careemRefundedChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="platformTicketsChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="platformCompensationChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Branch Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="topBranch">-</div>
              <div class="metric-label">Top Branch</div>
              <div class="metric-change" id="topBranchCases">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="topCase">-</div>
              <div class="metric-label">Top Case</div>
              <div class="metric-change" id="topCaseCount">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="caseRate">0%</div>
              <div class="metric-label">Case Rate</div>
              <div class="metric-change" id="caseRateChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="avgOriginalAmount">0</div>
              <div class="metric-label">Avg. Original Amount</div>
              <div class="metric-change" id="avgOriginalAmountChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="branchCasesChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="caseTypesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ===== PLATFORM CARDS ===== -->
    <section class="platform-cards">
      <div class="platform-card">
        <div class="text-muted">Noon Cases</div>
        <h3 id="noonCount">0</h3>
        <div class="percentage" id="noonPercentage">0%</div>
      </div>
      <div class="platform-card">
        <div class="text-muted">Careem Cases</div>
        <h3 id="careemCount">0</h3>
        <div class="percentage" id="careemPercentage">0%</div>
      </div>
    </section>
    
    <!-- ===== REPORTS SECTION ===== -->
    <section id="reports">
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Top Branches by Cases</h5>
          <small class="text-muted" id="topBranchLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="branchChart"></canvas>
        </div>
      </div>
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Case Types Breakdown</h5>
          <small class="text-muted" id="topCaseLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="caseChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- ===== CASE ANALYSIS SECTION ===== -->
    <section class="case-analysis-section">
      <div class="case-analysis-header">
        <h5>Case Analysis Causing Compensation</h5>
        <div id="caseAnalysisBadge" class="case-badge badge-high">High Level</div>
      </div>
      <div id="branchAnalysisContainer"></div>
    </section>
    
    <!-- ===== COMPENSATION ANALYSIS SECTION ===== -->
    <section class="compensation-analysis-section">
      <div class="compensation-analysis-header">
        <h5>Compensation Analysis by Type</h5>
        <div class="text-muted">
          <i class="bi bi-bar-chart me-1"></i>
          Breakdown of compensation cases
        </div>
      </div>
      <div id="compensationAnalysisContainer"></div>
    </section>
    
    <!-- ===== REJECTION ANALYSIS SECTION ===== -->
    <section class="rejection-analysis-section">
      <div class="rejection-analysis-header">
        <h5>Rejection Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-x-circle me-1"></i>
          Analysis of rejected compensation cases
        </div>
      </div>
      <div id="rejectionAnalysisContainer"></div>
    </section>
    
    <!-- ===== REFUND ANALYSIS SECTION ===== -->
    <section class="refund-analysis-section">
      <div class="refund-analysis-header">
        <h5>Refund Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-arrow-repeat me-1"></i>
          Refunded Compensation Tracking
        </div>
      </div>
      <div class="refund-grid">
        <div class="refund-card">
          <h6>Overall Refunds</h6>
          <div class="refund-metrics">
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="totalRefundedAmount">0</div>
              <div class="refund-metric-label">Total Refunded Amount</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundedCasesCount">0</div>
              <div class="refund-metric-label">Refunded Cases</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundRate">0%</div>
              <div class="refund-metric-label">Refund Rate</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="avgRefundedAmount">0</div>
              <div class="refund-metric-label">Avg. Refunded Amount</div>
            </div>
          </div>
        </div>
        
        <div class="refund-card">
          <h6>Refunds by Branch</h6>
          <div class="refund-chart-container">
            <canvas id="refundBranchChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="refund-table-container">
        <table class="refund-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Branch</th>
              <th>Original Amount</th>
              <th>Compensation</th>
              <th>Refunded Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="refundTableBody">
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- ===== TICKETS SECTION ===== -->
    <section class="tickets-section">
      <div class="tickets-header">
        <h5>Compensation Cases</h5>
        <div class="filters">
          <input id="searchInput" class="form-control search-input" placeholder="Search case / branch / issue" />
          <select id="filterBranch" class="form-select filter-select">
            <option value="">All Branches</option>
          </select>
          <select id="filterPlatform" class="form-select filter-select">
            <option value="">All Platforms</option>
            <option>Noon</option>
            <option>Careem</option>
          </select>
          <select id="filterStatus" class="form-select filter-select">
            <option value="">All Status</option>
            <option>Open</option>
            <option>Sent</option>
            <option>Closed</option>
            <option>Rejected</option>
          </select>
          <div class="sort-controls">
            <label class="form-label me-2">Sort by:</label>
            <select id="sortCriteria" class="form-select" onchange="sortTickets(this.value)">
              <option value="date-desc">Date (Newest)</option>
              <option value="date-asc">Date (Oldest)</option>
              <option value="amount-desc">Amount (High to Low)</option>
              <option value="amount-asc">Amount (Low to High)</option>
              <option value="status">Status</option>
              <option value="platform">Platform</option>
            </select>
          </div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle me-1"></i> Add
            </button>
            <button class="btn btn-outline-secondary" onclick="addSample()">
              <i class="bi bi-flask me-1"></i> Sample
            </button>
            <button class="btn btn-success" onclick="document.getElementById('excelUploadInput').click()">
              <i class="bi bi-file-earmark-spreadsheet me-1"></i> Upload Excel/CSV
            </button>
          </div>
        </div>
      </div>
      <div id="ticketsContainer"></div>
    </section>
  </main>
  
  <!-- ===== ADD/EDIT TICKET MODAL ===== -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ticketModalTitle">Add New Compensation Case</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="ticketForm">
            <input type="hidden" id="ticketId">
            
            <!-- Case Details Section -->
            <div class="mb-4">
              <div class="section-header">
                <i class="bi bi-file-earmark-text"></i>
                <h6>Case Details</h6>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="orderId" class="form-label">Order ID <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="orderId" required>
                  <div class="duplicate-warning text-danger mt-1" id="duplicateWarning">
                    <i class="bi bi-exclamation-triangle"></i> Duplicate Order ID detected
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="branch" class="form-label">Branch <span class="text-danger">*</span></label>
                  <select class="form-select" id="branch" required>
                    <option value="">Select Branch</option>
                    <option value="Downtown">Downtown</option>
                    <option value="Mall">Mall</option>
                    <option value="Airport">Airport</option>
                    <option value="North">North</option>
                    <option value="South">South</option>
                    <option value="East">East</option>
                    <option value="West">West</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="platform" class="form-label">Platform <span class="text-danger">*</span></label>
                  <select class="form-select" id="platform" required>
                    <option value="">Select Platform</option>
                    <option value="Noon">Noon</option>
                    <option value="Careem">Careem</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                  <select class="form-select" id="status" required>
                    <option value="Open">Open</option>
                    <option value="Sent">Sent</option>
                    <option value="Closed">Closed</option>
                    <option value="Rejected">Rejected</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Financial Details Section -->
            <div class="mb-4">
              <div class="section-header">
                <i class="bi bi-currency-exchange"></i>
                <h6>Financial Details</h6>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="originalAmount" class="form-label">Original Amount (AED) <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">AED</span>
                    <input type="number" class="form-control" id="originalAmount" step="0.01" required>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="compensationAmount" class="form-label">Compensation Amount (AED) <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text">AED</span>
                    <input type="number" class="form-control" id="compensationAmount" step="0.01" required>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="refundMethod" class="form-label">Refund Method</label>
                  <select class="form-select" id="refundMethod">
                    <option value="">Not Refunded</option>
                    <option value="Careem Pay">Careem Pay</option>
                    <option value="Card">Card</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="refundedAmount" class="form-label">Refunded Amount (AED)</label>
                  <div class="input-group">
                    <span class="input-group-text">AED</span>
                    <input type="number" class="form-control" id="refundedAmount" step="0.01">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Issue Description Section -->
            <div class="mb-4">
              <div class="section-header">
                <i class="bi bi-exclamation-circle"></i>
                <h6>Issue Description <span class="text-danger">*</span></h6>
              </div>
              <textarea class="form-control" id="issue" rows="3" required placeholder="Describe the issue in detail..."></textarea>
              <div class="form-text">Be specific about what went wrong and any relevant details</div>
            </div>
            
            <!-- Evidence Upload Section -->
            <div class="mb-4">
              <div class="section-header">
                <i class="bi bi-camera"></i>
                <h6>Evidence Upload</h6>
              </div>
              <div class="image-upload-container">
                <div class="text-center mb-3">
                  <i class="bi bi-cloud-upload" style="font-size: 2rem;"></i>
                  <p class="mb-2">Drag & drop images here or click to browse</p>
                  <p class="text-muted small">Supported formats: JPG, PNG, GIF (Max 5MB each)</p>
                </div>
                <input type="file" id="evidence" class="d-none" accept="image/*" multiple onchange="handleImageUpload(event)">
                <div class="d-flex justify-content-center">
                  <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('evidence').click()">
                    <i class="bi bi-upload me-1"></i> Select Images
                  </button>
                </div>
                
                <!-- Image Preview Area -->
                <div id="imagePreviewContainer" class="mt-3">
                  <!-- Uploaded images will appear here -->
                </div>
                
                <!-- Evidence Link Option -->
                <div class="mt-3">
                  <label for="evidenceLink" class="form-label">Or provide evidence link</label>
                  <div class="input-group">
                    <input type="url" class="form-control" id="evidenceLink" placeholder="https://example.com/evidence.jpg">
                    <button class="btn btn-outline-secondary" type="button" onclick="shortenLink()">
                      <i class="bi bi-link-45deg"></i> Shorten
                    </button>
                  </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="upload-progress">
                  <div class="upload-progress-bar"></div>
                </div>
              </div>
            </div>
            
            <!-- Additional Notes Section -->
            <div class="mb-4">
              <div class="section-header">
                <i class="bi bi-pencil-square"></i>
                <h6>Additional Notes</h6>
              </div>
              <textarea class="form-control" id="notes" rows="2" placeholder="Any additional information..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTicket()">
            <i class="bi bi-check-circle me-1"></i> Save Case
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== SETTINGS MODAL ===== -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Dashboard Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="settingsForm">
            <div class="mb-3">
              <label for="theme" class="form-label">Theme</label>
              <select class="form-select" id="theme">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="auto">Auto (System)</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="itemsPerPage" class="form-label">Items Per Page</label>
              <select class="form-select" id="itemsPerPage">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="autoRefresh" class="form-label">Auto Refresh (minutes)</label>
              <select class="form-select" id="autoRefresh">
                <option value="0">Disabled</option>
                <option value="1">1</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="30">30</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="backupFrequency" class="form-label">Backup Frequency</label>
              <select class="form-select" id="backupFrequency">
                <option value="0">Disabled</option>
                <option value="1">Daily</option>
                <option value="7">Weekly</option>
                <option value="30">Monthly</option>
              </select>
            </div>
            
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="notifications">
              <label class="form-check-label" for="notifications">
                Enable Notifications
              </label>
            </div>
            
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="confirmActions">
              <label class="form-check-label" for="confirmActions">
                Confirm Before Deleting
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== BRANCH MANAGEMENT MODAL ===== -->
  <div class="modal fade" id="branchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Branch Management</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <button class="btn btn-primary" onclick="addNewBranch()">
              <i class="bi bi-plus-circle me-1"></i> Add New Branch
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Branch Name</th>
                  <th>Manager</th>
                  <th>Contact</th>
                  <th>Address</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="branchTableBody">
                <!-- Branch data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== DAILY SUMMARY MODAL ===== -->
  <div class="modal fade" id="dailySummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Daily Branch Summary</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body daily-summary-modal">
          <div class="mb-3">
            <div class="row">
              <div class="col-md-6">
                <input type="date" class="form-control" id="summaryDateInput">
              </div>
              <div class="col-md-6">
                <button class="btn btn-primary" onclick="generateDailySummary()">
                  <i class="bi bi-calendar-check me-1"></i> Generate Summary
                </button>
              </div>
            </div>
          </div>
          
          <div id="dailySummaryContent">
            <!-- Daily summary content will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="exportDailySummary()">
            <i class="bi bi-download me-1"></i> Export Summary
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== NOTIFICATION CONTAINER ===== -->
  <div id="notificationContainer" class="notification-container"></div>
  
  <!-- ===== LOADING OVERLAY ===== -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>
  
  <!-- ===== EXCEL UPLOAD INPUT (HIDDEN) ===== -->
  <input type="file" id="excelUploadInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
  
  <!-- ===== JAVASCRIPT ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    // ===== GLOBAL VARIABLES =====
    let tickets = [];
    let branches = [];
    let commands = [];
    let settings = {
      theme: 'light',
      itemsPerPage: 25,
      autoRefresh: 0,
      backupFrequency: 7,
      notifications: true,
      confirmActions: true
    };
    
    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // Load data from localStorage
      loadData();
      
      // Initialize UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      updateCommands();
      
      // Set current date for summary
      const today = new Date();
      document.getElementById('summaryDate').textContent = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Set today's date as default for summary date input
      document.getElementById('summaryDateInput').valueAsDate = today;
      
      // Setup event listeners
      setupEventListeners();
      
      // Show notification
      showNotification('Dashboard loaded successfully', 'success');
      
      // Add command
      addCommand('Dashboard initialized', 'System');
    });
    
    // ===== DATA MANAGEMENT =====
    function loadData() {
      // Load tickets
      const ticketsData = localStorage.getItem('compensationTickets');
      if (ticketsData) {
        tickets = JSON.parse(ticketsData);
      } else {
        // Initialize with sample data if none exists
        tickets = [];
      }
      
      // Load branches
      const branchesData = localStorage.getItem('branches');
      if (branchesData) {
        branches = JSON.parse(branchesData);
      } else {
        // Initialize with default branches
        branches = [
          { id: 1, name: 'Downtown', manager: 'John Smith', contact: '+971501234567', address: '123 Main St, Downtown' },
          { id: 2, name: 'Mall', manager: 'Sarah Johnson', contact: '+971502345678', address: '456 Shopping Ave, Mall' },
          { id: 3, name: 'Airport', manager: 'Michael Brown', contact: '+971503456789', address: '789 Airport Rd, Airport' },
          { id: 4, name: 'North', manager: 'Emily Davis', contact: '+971504567890', address: '101 North Blvd, North' },
          { id: 5, name: 'South', manager: 'David Wilson', contact: '+971505678901', address: '202 South St, South' },
          { id: 6, name: 'East', manager: 'Jennifer Miller', contact: '+971506789012', address: '303 East Ave, East' },
          { id: 7, name: 'West', manager: 'Robert Taylor', contact: '+971507890123', address: '404 West Rd, West' }
        ];
        saveBranches();
      }
      
      // Load commands
      const commandsData = localStorage.getItem('commands');
      if (commandsData) {
        commands = JSON.parse(commandsData);
      } else {
        commands = [];
      }
      
      // Load settings
      const settingsData = localStorage.getItem('dashboardSettings');
      if (settingsData) {
        settings = JSON.parse(settingsData);
        applySettings();
      }
      
      // Update storage indicator
      updateStorageIndicator();
    }
    
    function saveData() {
      localStorage.setItem('compensationTickets', JSON.stringify(tickets));
      localStorage.setItem('branches', JSON.stringify(branches));
      localStorage.setItem('commands', JSON.stringify(commands));
      localStorage.setItem('dashboardSettings', JSON.stringify(settings));
      updateStorageIndicator();
    }
    
    function saveBranches() {
      localStorage.setItem('branches', JSON.stringify(branches));
    }
    
    function saveSettings() {
      localStorage.setItem('dashboardSettings', JSON.stringify(settings));
      applySettings();
      showNotification('Settings saved successfully', 'success');
      addCommand('Settings updated', 'User');
    }
    
    function applySettings() {
      // Apply theme
      if (settings.theme === 'dark') {
        document.body.classList.add('dark-theme');
      } else if (settings.theme === 'light') {
        document.body.classList.remove('dark-theme');
      }
      
      // Apply auto refresh
      if (settings.autoRefresh > 0) {
        if (window.refreshInterval) {
          clearInterval(window.refreshInterval);
        }
        window.refreshInterval = setInterval(refreshData, settings.autoRefresh * 60000);
      }
      
      // Apply backup frequency
      if (settings.backupFrequency > 0) {
        if (window.backupInterval) {
          clearInterval(window.backupInterval);
        }
        window.backupInterval = setInterval(backupData, settings.backupFrequency * 86400000);
      }
    }
    
    function updateStorageIndicator() {
      // Calculate storage usage
      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          totalSize += localStorage[key].length + key.length;
        }
      }
      
      // Convert to KB
      const totalSizeKB = (totalSize / 1024).toFixed(2);
      const maxStorageKB = 5120; // 5MB
      const percentage = Math.min(100, Math.round((totalSizeKB / maxStorageKB) * 100));
      
      const indicator = document.getElementById('storageIndicator');
      indicator.textContent = `${percentage}% storage used (${totalSizeKB}KB)`;
      
      if (percentage > 80) {
        indicator.classList.add('storage-warning');
      } else {
        indicator.classList.remove('storage-warning');
      }
    }
    
    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      // Search input
      document.getElementById('searchInput').addEventListener('input', filterTickets);
      
      // Filter dropdowns
      document.getElementById('filterBranch').addEventListener('change', filterTickets);
      document.getElementById('filterPlatform').addEventListener('change', filterTickets);
      document.getElementById('filterStatus').addEventListener('change', filterTickets);
      
      // Order ID input for duplicate check
      document.getElementById('orderId').addEventListener('input', checkForDuplicateOrder);
      
      // Back to top button
      window.addEventListener('scroll', function() {
        const backToTopButton = document.getElementById('backToTop');
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });
      
      // Settings form
      document.getElementById('theme').addEventListener('change', function() {
        settings.theme = this.value;
      });
      
      document.getElementById('itemsPerPage').addEventListener('change', function() {
        settings.itemsPerPage = parseInt(this.value);
      });
      
      document.getElementById('autoRefresh').addEventListener('change', function() {
        settings.autoRefresh = parseInt(this.value);
      });
      
      document.getElementById('backupFrequency').addEventListener('change', function() {
        settings.backupFrequency = parseInt(this.value);
      });
      
      document.getElementById('notifications').addEventListener('change', function() {
        settings.notifications = this.checked;
      });
      
      document.getElementById('confirmActions').addEventListener('change', function() {
        settings.confirmActions = this.checked;
      });
    }
    
    // ===== UI UPDATE FUNCTIONS =====
    function updateStats() {
      // Total tickets
      document.getElementById('totalTickets').textContent = tickets.length;
      
      // Status counts
      const openTickets = tickets.filter(t => t.status === 'Open').length;
      const sentTickets = tickets.filter(t => t.status === 'Sent').length;
      const closedTickets = tickets.filter(t => t.status === 'Closed').length;
      const rejectedTickets = tickets.filter(t => t.status === 'Rejected').length;
      
      document.getElementById('openTickets').textContent = openTickets;
      document.getElementById('sentTickets').textContent = sentTickets;
      document.getElementById('closedTickets').textContent = closedTickets;
      document.getElementById('rejectedTickets').textContent = rejectedTickets;
      
      // Resolved disputes (closed tickets with refunded amount)
      const resolvedDisputes = tickets.filter(t => t.status === 'Closed' && t.refundedAmount > 0).length;
      document.getElementById('resolvedDisputes').textContent = resolvedDisputes;
      
      // Active compensations (open or sent tickets)
      const activeCompensations = tickets.filter(t => t.status === 'Open' || t.status === 'Sent').length;
      document.getElementById('activeCompensations').textContent = activeCompensations;
      
      // Total compensation amount
      const totalCompensation = tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0);
      document.getElementById('totalCompensationAmount').textContent = totalCompensation.toFixed(2);
    }
    
    function updateSummarySection() {
      // Financial Overview
      const totalOriginalAmount = tickets.reduce((sum, t) => sum + parseFloat(t.originalAmount || 0), 0);
      const totalCompensation = tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0);
      const totalRefunded = tickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0);
      const netCompensation = totalCompensation - totalRefunded;
      
      document.getElementById('totalOriginalAmount').textContent = totalOriginalAmount.toFixed(2);
      document.getElementById('totalCompensation').textContent = totalCompensation.toFixed(2);
      document.getElementById('totalRefunded').textContent = totalRefunded.toFixed(2);
      document.getElementById('netCompensation').textContent = netCompensation.toFixed(2);
      
      // Platform Performance
      const noonTickets = tickets.filter(t => t.platform === 'Noon');
      const careemTickets = tickets.filter(t => t.platform === 'Careem');
      const noonRefunded = noonTickets.filter(t => t.refundedAmount > 0).length;
      const careemRefunded = careemTickets.filter(t => t.refundedAmount > 0).length;
      
      document.getElementById('noonTickets').textContent = noonTickets.length;
      document.getElementById('careemTickets').textContent = careemTickets.length;
      document.getElementById('noonRefunded').textContent = noonRefunded;
      document.getElementById('careemRefunded').textContent = careemRefunded;
      
      // Branch Performance
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranch = Object.keys(branchCounts).reduce((a, b) => 
        branchCounts[a] > branchCounts[b] ? a : b, '-');
      
      document.getElementById('topBranch').textContent = topBranch;
      document.getElementById('topBranchCases').textContent = 
        topBranch !== '-' ? `${branchCounts[topBranch]} cases` : '0 cases';
      
      // Top case type
      const caseTypes = {};
      tickets.forEach(t => {
        // Extract case type from issue description (simplified)
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCase = Object.keys(caseTypes).reduce((a, b) => 
        caseTypes[a] > caseTypes[b] ? a : b, '-');
      
      document.getElementById('topCase').textContent = topCase;
      document.getElementById('topCaseCount').textContent = 
        topCase !== '-' ? `${caseTypes[topCase]} cases` : '0 cases';
      
      // Case rate (cases per 100 orders - simplified calculation)
      const caseRate = tickets.length > 0 ? 
        ((tickets.length / (tickets.length * 10)) * 100).toFixed(1) : 0;
      document.getElementById('caseRate').textContent = `${caseRate}%`;
      
      // Average original amount
      const avgOriginalAmount = tickets.length > 0 ? 
        (totalOriginalAmount / tickets.length).toFixed(2) : 0;
      document.getElementById('avgOriginalAmount').textContent = avgOriginalAmount;
      
      // Update charts
      updateSummaryCharts();
    }
    
    function updateSummaryCharts() {
      // Amount Chart
      const amountCtx = document.getElementById('amountChart').getContext('2d');
      new Chart(amountCtx, {
        type: 'bar',
        data: {
          labels: ['Original', 'Compensation', 'Refunded', 'Net'],
          datasets: [{
            data: [
              tickets.reduce((sum, t) => sum + parseFloat(t.originalAmount || 0), 0),
              tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount || 0), 0),
              tickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0),
              tickets.reduce((sum, t) => sum + (parseFloat(t.compensationAmount || 0) - parseFloat(t.refundedAmount || 0)), 0)
            ],
            backgroundColor: [
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 99, 132, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Status Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Open', 'Sent', 'Closed', 'Rejected'],
          datasets: [{
            data: [
              tickets.filter(t => t.status === 'Open').length,
              tickets.filter(t => t.status === 'Sent').length,
              tickets.filter(t => t.status === 'Closed').length,
              tickets.filter(t => t.status === 'Rejected').length
            ],
            backgroundColor: [
              'rgba(13, 110, 253, 0.5)',
              'rgba(255, 193, 7, 0.5)',
              'rgba(25, 135, 84, 0.5)',
              'rgba(220, 53, 69, 0.5)'
            ],
            borderColor: [
              'rgba(13, 110, 253, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(25, 135, 84, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Platform Tickets Chart
      const platformTicketsCtx = document.getElementById('platformTicketsChart').getContext('2d');
      new Chart(platformTicketsCtx, {
        type: 'bar',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            label: 'Cases',
            data: [
              tickets.filter(t => t.platform === 'Noon').length,
              tickets.filter(t => t.platform === 'Careem').length
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Platform Compensation Chart
      const platformCompensationCtx = document.getElementById('platformCompensationChart').getContext('2d');
      new Chart(platformCompensationCtx, {
        type: 'bar',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            label: 'Refunded',
            data: [
              tickets.filter(t => t.platform === 'Noon' && t.refundedAmount > 0).length,
              tickets.filter(t => t.platform === 'Careem' && t.refundedAmount > 0).length
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Branch Cases Chart
      const branchCasesCtx = document.getElementById('branchCasesChart').getContext('2d');
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranches = Object.keys(branchCounts)
        .sort((a, b) => branchCounts[b] - branchCounts[a])
        .slice(0, 5);
      
      new Chart(branchCasesCtx, {
        type: 'bar',
        data: {
          labels: topBranches,
          datasets: [{
            label: 'Cases',
            data: topBranches.map(branch => branchCounts[branch]),
            backgroundColor: 'rgba(211, 47, 47, 0.5)',
            borderColor: 'rgba(211, 47, 47, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Case Types Chart
      const caseTypesCtx = document.getElementById('caseTypesChart').getContext('2d');
      const caseTypes = {};
      tickets.forEach(t => {
        // Extract case type from issue description (simplified)
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCaseTypes = Object.keys(caseTypes)
        .sort((a, b) => caseTypes[b] - caseTypes[a])
        .slice(0, 5);
      
      new Chart(caseTypesCtx, {
        type: 'pie',
        data: {
          labels: topCaseTypes,
          datasets: [{
            data: topCaseTypes.map(caseType => caseTypes[caseType]),
            backgroundColor: [
              'rgba(255, 99, 132, 0.5)',
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 206, 86, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    }
    
    function updatePlatformCards() {
      const noonCount = tickets.filter(t => t.platform === 'Noon').length;
      const careemCount = tickets.filter(t => t.platform === 'Careem').length;
      const total = tickets.length;
      
      const noonPercentage = total > 0 ? ((noonCount / total) * 100).toFixed(1) : 0;
      const careemPercentage = total > 0 ? ((careemCount / total) * 100).toFixed(1) : 0;
      
      document.getElementById('noonCount').textContent = noonCount;
      document.getElementById('careemCount').textContent = careemCount;
      document.getElementById('noonPercentage').textContent = `${noonPercentage}%`;
      document.getElementById('careemPercentage').textContent = `${careemPercentage}%`;
    }
    
    function updateCharts() {
      // Branch Chart
      const branchCtx = document.getElementById('branchChart').getContext('2d');
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranches = Object.keys(branchCounts)
        .sort((a, b) => branchCounts[b] - branchCounts[a])
        .slice(0, 5);
      
      new Chart(branchCtx, {
        type: 'bar',
        data: {
          labels: topBranches,
          datasets: [{
            label: 'Cases',
            data: topBranches.map(branch => branchCounts[branch]),
            backgroundColor: 'rgba(211, 47, 47, 0.5)',
            borderColor: 'rgba(211, 47, 47, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Case Chart
      const caseCtx = document.getElementById('caseChart').getContext('2d');
      const caseTypes = {};
      tickets.forEach(t => {
        // Extract case type from issue description (simplified)
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCaseTypes = Object.keys(caseTypes)
        .sort((a, b) => caseTypes[b] - caseTypes[a])
        .slice(0, 5);
      
      new Chart(caseCtx, {
        type: 'doughnut',
        data: {
          labels: topCaseTypes,
          datasets: [{
            data: topCaseTypes.map(caseType => caseTypes[caseType]),
            backgroundColor: [
              'rgba(255, 99, 132, 0.5)',
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 206, 86, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Update labels
      document.getElementById('topBranchLabel').textContent = 
        topBranches.length > 0 ? `Top: ${topBranches[0]} (${branchCounts[topBranches[0]]} cases)` : 'No data';
      
      document.getElementById('topCaseLabel').textContent = 
        topCaseTypes.length > 0 ? `Top: ${topCaseTypes[0]} (${caseTypes[topCaseTypes[0]]} cases)` : 'No data';
    }
    
    function updateBranchAnalysis() {
      const container = document.getElementById('branchAnalysisContainer');
      container.innerHTML = '';
      
      // Group tickets by branch
      const branchTickets = {};
      tickets.forEach(ticket => {
        if (!branchTickets[ticket.branch]) {
          branchTickets[ticket.branch] = [];
        }
        branchTickets[ticket.branch].push(ticket);
      });
      
      // Create branch analysis grid
      const grid = document.createElement('div');
      grid.className = 'branch-analysis-grid';
      
      // Create a card for each branch
      Object.keys(branchTickets).forEach(branch => {
        const branchCard = document.createElement('div');
        branchCard.className = 'branch-card';
        
        const branchHeader = document.createElement('h6');
        branchHeader.textContent = branch;
        branchCard.appendChild(branchHeader);
        
        // Create branch stats
        const stats = document.createElement('div');
        stats.className = 'branch-stats';
        
        const openCount = branchTickets[branch].filter(t => t.status === 'Open').length;
        const sentCount = branchTickets[branch].filter(t => t.status === 'Sent').length;
        const closedCount = branchTickets[branch].filter(t => t.status === 'Closed').length;
        const rejectedCount = branchTickets[branch].filter(t => t.status === 'Rejected').length;
        
        // Open stat
        const openStat = document.createElement('div');
        openStat.className = 'branch-stat-item';
        const openValue = document.createElement('div');
        openValue.className = 'branch-stat-value';
        openValue.textContent = openCount;
        openValue.style.color = '#0d6efd';
        const openLabel = document.createElement('div');
        openLabel.className = 'branch-stat-label';
        openLabel.textContent = 'Open';
        openStat.appendChild(openValue);
        openStat.appendChild(openLabel);
        stats.appendChild(openStat);
        
        // Sent stat
        const sentStat = document.createElement('div');
        sentStat.className = 'branch-stat-item';
        const sentValue = document.createElement('div');
        sentValue.className = 'branch-stat-value';
        sentValue.textContent = sentCount;
        sentValue.style.color = '#ffc107';
        const sentLabel = document.createElement('div');
        sentLabel.className = 'branch-stat-label';
        sentLabel.textContent = 'Sent';
        sentStat.appendChild(sentValue);
        sentStat.appendChild(sentLabel);
        stats.appendChild(sentStat);
        
        // Closed stat
        const closedStat = document.createElement('div');
        closedStat.className = 'branch-stat-item';
        const closedValue = document.createElement('div');
        closedValue.className = 'branch-stat-value';
        closedValue.textContent = closedCount;
        closedValue.style.color = '#198754';
        const closedLabel = document.createElement('div');
        closedLabel.className = 'branch-stat-label';
        closedLabel.textContent = 'Closed';
        closedStat.appendChild(closedValue);
        closedStat.appendChild(closedLabel);
        stats.appendChild(closedStat);
        
        // Rejected stat
        const rejectedStat = document.createElement('div');
        rejectedStat.className = 'branch-stat-item';
        const rejectedValue = document.createElement('div');
        rejectedValue.className = 'branch-stat-value';
        rejectedValue.textContent = rejectedCount;
        rejectedValue.style.color = '#dc3545';
        const rejectedLabel = document.createElement('div');
        rejectedLabel.className = 'branch-stat-label';
        rejectedLabel.textContent = 'Rejected';
        rejectedStat.appendChild(rejectedValue);
        rejectedStat.appendChild(rejectedLabel);
        stats.appendChild(rejectedStat);
        
        branchCard.appendChild(stats);
        
        // Create case reasons
        const reasons = document.createElement('div');
        reasons.className = 'case-reasons';
        
        const reasonsTitle = document.createElement('h6');
        reasonsTitle.textContent = 'Top Case Reasons';
        reasons.appendChild(reasonsTitle);
        
        // Count case reasons
        const reasonCounts = {};
        branchTickets[branch].forEach(ticket => {
          // Extract case type from issue description (simplified)
          const reason = ticket.issue.split(' ')[0] || 'Other';
          reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
        });
        
        // Sort reasons by count
        const sortedReasons = Object.keys(reasonCounts)
          .sort((a, b) => reasonCounts[b] - reasonCounts[a])
          .slice(0, 3);
        
        // Create reason items
        sortedReasons.forEach(reason => {
          const reasonItem = document.createElement('div');
          reasonItem.className = 'case-reason-item';
          
          const reasonInfo = document.createElement('div');
          reasonInfo.className = 'case-reason-info';
          
          const reasonName = document.createElement('div');
          reasonName.className = 'case-reason-name';
          reasonName.textContent = reason;
          
          const reasonCount = document.createElement('div');
          reasonCount.className = 'case-reason-count';
          reasonCount.textContent = `${reasonCounts[reason]} cases`;
          
          reasonInfo.appendChild(reasonName);
          reasonInfo.appendChild(reasonCount);
          
          const reasonBar = document.createElement('div');
          reasonBar.className = 'case-reason-bar';
          
          const reasonProgress = document.createElement('div');
          reasonProgress.className = 'case-reason-progress';
          const percentage = (reasonCounts[reason] / branchTickets[branch].length) * 100;
          reasonProgress.style.width = `${percentage}%`;
          
          reasonBar.appendChild(reasonProgress);
          
          reasonItem.appendChild(reasonInfo);
          reasonItem.appendChild(reasonBar);
          
          reasons.appendChild(reasonItem);
        });
        
        branchCard.appendChild(reasons);
        grid.appendChild(branchCard);
      });
      
      container.appendChild(grid);
      
      // Update case analysis badge
      const openTickets = tickets.filter(t => t.status === 'Open').length;
      const totalTickets = tickets.length;
      const percentage = totalTickets > 0 ? (openTickets / totalTickets) * 100 : 0;
      
      const badge = document.getElementById('caseAnalysisBadge');
      badge.textContent = `${percentage.toFixed(1)}% Open Cases`;
      
      if (percentage > 30) {
        badge.className = 'case-badge badge-high';
      } else if (percentage > 15) {
        badge.className = 'case-badge badge-medium';
      } else {
        badge.className = 'case-badge badge-low';
      }
    }
    
    function updateCompensationAnalysis() {
      const container = document.getElementById('compensationAnalysisContainer');
      container.innerHTML = '';
      
      // Group tickets by compensation type (simplified - using issue description)
      const compensationTypes = {};
      tickets.forEach(ticket => {
        if (ticket.compensationAmount > 0) {
          // Extract compensation type from issue description (simplified)
          const compType = ticket.issue.split(' ')[0] || 'Other';
          if (!compensationTypes[compType]) {
            compensationTypes[compType] = {
              count: 0,
              totalAmount: 0,
              refundedAmount: 0
            };
          }
          compensationTypes[compType].count++;
          compensationTypes[compType].totalAmount += parseFloat(ticket.compensationAmount);
          compensationTypes[compType].refundedAmount += parseFloat(ticket.refundedAmount || 0);
        }
      });
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'compensation-analysis-grid';
      
      // Create a card for each compensation type
      Object.keys(compensationTypes).forEach(type => {
        const card = document.createElement('div');
        card.className = 'compensation-card';
        
        const header = document.createElement('h6');
        header.textContent = type;
        card.appendChild(header);
        
        // Create stats
        const stats = document.createElement('div');
        stats.className = 'compensation-stats';
        
        // Count stat
        const countStat = document.createElement('div');
        countStat.className = 'stat-item';
        const countValue = document.createElement('div');
        countValue.className = 'stat-value';
        countValue.textContent = compensationTypes[type].count;
        const countLabel = document.createElement('div');
        countLabel.className = 'stat-label';
        countLabel.textContent = 'Cases';
        countStat.appendChild(countValue);
        countStat.appendChild(countLabel);
        stats.appendChild(countStat);
        
        // Total amount stat
        const amountStat = document.createElement('div');
        amountStat.className = 'stat-item';
        const amountValue = document.createElement('div');
        amountValue.className = 'stat-value';
        amountValue.textContent = compensationTypes[type].totalAmount.toFixed(2);
        const amountLabel = document.createElement('div');
        amountLabel.className = 'stat-label';
        amountLabel.textContent = 'Total Amount';
        amountStat.appendChild(amountValue);
        amountStat.appendChild(amountLabel);
        stats.appendChild(amountStat);
        
        // Refunded amount stat
        const refundedStat = document.createElement('div');
        refundedStat.className = 'stat-item';
        const refundedValue = document.createElement('div');
        refundedValue.className = 'stat-value';
        refundedValue.textContent = compensationTypes[type].refundedAmount.toFixed(2);
        const refundedLabel = document.createElement('div');
        refundedLabel.className = 'stat-label';
        refundedLabel.textContent = 'Refunded';
        refundedStat.appendChild(refundedValue);
        refundedStat.appendChild(refundedLabel);
        stats.appendChild(refundedStat);
        
        // Refund rate stat
        const rateStat = document.createElement('div');
        rateStat.className = 'stat-item';
        const rateValue = document.createElement('div');
        rateValue.className = 'stat-value';
        const rate = compensationTypes[type].totalAmount > 0 ? 
          ((compensationTypes[type].refundedAmount / compensationTypes[type].totalAmount) * 100).toFixed(1) : 0;
        rateValue.textContent = `${rate}%`;
        const rateLabel = document.createElement('div');
        rateLabel.className = 'stat-label';
        rateLabel.textContent = 'Refund Rate';
        rateStat.appendChild(rateValue);
        rateStat.appendChild(rateLabel);
        stats.appendChild(rateStat);
        
        card.appendChild(stats);
        grid.appendChild(card);
      });
      
      container.appendChild(grid);
    }
    
    function updateRejectionAnalysis() {
      const container = document.getElementById('rejectionAnalysisContainer');
      container.innerHTML = '';
      
      // Get rejected tickets
      const rejectedTickets = tickets.filter(t => t.status === 'Rejected');
      
      if (rejectedTickets.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No rejected cases found</p>';
        return;
      }
      
      // Group rejected tickets by branch
      const branchRejections = {};
      rejectedTickets.forEach(ticket => {
        if (!branchRejections[ticket.branch]) {
          branchRejections[ticket.branch] = {
            count: 0,
            totalAmount: 0
          };
        }
        branchRejections[ticket.branch].count++;
        branchRejections[ticket.branch].totalAmount += parseFloat(ticket.compensationAmount);
      });
      
      // Group rejected tickets by platform
      const platformRejections = {};
      rejectedTickets.forEach(ticket => {
        if (!platformRejections[ticket.platform]) {
          platformRejections[ticket.platform] = {
            count: 0,
            totalAmount: 0
          };
        }
        platformRejections[ticket.platform].count++;
        platformRejections[ticket.platform].totalAmount += parseFloat(ticket.compensationAmount);
      });
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'rejection-analysis-grid';
      
      // Create a card for branch rejections
      const branchCard = document.createElement('div');
      branchCard.className = 'rejection-card';
      
      const branchHeader = document.createElement('h6');
      branchHeader.textContent = 'Rejections by Branch';
      branchCard.appendChild(branchHeader);
      
      // Create stats
      const branchStats = document.createElement('div');
      branchStats.className = 'rejection-stats';
      
      // Total rejections stat
      const totalRejectionsStat = document.createElement('div');
      totalRejectionsStat.className = 'rejection-metric-item';
      const totalRejectionsValue = document.createElement('div');
      totalRejectionsValue.className = 'rejection-metric-value';
      totalRejectionsValue.textContent = rejectedTickets.length;
      const totalRejectionsLabel = document.createElement('div');
      totalRejectionsLabel.className = 'rejection-metric-label';
      totalRejectionsLabel.textContent = 'Total Rejections';
      totalRejectionsStat.appendChild(totalRejectionsValue);
      totalRejectionsStat.appendChild(totalRejectionsLabel);
      branchStats.appendChild(totalRejectionsStat);
      
      // Total rejected amount stat
      const totalRejectedAmountStat = document.createElement('div');
      totalRejectedAmountStat.className = 'rejection-metric-item';
      const totalRejectedAmountValue = document.createElement('div');
      totalRejectedAmountValue.className = 'rejection-metric-value';
      const totalRejectedAmount = rejectedTickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0);
      totalRejectedAmountValue.textContent = totalRejectedAmount.toFixed(2);
      const totalRejectedAmountLabel = document.createElement('div');
      totalRejectedAmountLabel.className = 'rejection-metric-label';
      totalRejectedAmountLabel.textContent = 'Total Amount';
      totalRejectedAmountStat.appendChild(totalRejectedAmountValue);
      totalRejectedAmountStat.appendChild(totalRejectedAmountLabel);
      branchStats.appendChild(totalRejectedAmountStat);
      
      // Rejection rate stat
      const rejectionRateStat = document.createElement('div');
      rejectionRateStat.className = 'rejection-metric-item';
      const rejectionRateValue = document.createElement('div');
      rejectionRateValue.className = 'rejection-metric-value';
      const rejectionRate = tickets.length > 0 ? ((rejectedTickets.length / tickets.length) * 100).toFixed(1) : 0;
      rejectionRateValue.textContent = `${rejectionRate}%`;
      const rejectionRateLabel = document.createElement('div');
      rejectionRateLabel.className = 'rejection-metric-label';
      rejectionRateLabel.textContent = 'Rejection Rate';
      rejectionRateStat.appendChild(rejectionRateValue);
      rejectionRateStat.appendChild(rejectionRateLabel);
      branchStats.appendChild(rejectionRateStat);
      
      // Top rejecting branch stat
      const topBranchStat = document.createElement('div');
      topBranchStat.className = 'rejection-metric-item';
      const topBranchValue = document.createElement('div');
      topBranchValue.className = 'rejection-metric-value';
      const topBranch = Object.keys(branchRejections).reduce((a, b) => 
        branchRejections[a].count > branchRejections[b].count ? a : b, '-');
      topBranchValue.textContent = topBranch;
      const topBranchLabel = document.createElement('div');
      topBranchLabel.className = 'rejection-metric-label';
      topBranchLabel.textContent = 'Top Branch';
      topBranchStat.appendChild(topBranchValue);
      topBranchStat.appendChild(topBranchLabel);
      branchStats.appendChild(topBranchStat);
      
      branchCard.appendChild(branchStats);
      grid.appendChild(branchCard);
      
      // Create a card for platform rejections
      const platformCard = document.createElement('div');
      platformCard.className = 'rejection-card';
      
      const platformHeader = document.createElement('h6');
      platformHeader.textContent = 'Rejections by Platform';
      platformCard.appendChild(platformHeader);
      
      // Create stats
      const platformStats = document.createElement('div');
      platformStats.className = 'rejection-stats';
      
      // Noon rejections stat
      const noonRejectionsStat = document.createElement('div');
      noonRejectionsStat.className = 'rejection-metric-item';
      const noonRejectionsValue = document.createElement('div');
      noonRejectionsValue.className = 'rejection-metric-value';
      const noonRejections = rejectedTickets.filter(t => t.platform === 'Noon').length;
      noonRejectionsValue.textContent = noonRejections;
      const noonRejectionsLabel = document.createElement('div');
      noonRejectionsLabel.className = 'rejection-metric-label';
      noonRejectionsLabel.textContent = 'Noon Rejections';
      noonRejectionsStat.appendChild(noonRejectionsValue);
      noonRejectionsStat.appendChild(noonRejectionsLabel);
      platformStats.appendChild(noonRejectionsStat);
      
      // Careem rejections stat
      const careemRejectionsStat = document.createElement('div');
      careemRejectionsStat.className = 'rejection-metric-item';
      const careemRejectionsValue = document.createElement('div');
      careemRejectionsValue.className = 'rejection-metric-value';
      const careemRejections = rejectedTickets.filter(t => t.platform === 'Careem').length;
      careemRejectionsValue.textContent = careemRejections;
      const careemRejectionsLabel = document.createElement('div');
      careemRejectionsLabel.className = 'rejection-metric-label';
      careemRejectionsLabel.textContent = 'Careem Rejections';
      careemRejectionsStat.appendChild(careemRejectionsValue);
      careemRejectionsStat.appendChild(careemRejectionsLabel);
      platformStats.appendChild(careemRejectionsStat);
      
      // Noon rejection rate stat
      const noonRejectionRateStat = document.createElement('div');
      noonRejectionRateStat.className = 'rejection-metric-item';
      const noonRejectionRateValue = document.createElement('div');
      noonRejectionRateValue.className = 'rejection-metric-value';
      const noonTickets = tickets.filter(t => t.platform === 'Noon').length;
      const noonRejectionRate = noonTickets > 0 ? ((noonRejections / noonTickets) * 100).toFixed(1) : 0;
      noonRejectionRateValue.textContent = `${noonRejectionRate}%`;
      const noonRejectionRateLabel = document.createElement('div');
      noonRejectionRateLabel.className = 'rejection-metric-label';
      noonRejectionRateLabel.textContent = 'Noon Rate';
      noonRejectionRateStat.appendChild(noonRejectionRateValue);
      noonRejectionRateStat.appendChild(noonRejectionRateLabel);
      platformStats.appendChild(noonRejectionRateStat);
      
      // Careem rejection rate stat
      const careemRejectionRateStat = document.createElement('div');
      careemRejectionRateStat.className = 'rejection-metric-item';
      const careemRejectionRateValue = document.createElement('div');
      careemRejectionRateValue.className = 'rejection-metric-value';
      const careemTickets = tickets.filter(t => t.platform === 'Careem').length;
      const careemRejectionRate = careemTickets > 0 ? ((careemRejections / careemTickets) * 100).toFixed(1) : 0;
      careemRejectionRateValue.textContent = `${careemRejectionRate}%`;
      const careemRejectionRateLabel = document.createElement('div');
      careemRejectionRateLabel.className = 'rejection-metric-label';
      careemRejectionRateLabel.textContent = 'Careem Rate';
      careemRejectionRateStat.appendChild(careemRejectionRateValue);
      careemRejectionRateStat.appendChild(careemRejectionRateLabel);
      platformStats.appendChild(careemRejectionRateStat);
      
      platformCard.appendChild(platformStats);
      grid.appendChild(platformCard);
      
      container.appendChild(grid);
    }
    
    function updateRefundAnalysis() {
      // Get refunded tickets
      const refundedTickets = tickets.filter(t => t.refundedAmount > 0);
      
      // Update refund metrics
      const totalRefundedAmount = refundedTickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount), 0);
      const refundedCasesCount = refundedTickets.length;
      const refundRate = tickets.length > 0 ? ((refundedCasesCount / tickets.length) * 100).toFixed(1) : 0;
      const avgRefundedAmount = refundedCasesCount > 0 ? (totalRefundedAmount / refundedCasesCount).toFixed(2) : 0;
      
      document.getElementById('totalRefundedAmount').textContent = totalRefundedAmount.toFixed(2);
      document.getElementById('refundedCasesCount').textContent = refundedCasesCount;
      document.getElementById('refundRate').textContent = `${refundRate}%`;
      document.getElementById('avgRefundedAmount').textContent = avgRefundedAmount;
      
      // Update refund branch chart
      const refundBranchCtx = document.getElementById('refundBranchChart').getContext('2d');
      
      // Group refunded tickets by branch
      const branchRefunds = {};
      refundedTickets.forEach(ticket => {
        if (!branchRefunds[ticket.branch]) {
          branchRefunds[ticket.branch] = 0;
        }
        branchRefunds[ticket.branch] += parseFloat(t.refundedAmount);
      });
      
      const topBranchRefunds = Object.keys(branchRefunds)
        .sort((a, b) => branchRefunds[b] - branchRefunds[a])
        .slice(0, 5);
      
      new Chart(refundBranchCtx, {
        type: 'bar',
        data: {
          labels: topBranchRefunds,
          datasets: [{
            label: 'Refunded Amount',
            data: topBranchRefunds.map(branch => branchRefunds[branch]),
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Update refund table
      const tableBody = document.getElementById('refundTableBody');
      tableBody.innerHTML = '';
      
      // Sort refunded tickets by date (newest first)
      const sortedRefundedTickets = [...refundedTickets].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });
      
      // Show only the last 10 refunded tickets
      const recentRefundedTickets = sortedRefundedTickets.slice(0, 10);
      
      recentRefundedTickets.forEach(ticket => {
        const row = document.createElement('tr');
        
        // Order ID
        const orderIdCell = document.createElement('td');
        orderIdCell.textContent = ticket.orderId;
        row.appendChild(orderIdCell);
        
        // Branch
        const branchCell = document.createElement('td');
        branchCell.textContent = ticket.branch;
        row.appendChild(branchCell);
        
        // Original Amount
        const originalAmountCell = document.createElement('td');
        originalAmountCell.textContent = parseFloat(ticket.originalAmount).toFixed(2);
        row.appendChild(originalAmountCell);
        
        // Compensation
        const compensationCell = document.createElement('td');
        compensationCell.textContent = parseFloat(ticket.compensationAmount).toFixed(2);
        row.appendChild(compensationCell);
        
        // Refunded Amount
        const refundedAmountCell = document.createElement('td');
        refundedAmountCell.textContent = parseFloat(ticket.refundedAmount).toFixed(2);
        row.appendChild(refundedAmountCell);
        
        // Status
        const statusCell = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.className = 'refund-status-badge status-refunded';
        statusBadge.textContent = 'Refunded';
        statusCell.appendChild(statusBadge);
        row.appendChild(statusCell);
        
        // Date
        const dateCell = document.createElement('td');
        const date = new Date(ticket.date);
        dateCell.textContent = date.toLocaleDateString();
        row.appendChild(dateCell);
        
        tableBody.appendChild(row);
      });
      
      if (recentRefundedTickets.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.className = 'text-center text-muted';
        cell.textContent = 'No refunded cases found';
        row.appendChild(cell);
        tableBody.appendChild(row);
      }
    }
    
    function renderTicketsTable() {
      const container = document.getElementById('ticketsContainer');
      container.innerHTML = '';
      
      // Create table container
      const tableContainer = document.createElement('div');
      tableContainer.className = 'tickets-table-container';
      
      // Create table
      const table = document.createElement('table');
      table.className = 'tickets-table';
      
      // Create table header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      const headers = [
        'Order ID', 'Branch', 'Platform', 'Issue', 'Evidence', 
        'Status', 'Original Amount', 'Compensation', 'Refunded', 'Actions'
      ];
      
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement('tbody');
      
      // Sort tickets by date (newest first)
      const sortedTickets = [...tickets].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });
      
      // Render tickets
      sortedTickets.forEach(ticket => {
        const row = document.createElement('tr');
        
        // Add class based on status
        if (ticket.status === 'Closed' && ticket.refundedAmount > 0) {
          row.classList.add('refunded-case');
        } else if (ticket.status === 'Rejected') {
          row.classList.add('rejected-case');
        } else if (parseFloat(ticket.compensationAmount) > 50) {
          row.classList.add('high-compensation');
        }
        
        // Order ID
        const orderIdCell = document.createElement('td');
        const orderId = document.createElement('div');
        orderId.className = 'ticket-order-id';
        orderId.textContent = ticket.orderId;
        orderIdCell.appendChild(orderId);
        row.appendChild(orderIdCell);
        
        // Branch
        const branchCell = document.createElement('td');
        const branch = document.createElement('div');
        branch.className = 'ticket-branch';
        branch.textContent = ticket.branch;
        branchCell.appendChild(branch);
        row.appendChild(branchCell);
        
        // Platform
        const platformCell = document.createElement('td');
        const platform = document.createElement('span');
        platform.className = `ticket-platform ${ticket.platform.toLowerCase()}`;
        platform.textContent = ticket.platform;
        platformCell.appendChild(platform);
        row.appendChild(platformCell);
        
        // Issue
        const issueCell = document.createElement('td');
        const issueContainer = document.createElement('div');
        issueContainer.className = 'd-flex align-items-center';
        
        const issue = document.createElement('div');
        issue.className = 'ticket-issue';
        issue.textContent = ticket.issue.length > 30 ? 
          `${ticket.issue.substring(0, 30)}...` : ticket.issue;
        issue.title = ticket.issue;
        issueContainer.appendChild(issue);
        
        if (ticket.issue.length > 30) {
          const expandBtn = document.createElement('button');
          expandBtn.className = 'issue-expand';
          expandBtn.textContent = 'more';
          expandBtn.onclick = function() {
            if (issue.textContent.endsWith('...')) {
              issue.textContent = ticket.issue;
              expandBtn.textContent = 'less';
            } else {
              issue.textContent = `${ticket.issue.substring(0, 30)}...`;
              expandBtn.textContent = 'more';
            }
          };
          issueContainer.appendChild(expandBtn);
        }
        
        issueCell.appendChild(issueContainer);
        row.appendChild(issueCell);
        
        // Evidence
        const evidenceCell = document.createElement('td');
        const evidence = document.createElement('div');
        evidence.className = 'ticket-evidence';
        
        if (ticket.evidenceImage || ticket.evidenceLink) {
          if (ticket.evidenceImage) {
            const thumbnail = document.createElement('div');
            thumbnail.className = 'evidence-thumbnail';
            
            const img = document.createElement('img');
            img.src = ticket.evidenceImage;
            img.style.width = '30px';
            img.style.height = '30px';
            img.style.objectFit = 'cover';
            
            thumbnail.appendChild(img);
            evidence.appendChild(thumbnail);
          }
          
          if (ticket.evidenceLink) {
            const link = document.createElement('a');
            link.className = 'ticket-evidence-link';
            link.href = ticket.evidenceLink;
            link.target = '_blank';
            link.innerHTML = '<i class="bi bi-link-45deg"></i>';
            evidence.appendChild(link);
          }
        } else {
          const none = document.createElement('div');
          none.className = 'ticket-evidence-none';
          none.textContent = 'None';
          evidence.appendChild(none);
        }
        
        evidenceCell.appendChild(evidence);
        row.appendChild(evidenceCell);
        
        // Status
        const statusCell = document.createElement('td');
        const status = document.createElement('span');
        status.className = `ticket-status status-${ticket.status.toLowerCase()}`;
        status.textContent = ticket.status;
        statusCell.appendChild(status);
        row.appendChild(statusCell);
        
        // Original Amount
        const originalAmountCell = document.createElement('td');
        const originalAmount = document.createElement('div');
        originalAmount.className = 'ticket-amount';
        originalAmount.textContent = parseFloat(ticket.originalAmount).toFixed(2);
        originalAmountCell.appendChild(originalAmount);
        row.appendChild(originalAmountCell);
        
        // Compensation
        const compensationCell = document.createElement('td');
        const compensation = document.createElement('div');
        compensation.className = 'ticket-amount compensation';
        compensation.textContent = parseFloat(ticket.compensationAmount).toFixed(2);
        compensationCell.appendChild(compensation);
        row.appendChild(compensationCell);
        
        // Refunded
        const refundedCell = document.createElement('td');
        const refunded = document.createElement('div');
        refunded.className = 'ticket-amount refunded';
        refunded.textContent = parseFloat(ticket.refundedAmount || 0).toFixed(2);
        refundedCell.appendChild(refunded);
        row.appendChild(refundedCell);
        
        // Actions
        const actionsCell = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'ticket-actions';
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'Edit';
        editBtn.onclick = function() {
          openEditModal(ticket.id);
        };
        actions.appendChild(editBtn);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'Delete';
        deleteBtn.onclick = function() {
          deleteTicket(ticket.id);
        };
        actions.appendChild(deleteBtn);
        
        // WhatsApp button
        const whatsappBtn = document.createElement('button');
        whatsappBtn.className = 'btn btn-sm btn-whatsapp';
        whatsappBtn.innerHTML = '<i class="bi bi-whatsapp"></i>';
        whatsappBtn.title = 'Share via WhatsApp';
        whatsappBtn.onclick = function() {
          shareViaWhatsApp(ticket);
        };
        actions.appendChild(whatsappBtn);
        
        actionsCell.appendChild(actions);
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
      });
      
      // If no tickets, show empty state
      if (tickets.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 10;
        cell.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h5>No compensation cases found</h5>
            <p>Add a new case or upload data from Excel/CSV</p>
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle me-1"></i> Add New Case
            </button>
          </div>
        `;
        row.appendChild(cell);
        tbody.appendChild(row);
      }
      
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      container.appendChild(tableContainer);
    }
    
    function updateBranchFilter() {
      const filter = document.getElementById('filterBranch');
      
      // Clear existing options except "All Branches"
      while (filter.options.length > 1) {
        filter.remove(1);
      }
      
      // Get unique branches
      const uniqueBranches = [...new Set(tickets.map(t => t.branch))];
      
      // Add branch options
      uniqueBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch;
        option.textContent = branch;
        filter.appendChild(option);
      });
    }
    
    function updateCommands() {
      // Update commands list (last 3 commands)
      const commandsList = document.getElementById('commandsList');
      commandsList.innerHTML = '';
      
      const recentCommands = [...commands].slice(-3).reverse();
      
      recentCommands.forEach(command => {
        const commandItem = document.createElement('div');
        commandItem.className = 'command-item';
        
        const commandText = document.createElement('div');
        commandText.textContent = command.text;
        commandItem.appendChild(commandText);
        
        const commandTime = document.createElement('div');
        commandTime.className = 'command-time';
        const date = new Date(command.timestamp);
        commandTime.textContent = date.toLocaleTimeString();
        commandItem.appendChild(commandTime);
        
        commandsList.appendChild(commandItem);
      });
    }
    
    // ===== TICKET MANAGEMENT =====
    function openAddModal() {
      // Reset form
      document.getElementById('ticketForm').reset();
      document.getElementById('ticketId').value = '';
      document.getElementById('ticketModalTitle').textContent = 'Add New Compensation Case';
      document.getElementById('imagePreviewContainer').innerHTML = '';
      document.getElementById('duplicateWarning').classList.remove('show');
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
      modal.show();
      
      addCommand('Opened add case modal', 'User');
    }
    
    function openEditModal(id) {
      // Find ticket
      const ticket = tickets.find(t => t.id === id);
      if (!ticket) return;
      
      // Populate form
      document.getElementById('ticketId').value = ticket.id;
      document.getElementById('orderId').value = ticket.orderId;
      document.getElementById('branch').value = ticket.branch;
      document.getElementById('platform').value = ticket.platform;
      document.getElementById('status').value = ticket.status;
      document.getElementById('originalAmount').value = ticket.originalAmount;
      document.getElementById('compensationAmount').value = ticket.compensationAmount;
      document.getElementById('refundMethod').value = ticket.refundMethod || '';
      document.getElementById('refundedAmount').value = ticket.refundedAmount || '';
      document.getElementById('issue').value = ticket.issue;
      document.getElementById('notes').value = ticket.notes || '';
      document.getElementById('evidenceLink').value = ticket.evidenceLink || '';
      
      // Show evidence images if exists
      const imageContainer = document.getElementById('imagePreviewContainer');
      imageContainer.innerHTML = '';
      
      if (ticket.evidenceImages && ticket.evidenceImages.length > 0) {
        ticket.evidenceImages.forEach((img, index) => {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'image-preview-item';
          
          const imgElement = document.createElement('img');
          imgElement.src = img;
          imgElement.alt = ticket.evidenceImageNames[index] || 'Evidence';
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.innerHTML = '<i class="bi bi-x"></i>';
          removeBtn.onclick = function() {
            // Remove image from array
            ticket.evidenceImages.splice(index, 1);
            ticket.evidenceImageNames.splice(index, 1);
            imageContainer.removeChild(imageDiv);
          };
          
          const imageInfo = document.createElement('div');
          imageInfo.className = 'image-info';
          imageInfo.textContent = ticket.evidenceImageNames[index] || 'Evidence';
          
          imageDiv.appendChild(imgElement);
          imageDiv.appendChild(removeBtn);
          imageDiv.appendChild(imageInfo);
          imageContainer.appendChild(imageDiv);
        });
      }
      
      // Update modal title
      document.getElementById('ticketModalTitle').textContent = 'Edit Compensation Case';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
      modal.show();
      
      addCommand(`Opened edit case modal for ${ticket.orderId}`, 'User');
    }
    
    function saveTicket() {
      // Get form values
      const id = document.getElementById('ticketId').value;
      const orderId = document.getElementById('orderId').value;
      const branch = document.getElementById('branch').value;
      const platform = document.getElementById('platform').value;
      const status = document.getElementById('status').value;
      const originalAmount = document.getElementById('originalAmount').value;
      const compensationAmount = document.getElementById('compensationAmount').value;
      const refundMethod = document.getElementById('refundMethod').value;
      const refundedAmount = document.getElementById('refundedAmount').value || 0;
      const issue = document.getElementById('issue').value;
      const evidenceLink = document.getElementById('evidenceLink').value;
      const notes = document.getElementById('notes').value;
      
      // Get evidence images
      const imageContainer = document.getElementById('imagePreviewContainer');
      const evidenceImages = [];
      const evidenceImageNames = [];
      
      imageContainer.querySelectorAll('.image-preview-item').forEach(item => {
        const img = item.querySelector('img');
        const info = item.querySelector('.image-info');
        
        if (img && info) {
          evidenceImages.push(img.src);
          evidenceImageNames.push(info.textContent);
        }
      });
      
      // Validate form
      if (!orderId || !branch || !platform || !status || !originalAmount || !compensationAmount || !issue) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      // Check for duplicate order ID
      const duplicateTicket = tickets.find(t => t.orderId === orderId && t.id !== id);
      if (duplicateTicket) {
        showNotification('Duplicate Order ID detected', 'error');
        return;
      }
      
      // Create ticket object
      const ticket = {
        id: id || Date.now().toString(),
        orderId,
        branch,
        platform,
        status,
        originalAmount: parseFloat(originalAmount),
        compensationAmount: parseFloat(compensationAmount),
        refundMethod,
        refundedAmount: parseFloat(refundedAmount),
        issue,
        evidenceImages,
        evidenceImageNames,
        evidenceLink,
        notes,
        date: new Date().toISOString()
      };
      
      // Save ticket
      if (id) {
        // Update existing ticket
        const index = tickets.findIndex(t => t.id === id);
        if (index !== -1) {
          tickets[index] = ticket;
          showNotification('Case updated successfully', 'success');
          addCommand(`Updated case ${orderId}`, 'User');
        }
      } else {
        // Add new ticket
        tickets.push(ticket);
        showNotification('Case added successfully', 'success');
        addCommand(`Added new case ${orderId}`, 'User');
      }
      
      // Save data
      saveData();
      
      // Update UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
      modal.hide();
    }
    
    function deleteTicket(id) {
      if (settings.confirmActions && !confirm('Are you sure you want to delete this case?')) {
        return;
      }
      
      // Find ticket
      const ticket = tickets.find(t => t.id === id);
      if (!ticket) return;
      
      // Delete ticket
      tickets = tickets.filter(t => t.id !== id);
      
      // Save data
      saveData();
      
      // Update UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      
      // Show notification
      showNotification('Case deleted successfully', 'success');
      addCommand(`Deleted case ${ticket.orderId}`, 'User');
    }
    
    function addSample() {
      // Sample data
      const sampleTickets = [
        {
          id: Date.now().toString(),
          orderId: 'ORD-001',
          branch: 'Downtown',
          platform: 'Noon',
          status: 'Closed',
          originalAmount: 85.50,
          compensationAmount: 25.00,
          refundMethod: 'Card',
          refundedAmount: 25.00,
          issue: 'Wrong item delivered',
          evidenceImages: [],
          evidenceImageNames: [],
          evidenceLink: 'https://example.com/evidence1.jpg',
          notes: 'Customer received wrong item',
          date: new Date().toISOString()
        },
        {
          id: (Date.now() + 1).toString(),
          orderId: 'ORD-002',
          branch: 'Mall',
          platform: 'Careem',
          status: 'Open',
          originalAmount: 120.00,
          compensationAmount: 40.00,
          refundMethod: '',
          refundedAmount: 0,
          issue: 'Late delivery',
          evidenceImages: [],
          evidenceImageNames: [],
          evidenceLink: '',
          notes: 'Order was 45 minutes late',
          date: new Date(Date.now() - 86400000).toISOString() // Yesterday
        },
        {
          id: (Date.now() + 2).toString(),
          orderId: 'ORD-003',
          branch: 'Airport',
          platform: 'Noon',
          status: 'Rejected',
          originalAmount: 65.00,
          compensationAmount: 20.00,
          refundMethod: '',
          refundedAmount: 0,
          issue: 'Missing items',
          evidenceImages: [],
          evidenceImageNames: [],
          evidenceLink: 'https://example.com/evidence3.jpg',
          notes: 'Customer claimed missing items but no evidence provided',
          date: new Date(Date.now() - 172800000).toISOString() // 2 days ago
        }
      ];
      
      // Add sample tickets
      tickets.push(...sampleTickets);
      
      // Save data
      saveData();
      
      // Update UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      
      // Show notification
      showNotification('Sample data added successfully', 'success');
      addCommand('Added sample data', 'User');
    }
    
    // ===== IMAGE UPLOAD FUNCTIONS =====
    function handleImageUpload(event) {
      const files = event.target.files;
      const previewContainer = document.getElementById('imagePreviewContainer');
      
      Array.from(files).forEach(file => {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          showNotification('Please upload only image files', 'error');
          return;
        }
        
        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          showNotification(`File ${file.name} is too large. Max size is 5MB.`, 'error');
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const imageData = {
            id: Date.now() + Math.random(),
            name: file.name,
            size: formatFileSize(file.size),
            data: e.target.result
          };
          
          // Display image preview
          displayImagePreview(imageData);
          showNotification(`${file.name} uploaded successfully`, 'success');
        };
        
        reader.readAsDataURL(file);
      });
      
      // Show upload progress
      showUploadProgress();
    }
    
    function displayImagePreview(imageData) {
      const previewContainer = document.getElementById('imagePreviewContainer');
      
      const imageDiv = document.createElement('div');
      imageDiv.className = 'image-preview-item';
      imageDiv.id = `preview-${imageData.id}`;
      
      const img = document.createElement('img');
      img.src = imageData.data;
      img.alt = imageData.name;
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.innerHTML = '<i class="bi bi-x"></i>';
      removeBtn.onclick = function() {
        removeImage(imageData.id);
      };
      
      const info = document.createElement('div');
      info.className = 'image-info';
      info.textContent = imageData.name;
      
      imageDiv.appendChild(img);
      imageDiv.appendChild(removeBtn);
      imageDiv.appendChild(info);
      
      previewContainer.appendChild(imageDiv);
    }
    
    function removeImage(id) {
      const previewElement = document.getElementById(`preview-${id}`);
      if (previewElement) {
        previewElement.remove();
      }
      showNotification('Image removed', 'info');
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    function showUploadProgress() {
      const progressContainer = document.getElementById('uploadProgress');
      progressContainer.style.display = 'block';
      
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        document.querySelector('.upload-progress-bar').style.width = progress + '%';
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 500);
        }
      }, 100);
    }
    
    // ===== FILTERING AND SORTING =====
    function filterTickets() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const branchFilter = document.getElementById('filterBranch').value;
      const platformFilter = document.getElementById('filterPlatform').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      // Get all rows in the table
      const rows = document.querySelectorAll('#ticketsContainer tbody tr');
      
      rows.forEach(row => {
        // Skip empty state row
        if (row.querySelector('.empty-state')) return;
        
        // Get cell values
        const orderId = row.cells[0].textContent.toLowerCase();
        const branch = row.cells[1].textContent.toLowerCase();
        const platform = row.cells[2].textContent.toLowerCase();
        const issue = row.cells[3].textContent.toLowerCase();
        const status = row.cells[5].textContent.toLowerCase();
        
        // Check if row matches filters
        const matchesSearch = orderId.includes(searchTerm) || 
                              branch.includes(searchTerm) || 
                              issue.includes(searchTerm);
        const matchesBranch = !branchFilter || branch === branchFilter.toLowerCase();
        const matchesPlatform = !platformFilter || platform === platformFilter.toLowerCase();
        const matchesStatus = !statusFilter || status === statusFilter.toLowerCase();
        
        // Show or hide row
        if (matchesSearch && matchesBranch && matchesPlatform && matchesStatus) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    function sortTickets(criteria) {
      // Get all rows in the table
      const tbody = document.querySelector('#ticketsContainer tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Skip empty state row
      if (rows.length === 1 && rows[0].querySelector('.empty-state')) {
        return;
      }
      
      // Sort rows based on criteria
      rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (criteria) {
          case 'date-desc':
            // Get date from ticket data (not directly available in DOM)
            const aOrderId = a.cells[0].textContent;
            const bOrderId = b.cells[0].textContent;
            const aTicket = tickets.find(t => t.orderId === aOrderId);
            const bTicket = tickets.find(t => t.orderId === bOrderId);
            return new Date(bTicket.date) - new Date(aTicket.date);
            
          case 'date-asc':
            const aOrderIdAsc = a.cells[0].textContent;
            const bOrderIdAsc = b.cells[0].textContent;
            const aTicketAsc = tickets.find(t => t.orderId === aOrderIdAsc);
            const bTicketAsc = tickets.find(t => t.orderId === bOrderIdAsc);
            return new Date(aTicketAsc.date) - new Date(bTicketAsc.date);
            
          case 'amount-desc':
            aValue = parseFloat(a.cells[7].textContent);
            bValue = parseFloat(b.cells[7].textContent);
            return bValue - aValue;
            
          case 'amount-asc':
            aValue = parseFloat(a.cells[7].textContent);
            bValue = parseFloat(b.cells[7].textContent);
            return aValue - bValue;
            
          case 'status':
            aValue = a.cells[5].textContent;
            bValue = b.cells[5].textContent;
            return aValue.localeCompare(bValue);
            
          case 'platform':
            aValue = a.cells[2].textContent;
            bValue = b.cells[2].textContent;
            return aValue.localeCompare(bValue);
            
          default:
            return 0;
        }
      });
      
      // Reorder rows in the table
      rows.forEach(row => tbody.appendChild(row));
      
      addCommand(`Sorted tickets by ${criteria}`, 'User');
    }
    
    // ===== FILE HANDLING =====
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let data;
          
          if (file.name.endsWith('.csv')) {
            // Parse CSV
            data = parseCSV(e.target.result);
          } else {
            // Parse Excel
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            data = XLSX.utils.sheet_to_json(worksheet);
          }
          
          // Process data
          const newTickets = data.map(row => {
            return {
              id: row.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
              orderId: row['Order ID'] || row.orderId || '',
              branch: row.Branch || row.branch || '',
              platform: row.Platform || row.platform || '',
              status: row.Status || row.status || 'Open',
              originalAmount: parseFloat(row['Original Amount'] || row.originalAmount || 0),
              compensationAmount: parseFloat(row['Compensation Amount'] || row.compensationAmount || 0),
              refundMethod: row['Refund Method'] || row.refundMethod || '',
              refundedAmount: parseFloat(row['Refunded Amount'] || row.refundedAmount || 0),
              issue: row.Issue || row.issue || '',
              evidenceImages: [],
              evidenceImageNames: [],
              evidenceLink: row['Evidence Link'] || row.evidenceLink || '',
              notes: row.Notes || row.notes || '',
              date: row.Date ? new Date(row.Date).toISOString() : new Date().toISOString()
            };
          });
          
          // Add new tickets
          tickets.push(...newTickets);
          
          // Save data
          saveData();
          
          // Update UI
          updateStats();
          updateSummarySection();
          updatePlatformCards();
          updateCharts();
          updateBranchAnalysis();
          updateCompensationAnalysis();
          updateRejectionAnalysis();
          updateRefundAnalysis();
          renderTicketsTable();
          updateBranchFilter();
          
          // Show notification
          showNotification(`${newTickets.length} cases imported successfully`, 'success');
          addCommand(`Imported ${newTickets.length} cases from ${file.name}`, 'User');
          
          // Reset file input
          event.target.value = '';
          
        } catch (error) {
          console.error('Error parsing file:', error);
          showNotification('Error parsing file. Please check the format.', 'error');
        }
      };
      
      reader.readAsBinaryString(file);
    }
    
    function parseCSV(csv) {
      const lines = csv.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const result = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        if (values.length === headers.length) {
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index];
          });
          result.push(obj);
        }
      }
      
      return result;
    }
    
    function exportToExcel() {
      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(tickets.map(ticket => ({
        'Order ID': ticket.orderId,
        'Branch': ticket.branch,
        'Platform': ticket.platform,
        'Status': ticket.status,
        'Original Amount': ticket.originalAmount,
        'Compensation Amount': ticket.compensationAmount,
        'Refund Method': ticket.refundMethod,
        'Refunded Amount': ticket.refundedAmount,
        'Issue': ticket.issue,
        'Evidence Link': ticket.evidenceLink,
        'Notes': ticket.notes,
        'Date': new Date(ticket.date).toLocaleDateString()
      })));
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Compensation Cases');
      
      // Save file
      XLSX.writeFile(wb, 'compensation_cases.xlsx');
      
      showNotification('Data exported to Excel successfully', 'success');
      addCommand('Exported data to Excel', 'User');
    }
    
    function exportToCSV() {
      // Create CSV content
      const headers = [
        'Order ID', 'Branch', 'Platform', 'Status', 'Original Amount', 
        'Compensation Amount', 'Refund Method', 'Refunded Amount', 
        'Issue', 'Evidence Link', 'Notes', 'Date'
      ];
      
      const csvContent = [
        headers.join(','),
        ...tickets.map(ticket => [
          ticket.orderId,
          ticket.branch,
          ticket.platform,
          ticket.status,
          ticket.originalAmount,
          ticket.compensationAmount,
          ticket.refundMethod,
          ticket.refundedAmount,
          `"${ticket.issue}"`,
          ticket.evidenceLink,
          `"${ticket.notes}"`,
          new Date(ticket.date).toLocaleDateString()
        ].join(','))
      ].join('\n');
      
      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'compensation_cases.csv';
      link.click();
      
      showNotification('Data exported to CSV successfully', 'success');
      addCommand('Exported data to CSV', 'User');
    }
    
    function exportToPDF() {
      // This would typically use a library like jsPDF
      // For simplicity, we'll just show a notification
      showNotification('PDF export feature coming soon', 'info');
      addCommand('Attempted to export to PDF', 'User');
    }
    
    // ===== UTILITY FUNCTIONS =====
    function checkForDuplicateOrder() {
      const orderId = document.getElementById('orderId').value;
      const ticketId = document.getElementById('ticketId').value;
      
      // Check for duplicate order ID
      const duplicateTicket = tickets.find(t => t.orderId === orderId && t.id !== ticketId);
      
      const warning = document.getElementById('duplicateWarning');
      if (duplicateTicket && orderId) {
        warning.classList.add('show');
      } else {
        warning.classList.remove('show');
      }
    }
    
    function shortenLink() {
      const link = document.getElementById('evidenceLink').value;
      if (!link) {
        showNotification('Please enter a link to shorten', 'error');
        return;
      }
      
      // This would typically use a URL shortening service API
      // For simplicity, we'll just show a notification
      showNotification('Link shortened successfully', 'success');
      addCommand('Shortened evidence link', 'User');
    }
    
    function shareViaWhatsApp(ticket) {
      const message = `Compensation Case Details:\n\n` +
        `Order ID: ${ticket.orderId}\n` +
        `Branch: ${ticket.branch}\n` +
        `Platform: ${ticket.platform}\n` +
        `Status: ${ticket.status}\n` +
        `Original Amount: ${ticket.originalAmount} AED\n` +
        `Compensation: ${ticket.compensationAmount} AED\n` +
        `Issue: ${ticket.issue}\n\n` +
        `Evidence: ${ticket.evidenceLink || 'None'}`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
      
      addCommand(`Shared case ${ticket.orderId} via WhatsApp`, 'User');
    }
    
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    
    function showNotification(message, type = 'info') {
      if (!settings.notifications) return;
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.getElementById('notificationContainer').appendChild(notification);
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // Hide notification after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        
        // Remove notification from DOM after animation completes
        setTimeout(() => {
          notification.remove();
        }, 400);
      }, 3000);
    }
    
    function addCommand(text, user = 'System') {
      const command = {
        text,
        user,
        timestamp: new Date().toISOString()
      };
      
      commands.push(command);
      
      // Keep only the last 100 commands
      if (commands.length > 100) {
        commands = commands.slice(-100);
      }
      
      // Save commands
      localStorage.setItem('commands', JSON.stringify(commands));
      
      // Update commands display
      updateCommands();
    }
    
    function refreshData() {
      // Show loading overlay
      document.getElementById('loadingOverlay').style.display = 'flex';
      
      // Simulate loading delay
      setTimeout(() => {
        // Update UI
        updateStats();
        updateSummarySection();
        updatePlatformCards();
        updateCharts();
        updateBranchAnalysis();
        updateCompensationAnalysis();
        updateRejectionAnalysis();
        updateRefundAnalysis();
        renderTicketsTable();
        updateBranchFilter();
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // Show notification
        showNotification('Data refreshed successfully', 'success');
        addCommand('Refreshed data', 'User');
      }, 1000);
    }
    
    function clearAllData() {
      if (settings.confirmActions && !confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        return;
      }
      
      // Clear data
      tickets = [];
      commands = [];
      
      // Save data
      saveData();
      
      // Update UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      updateCommands();
      
      // Show notification
      showNotification('All data cleared successfully', 'success');
      addCommand('Cleared all data', 'User');
    }
    
    function backupData() {
      // Create backup object
      const backup = {
        tickets,
        branches,
        commands,
        settings,
        timestamp: new Date().toISOString()
      };
      
      // Convert to JSON
      const backupJson = JSON.stringify(backup);
      
      // Create blob and download
      const blob = new Blob([backupJson], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `compensation_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('Backup created successfully', 'success');
      addCommand('Created data backup', 'User');
    }
    
    function restoreData() {
      // Create file input
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backup = JSON.parse(e.target.result);
            
            // Restore data
            tickets = backup.tickets || [];
            branches = backup.branches || [];
            commands = backup.commands || [];
            settings = backup.settings || settings;
            
            // Save data
            saveData();
            
            // Apply settings
            applySettings();
            
            // Update UI
            updateStats();
            updateSummarySection();
            updatePlatformCards();
            updateCharts();
            updateBranchAnalysis();
            updateCompensationAnalysis();
            updateRejectionAnalysis();
            updateRefundAnalysis();
            renderTicketsTable();
            updateBranchFilter();
            updateCommands();
            
            showNotification('Data restored successfully', 'success');
            addCommand('Restored data from backup', 'User');
            
          } catch (error) {
            console.error('Error restoring backup:', error);
            showNotification('Error restoring backup. Please check the file.', 'error');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    function archiveOldCases() {
      if (settings.confirmActions && !confirm('Are you sure you want to archive old cases?')) {
        return;
      }
      
      // Get cases older than 30 days
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      const oldCases = tickets.filter(t => new Date(t.date) < thirtyDaysAgo);
      
      if (oldCases.length === 0) {
        showNotification('No old cases to archive', 'info');
        return;
      }
      
      // Create archive
      const archive = {
        cases: oldCases,
        timestamp: new Date().toISOString()
      };
      
      // Convert to JSON
      const archiveJson = JSON.stringify(archive);
      
      // Create blob and download
      const blob = new Blob([archiveJson], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `cases_archive_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      // Remove old cases from tickets
      tickets = tickets.filter(t => new Date(t.date) >= thirtyDaysAgo);
      
      // Save data
      saveData();
      
      // Update UI
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateBranchFilter();
      
      showNotification(`${oldCases.length} cases archived successfully`, 'success');
      addCommand(`Archived ${oldCases.length} old cases`, 'User');
    }
    
    function checkForDuplicates() {
      const orderIds = tickets.map(t => t.orderId);
      const duplicateOrderIds = orderIds.filter((id, index) => orderIds.indexOf(id) !== index);
      const uniqueDuplicates = [...new Set(duplicateOrderIds)];
      
      if (uniqueDuplicates.length === 0) {
        showNotification('No duplicate cases found', 'success');
        addCommand('Checked for duplicates - none found', 'User');
        return;
      }
      
      // Highlight duplicate rows
      const rows = document.querySelectorAll('#ticketsContainer tbody tr');
      
      rows.forEach(row => {
        // Skip empty state row
        if (row.querySelector('.empty-state')) return;
        
        const orderId = row.cells[0].textContent;
        
        if (uniqueDuplicates.includes(orderId)) {
          row.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
        }
      });
      
      showNotification(`${uniqueDuplicates.length} duplicate cases found and highlighted`, 'warning');
      addCommand(`Found ${uniqueDuplicates.length} duplicate cases`, 'User');
    }
    
    // ===== MODAL FUNCTIONS =====
    function openSettingsModal() {
      // Populate form with current settings
      document.getElementById('theme').value = settings.theme;
      document.getElementById('itemsPerPage').value = settings.itemsPerPage;
      document.getElementById('autoRefresh').value = settings.autoRefresh;
      document.getElementById('backupFrequency').value = settings.backupFrequency;
      document.getElementById('notifications').checked = settings.notifications;
      document.getElementById('confirmActions').checked = settings.confirmActions;
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
      
      addCommand('Opened settings modal', 'User');
    }
    
    function openBranchManagement() {
      // Populate branch table
      const tableBody = document.getElementById('branchTableBody');
      tableBody.innerHTML = '';
      
      branches.forEach(branch => {
        const row = document.createElement('tr');
        
        // Name
        const nameCell = document.createElement('td');
        nameCell.textContent = branch.name;
        row.appendChild(nameCell);
        
        // Manager
        const managerCell = document.createElement('td');
        managerCell.textContent = branch.manager;
        row.appendChild(managerCell);
        
        // Contact
        const contactCell = document.createElement('td');
        contactCell.textContent = branch.contact;
        row.appendChild(contactCell);
        
        // Address
        const addressCell = document.createElement('td');
        addressCell.textContent = branch.address;
        row.appendChild(addressCell);
        
        // Actions
        const actionsCell = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'd-flex gap-2';
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'Edit';
        editBtn.onclick = function() {
          editBranch(branch.id);
        };
        actions.appendChild(editBtn);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'Delete';
        deleteBtn.onclick = function() {
          deleteBranch(branch.id);
        };
        actions.appendChild(deleteBtn);
        
        actionsCell.appendChild(actions);
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
      });
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('branchModal'));
      modal.show();
      
      addCommand('Opened branch management', 'User');
    }
    
    function addNewBranch() {
      const name = prompt('Enter branch name:');
      if (!name) return;
      
      const manager = prompt('Enter branch manager:');
      if (!manager) return;
      
      const contact = prompt('Enter branch contact:');
      if (!contact) return;
      
      const address = prompt('Enter branch address:');
      if (!address) return;
      
      // Create new branch
      const newBranch = {
        id: Date.now().toString(),
        name,
        manager,
        contact,
        address
      };
      
      // Add branch
      branches.push(newBranch);
      
      // Save branches
      saveBranches();
      
      // Update UI
      openBranchManagement();
      updateBranchFilter();
      
      showNotification('Branch added successfully', 'success');
      addCommand(`Added new branch: ${name}`, 'User');
    }
    
    function editBranch(id) {
      const branch = branches.find(b => b.id === id);
      if (!branch) return;
      
      const name = prompt('Enter branch name:', branch.name);
      if (!name) return;
      
      const manager = prompt('Enter branch manager:', branch.manager);
      if (!manager) return;
      
      const contact = prompt('Enter branch contact:', branch.contact);
      if (!contact) return;
      
      const address = prompt('Enter branch address:', branch.address);
      if (!address) return;
      
      // Update branch
      branch.name = name;
      branch.manager = manager;
      branch.contact = contact;
      branch.address = address;
      
      // Save branches
      saveBranches();
      
      // Update UI
      openBranchManagement();
      updateBranchFilter();
      updateStats();
      updateSummarySection();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      
      showNotification('Branch updated successfully', 'success');
      addCommand(`Updated branch: ${name}`, 'User');
    }
    
    function deleteBranch(id) {
      if (settings.confirmActions && !confirm('Are you sure you want to delete this branch?')) {
        return;
      }
      
      const branch = branches.find(b => b.id === id);
      if (!branch) return;
      
      // Check if branch has tickets
      const branchTickets = tickets.filter(t => t.branch === branch.name);
      if (branchTickets.length > 0) {
        showNotification(`Cannot delete branch. It has ${branchTickets.length} associated cases.`, 'error');
        return;
      }
      
      // Delete branch
      branches = branches.filter(b => b.id !== id);
      
      // Save branches
      saveBranches();
      
      // Update UI
      openBranchManagement();
      updateBranchFilter();
      
      showNotification('Branch deleted successfully', 'success');
      addCommand(`Deleted branch: ${branch.name}`, 'User');
    }
    
    function openUserManagement() {
      // This would typically open a user management modal
      // For simplicity, we'll just show a notification
      showNotification('User management feature coming soon', 'info');
      addCommand('Attempted to open user management', 'User');
    }
    
    // ===== REPORT FUNCTIONS =====
    function generateDailyReport() {
      // Show daily summary modal
      const modal = new bootstrap.Modal(document.getElementById('dailySummaryModal'));
      modal.show();
      
      // Generate summary
      generateDailySummary();
      
      addCommand('Generated daily report', 'User');
    }
    
    function generateDailySummary() {
      const dateInput = document.getElementById('summaryDateInput').value;
      if (!dateInput) return;
      
      const selectedDate = new Date(dateInput);
      const startDate = new Date(selectedDate);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(selectedDate);
      endDate.setHours(23, 59, 59, 999);
      
      // Filter tickets for selected date
      const dayTickets = tickets.filter(t => {
        const ticketDate = new Date(t.date);
        return ticketDate >= startDate && ticketDate <= endDate;
      });
      
      // Group tickets by branch
      const branchTickets = {};
      dayTickets.forEach(ticket => {
        if (!branchTickets[ticket.branch]) {
          branchTickets[ticket.branch] = [];
        }
        branchTickets[ticket.branch].push(ticket);
      });
      
      // Generate summary content
      const content = document.getElementById('dailySummaryContent');
      content.innerHTML = '';
      
      // Summary header
      const header = document.createElement('div');
      header.className = 'mb-4';
      header.innerHTML = `
        <h4>Daily Summary for ${selectedDate.toLocaleDateString()}</h4>
        <p>Total Cases: ${dayTickets.length} | 
           Open: ${dayTickets.filter(t => t.status === 'Open').length} | 
           Closed: ${dayTickets.filter(t => t.status === 'Closed').length} | 
           Total Compensation: ${dayTickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0).toFixed(2)} AED</p>
      `;
      content.appendChild(header);
      
      // Branch summaries
      Object.keys(branchTickets).forEach(branch => {
        const branchContainer = document.createElement('div');
        branchContainer.className = 'daily-branch-item';
        
        const branchHeader = document.createElement('div');
        branchHeader.className = 'daily-branch-header';
        
        const branchName = document.createElement('div');
        branchName.className = 'daily-branch-name';
        branchName.textContent = branch;
        branchHeader.appendChild(branchName);
        
        const branchStats = document.createElement('div');
        branchStats.className = 'daily-branch-stats';
        
        const openCount = document.createElement('div');
        openCount.className = 'daily-stat';
        openCount.innerHTML = `
          <div class="daily-stat-value">${branchTickets[branch].filter(t => t.status === 'Open').length}</div>
          <div class="daily-stat-label">Open</div>
        `;
        branchStats.appendChild(openCount);
        
        const closedCount = document.createElement('div');
        closedCount.className = 'daily-stat';
        closedCount.innerHTML = `
          <div class="daily-stat-value">${branchTickets[branch].filter(t => t.status === 'Closed').length}</div>
          <div class="daily-stat-label">Closed</div>
        `;
        branchStats.appendChild(closedCount);
        
        const totalAmount = document.createElement('div');
        totalAmount.className = 'daily-stat';
        totalAmount.innerHTML = `
          <div class="daily-stat-value">${branchTickets[branch].reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0).toFixed(2)}</div>
          <div class="daily-stat-label">Amount</div>
        `;
        branchStats.appendChild(totalAmount);
        
        branchHeader.appendChild(branchStats);
        branchContainer.appendChild(branchHeader);
        
        // Branch cases
        const casesList = document.createElement('div');
        casesList.className = 'mt-2';
        
        branchTickets[branch].forEach(ticket => {
          const caseItem = document.createElement('div');
          caseItem.className = `case-item ${ticket.status === 'Closed' ? 'recovered' : 'pending'}`;
          caseItem.innerHTML = `
            <div class="case-info">
              <div class="case-order">${ticket.orderId}</div>
              <div class="case-platform">${ticket.platform}</div>
            </div>
            <div class="case-amount">${ticket.compensationAmount} AED</div>
          `;
          casesList.appendChild(caseItem);
        });
        
        branchContainer.appendChild(casesList);
        content.appendChild(branchContainer);
      });
      
      if (dayTickets.length === 0) {
        content.innerHTML = '<p class="text-center text-muted">No cases found for the selected date</p>';
      }
    }
    
    function exportDailySummary() {
      // This would typically generate a PDF or Excel report
      // For simplicity, we'll just show a notification
      showNotification('Daily summary exported successfully', 'success');
      addCommand('Exported daily summary', 'User');
    }
    
    function generateDisputeReport() {
      // Get disputed tickets (rejected or high compensation)
      const disputedTickets = tickets.filter(t => 
        t.status === 'Rejected' || parseFloat(t.compensationAmount) > 50
      );
      
      if (disputedTickets.length === 0) {
        showNotification('No disputed cases found', 'info');
        return;
      }
      
      // Create report content
      const reportContent = {
        title: 'Dispute Report',
        date: new Date().toLocaleDateString(),
        summary: {
          totalDisputes: disputedTickets.length,
          rejectedCases: disputedTickets.filter(t => t.status === 'Rejected').length,
          highCompensationCases: disputedTickets.filter(t => parseFloat(t.compensationAmount) > 50).length,
          totalAmount: disputedTickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0)
        },
        cases: disputedTickets.map(t => ({
          orderId: t.orderId,
          branch: t.branch,
          platform: t.platform,
          status: t.status,
          amount: t.compensationAmount,
          issue: t.issue,
          date: new Date(t.date).toLocaleDateString()
        }))
      };
      
      // Convert to JSON
      const reportJson = JSON.stringify(reportContent, null, 2);
      
      // Create blob and download
      const blob = new Blob([reportJson], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `dispute_report_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('Dispute report generated successfully', 'success');
      addCommand('Generated dispute report', 'User');
    }
    
    function generateFinancialReport() {
      // Create financial report
      const financialReport = {
        title: 'Financial Report',
        date: new Date().toLocaleDateString(),
        summary: {
          totalOriginalAmount: tickets.reduce((sum, t) => sum + parseFloat(t.originalAmount), 0),
          totalCompensation: tickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0),
          totalRefunded: tickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0),
          netCompensation: tickets.reduce((sum, t) => sum + (parseFloat(t.compensationAmount) - parseFloat(t.refundedAmount || 0)), 0),
          openCases: tickets.filter(t => t.status === 'Open').length,
          closedCases: tickets.filter(t => t.status === 'Closed').length,
          rejectedCases: tickets.filter(t => t.status === 'Rejected').length
        },
        branchBreakdown: {}
      };
      
      // Calculate branch breakdown
      branches.forEach(branch => {
        const branchTickets = tickets.filter(t => t.branch === branch.name);
        if (branchTickets.length > 0) {
          financialReport.branchBreakdown[branch.name] = {
            caseCount: branchTickets.length,
            originalAmount: branchTickets.reduce((sum, t) => sum + parseFloat(t.originalAmount), 0),
            compensationAmount: branchTickets.reduce((sum, t) => sum + parseFloat(t.compensationAmount), 0),
            refundedAmount: branchTickets.reduce((sum, t) => sum + parseFloat(t.refundedAmount || 0), 0),
            netCompensation: branchTickets.reduce((sum, t) => sum + (parseFloat(t.compensationAmount) - parseFloat(t.refundedAmount || 0)), 0)
          };
        }
      });
      
      // Convert to JSON
      const reportJson = JSON.stringify(financialReport, null, 2);
      
      // Create blob and download
      const blob = new Blob([reportJson], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `financial_report_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('Financial report generated successfully', 'success');
      addCommand('Generated financial report', 'User');
    }
    
    // ===== BACK TO TOP BUTTON =====
    document.getElementById('backToTop').addEventListener('click', scrollToTop);
    
    // ===== INITIALIZATION =====
    window.onload = function() {
      // Add back to top button
      const backToTopButton = document.createElement('button');
      backToTopButton.id = 'backToTop';
      backToTopButton.className = 'back-to-top';
      backToTopButton.innerHTML = '<i class="bi bi-arrow-up"></i>';
      document.body.appendChild(backToTopButton);
      
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    };
  </script>
</body>
</html>
