<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Compensation Tickets Dashboard</title>
  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --crispy-red:#d32f2f;
      --crispy-dark:#b71c1c;
      --crispy-light:#ffebee;
      --crispy-accent:#ff7043;
      --bg:#fafafa;
      --muted:#6c757d;
      --card-bg:#ffffff;
      --text-primary:#212529;
      --text-secondary:#6c757d;
      --shadow:0 4px 6px rgba(0,0,0,0.1);
      --shadow-hover:0 8px 15px rgba(0,0,0,0.2);
    }
    html,body{height:100%;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text-primary);direction:ltr;}
    .navbar{background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));box-shadow:0 2px 10px rgba(0,0,0,.12);padding:0.8rem 0;}
    .navbar .navbar-brand{color:#fff;font-weight:700;font-size:1.3rem;}
    .container-page{max-width:1400px;margin:20px auto;padding:0 20px;}
    .card-ghost{background:var(--card-bg);border-radius:16px;padding:24px;box-shadow:var(--shadow);transition:all 0.3s ease;border:1px solid rgba(0,0,0,0.05);}
    .card-ghost:hover{box-shadow:var(--shadow-hover);transform:translateY(-2px);}
    
    /* Enhanced Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:30px;}
    .stat-card{padding:24px;border-radius:16px;background:linear-gradient(135deg,rgba(211,47,47,0.05),rgba(211,47,47,0.1));border-left:6px solid var(--crispy-red);box-shadow:var(--shadow);transition:all 0.3s ease;}
    .stat-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);}
    .stat-card h2{font-size:2.5rem;font-weight:700;margin:10px 0;color:var(--crispy-red);}
    .stat-card .text-muted{font-size:0.95rem;font-weight:500;letter-spacing:0.5px;}
    
    /* Enhanced Platform Cards */
    .platform-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-bottom:30px;}
    .platform-card{padding:30px;border-radius:16px;background:linear-gradient(135deg,rgba(255,112,67,0.05),rgba(255,112,67,0.1));text-align:center;box-shadow:var(--shadow);transition:all 0.3s ease;border:1px solid rgba(255,112,67,0.1);}
    .platform-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);}
    .platform-card h3{font-size:2.2rem;font-weight:700;margin:15px 0;color:var(--crispy-accent);}
    .platform-card .percentage{font-size:1.4rem;font-weight:600;color:var(--crispy-accent);margin-top:8px;}
    
    /* Enhanced Reports Section */
    #reports{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:30px;}
    .report-card{padding:24px;border-radius:16px;background:var(--card-bg);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .report-card h5{font-size:1.3rem;font-weight:700;margin-bottom:20px;color:var(--text-primary);}
    .report-card .chart-container{position:relative;height:220px;}
    
    /* Enhanced Case Analysis */
    .case-analysis-section{background:var(--card-bg);border-radius:16px;padding:30px;margin-bottom:30px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .case-analysis-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .case-analysis-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .case-badge{padding:8px 16px;border-radius:24px;font-size:0.9rem;font-weight:600;}
    .badge-high{background:var(--crispy-light);color:var(--crispy-red);}
    .badge-medium{background:#fff3e0;color:#ef6c00;}
    .badge-low{background:#e8f5e9;color:#2e7d32;}
    
    .branch-analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:24px;}
    .branch-card{background:#f8f9fa;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .branch-card h6{font-size:1.1rem;font-weight:700;margin-bottom:15px;color:var(--crispy-dark);}
    .branch-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
    .branch-stat-item{text-align:center;padding:12px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .branch-stat-value{font-size:1.3rem;font-weight:700;color:var(--crispy-red);margin-bottom:4px;}
    .branch-stat-label{font-size:0.8rem;color:var(--text-secondary);font-weight:500;}
    
    .case-reasons{margin-top:20px;}
    .case-reasons h6{font-size:1rem;font-weight:600;margin-bottom:12px;color:var(--text-primary);}
    .case-reason-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.05);}
    .case-reason-item:last-child{border-bottom:none;}
    .case-reason-info{display:flex;flex-direction:column;align-items:flex-end;}
    .case-reason-name{font-size:0.95rem;font-weight:500;margin-bottom:4px;}
    .case-reason-count{font-size:0.85rem;color:var(--text-secondary);}
    .case-reason-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;margin-top:6px;overflow:hidden;}
    .case-reason-progress{height:100%;background:var(--crispy-red);border-radius:4px;}
    
    /* Compensation Analysis Section */
    .compensation-analysis-section{background:var(--card-bg);border-radius:16px;padding:30px;margin-bottom:30px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .compensation-analysis-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .compensation-analysis-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .compensation-analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;}
    .compensation-card{background:#f8f9fa;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .compensation-card h6{font-size:1.1rem;font-weight:700;margin-bottom:15px;color:var(--crispy-dark);}
    .compensation-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
    .stat-item{text-align:center;padding:16px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .stat-value{font-size:1.3rem;font-weight:700;color:var(--crispy-red);margin-bottom:4px;}
    .stat-label{font-size:0.85rem;color:var(--text-secondary);font-weight:500;}
    
    /* Rejection Analysis Section */
    .rejection-analysis-section{background:var(--card-bg);border-radius:16px;padding:30px;margin-bottom:30px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .rejection-analysis-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .rejection-analysis-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .rejection-analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;}
    .rejection-card{background:#f8f9fa;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .rejection-card h6{font-size:1.1rem;font-weight:700;margin-bottom:15px;color:var(--crispy-dark);}
    .rejection-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
    .rejection-metric-item{text-align:center;padding:16px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .rejection-metric-value{font-size:1.3rem;font-weight:700;color:#dc3545;margin-bottom:4px;}
    .rejection-metric-label{font-size:0.85rem;color:var(--text-secondary);font-weight:500;}
    
    /* Refund Analysis Section */
    .refund-analysis-section{background:var(--card-bg);border-radius:16px;padding:30px;margin-bottom:30px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .refund-analysis-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .refund-analysis-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .refund-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:25px;}
    .refund-card{background:#f8f9fa;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .refund-card h6{font-size:1.1rem;font-weight:700;margin-bottom:15px;color:var(--crispy-dark);}
    .refund-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
    .refund-metric-item{text-align:center;padding:16px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .refund-metric-value{font-size:1.3rem;font-weight:700;color:var(--crispy-red);margin-bottom:4px;}
    .refund-metric-label{font-size:0.85rem;color:var(--text-secondary);font-weight:500;}
    .refund-chart-container{height:200px;margin-top:20px;}
    .refund-table-container{margin-top:20px;max-height:300px;overflow-y:auto;}
    .refund-table{width:100%;border-collapse:collapse;}
    .refund-table th{background:#f1f3f5;padding:12px;text-align:left;font-weight:600;font-size:0.9rem;}
    .refund-table td{padding:12px;border-bottom:1px solid #eee;}
    .refund-table tr:hover{background:#f8f9fa;}
    .refund-status-badge{padding:4px 8px;border-radius:12px;font-size:0.8rem;font-weight:600;}
    .status-refunded{background:#d4edda;color:#155724;}
    
    /* Enhanced Tickets Section */
    .tickets-section{background:var(--card-bg);border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:30px;border:1px solid rgba(0,0,0,0.05);}
    .tickets-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
    .tickets-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .tickets-header .filters{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    .tickets-header .search-input{min-width:200px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);padding:8px 12px;font-size:0.95rem;}
    .tickets-header .filter-select{min-width:160px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);font-size:0.95rem;}
    .tickets-header .action-buttons{display:flex;gap:8px;}
    .tickets-header .btn{border-radius:8px;font-weight:600;padding:8px 16px;}
    
    /* Enhanced Table */
    .tickets-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .tickets-table th{background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));color:white;font-weight:600;padding:16px;text-align:left;position:sticky;top:0;z-index:10;}
    .tickets-table td{padding:16px;border-bottom:1px solid #eee;transition:background-color 0.2s;}
    .tickets-table tr:hover td{background-color:#f8f9fa;}
    .ticket-order-id{font-weight:700;font-size:1.1rem;color:var(--crispy-dark);}
    .ticket-issue{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle;}
    .issue-expand{background:none;border:none;color:#0d6efd;text-decoration:underline;font-size:0.9rem;cursor:pointer;padding-left:8px;}
    .ticket-actions{display:flex;flex-wrap:wrap;gap:4px;}
    .ticket-actions .btn{padding:4px 8px;font-size:0.8rem;border-radius:6px;}
    
    /* Status badges */
    .status-badge{padding:6px 12px;border-radius:20px;font-weight:600;font-size:0.85rem;display:inline-flex;align-items:center;gap:6px;}
    .status-open{background-color:#e3f2fd;color:#1976d2;}
    .status-sent{background-color:#fff3e0;color:#f57c00;}
    .status-closed{background-color:#e8f5e9;color:#388e3c;}
    .status-rejected{background-color:#ffebee;color:#d32f2f;}
    
    /* High compensation highlight */
    .high-compensation{background-color:rgba(255,235,238,0.5) !important;}
    .highlight-row{animation:highlight 2s ease;}
    @keyframes highlight{0%{background-color:rgba(255,235,238,0.5);}100%{background-color:transparent;}}
    
    /* Refunded highlight */
    .refunded-case{background-color:rgba(220,242,220,0.5) !important;}
    
    /* Rejected highlight */
    .rejected-case{background-color:rgba(255,236,236,0.5) !important;}
    
    /* Enhanced Modal */
    .modal-content{border-radius:16px;border:none;box-shadow:0 10px 30px rgba(0,0,0,0.15);}
    .modal-header{background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));color:#fff;border-radius:16px 16px 0 0;padding:20px 24px;}
    .modal-header .modal-title{font-weight:700;font-size:1.3rem;}
    .modal-body{padding:24px;}
    .form-label{font-weight:600;font-size:0.95rem;margin-bottom:8px;color:var(--text-primary);display:flex;align-items:center;gap:8px;}
    .form-label .required{color:var(--crispy-red);font-size:1.2rem;}
    .form-control,.form-select{border-radius:8px;border:1px solid rgba(0,0,0,0.1);padding:10px 14px;font-size:0.95rem;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .form-control:focus,.form-select:focus{border-color:var(--crispy-red);box-shadow:0 0 0 0.2rem rgba(211,47,47,0.15);transform:translateY(-2px);}
    .form-check-label{font-size:0.9rem;}
    .modal-footer{display:flex;justify-content:flex-end;gap:12px;padding:20px 24px;}
    .modal-footer .btn{border-radius:8px;font-weight:600;padding:10px 20px;}
    
    /* Image upload styling */
    .image-upload-container{border:2px dashed #ddd;border-radius:8px;padding:20px;text-align:center;margin-bottom:16px;position:relative;}
    .image-upload-container:hover{border-color:var(--crispy-red);background-color:#fafafa;}
    .image-upload-container input[type="file"]{display:none;}
    .image-preview{max-width:100%;max-height:200px;margin-top:10px;border-radius:8px;}
    .short-link-container{margin-top:16px;}
    .short-link-input{width:100%;border-radius:8px;border:1px solid #ddd;padding:8px 12px;font-size:0.95rem;}
    .short-link-button{position:absolute;right:20px;top:50%;transform:translateY(-50%);background:var(--crispy-red);color:white;border:none;border-radius:6px;padding:6px 12px;font-size:0.9rem;cursor:pointer;}
    
    /* Enhanced Dock */
    #dock{position:fixed;right:24px;bottom:24px;z-index:2000;display:flex;flex-direction:column;gap:12px;align-items:flex-end;}
    .dock-toggle{width:56px;height:56px;border-radius:50%;background:var(--crispy-red);color:#fff;border:none;box-shadow:0 8px 26px rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;}
    .dock-toggle:hover{transform:scale(1.1);box-shadow:0 10px 30px rgba(0,0,0,0.25);}
    .dock-panel{display:none;flex-direction:column;gap:10px;padding:12px;background:var(--card-bg);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.15);width:200px;}
    .dock-panel.show{display:flex;animation:slideUp 0.3s ease-out;}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .dock-panel button{min-width:180px;font-weight:600;border-radius:10px;padding:10px 16px;font-size:0.95rem;transition:all 0.2s;}
    .dock-panel button:hover{transform:translateX(-4px);}
    
    /* Enhanced Notifications */
    .toast-container{position:fixed;top:20px;right:20px;z-index:1050;}
    .toast{background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);margin-bottom:10px;overflow:hidden;animation:slideIn 0.3s ease-out;}
    .toast-header{background:var(--crispy-red);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
    .toast-body{padding:16px;}
    .toast-success .toast-header{background:#28a745;}
    .toast-error .toast-header{background:#dc3545;}
    .toast-warning .toast-header{background:#ffc107;color:#212529;}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    
    /* Summary Section */
    .summary-section{background:var(--card-bg);border-radius:16px;padding:30px;margin-bottom:30px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.05);}
    .summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
    .summary-header h5{font-size:1.4rem;font-weight:700;margin:0;color:var(--text-primary);}
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;}
    .summary-card{background:#f8f9fa;border-radius:12px;padding:20px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .summary-card h6{font-size:1.1rem;font-weight:700;margin-bottom:15px;color:var(--crispy-dark);}
    .summary-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px;}
    .metric-item{text-align:center;padding:16px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .metric-value{font-size:1.5rem;font-weight:700;color:var(--crispy-red);margin-bottom:4px;}
    .metric-label{font-size:0.85rem;color:var(--text-secondary);font-weight:500;}
    .metric-change{font-size:0.8rem;font-weight:600;margin-top:4px;}
    .metric-change.positive{color:#198754;}
    .metric-change.negative{color:#dc3545;}
    .metric-change.neutral{color:#6c757d;}
    .chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;}
    .mini-chart{height:150px;}
    
    /* Daily Branch Summary Modal */
    .daily-summary-modal .modal-body{max-height:70vh;overflow-y:auto;}
    .daily-branch-item{border-bottom:1px solid #eee;padding:12px 0;}
    .daily-branch-item:last-child{border-bottom:none;}
    .daily-branch-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .daily-branch-name{font-weight:600;}
    .daily-branch-stats{display:flex;gap:16px;}
    .daily-stat{text-align:center;}
    .daily-stat-value{font-weight:700;font-size:1.1rem;}
    .daily-stat-label{font-size:0.85rem;color:var(--text-secondary);}
    
    /* Commands Section Styles */
    .commands-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .commands-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    /* Fixed Commands Window (Right Side) */
    .commands-window {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 320px;
      background: linear-gradient(135deg, rgba(211,47,47,0.95), rgba(183,28,28,0.95));
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 26px rgba(0,0,0,0.3);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 180px;
      overflow: hidden;
    }
    
    .commands-window:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
    }
    
    .commands-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .commands-header h6 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
    }
    
    .commands-list {
      padding: 10px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .commands-list .command-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .commands-list .command-item:last-child {
      margin-bottom: 0;
    }
    
    .commands-list .command-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 4px;
    }
    
    /* All Commands Container */
    .all-commands-container {
      margin-top: 180px;
      margin-right: 340px; /* Space for fixed window */
    }
    
    .all-commands-container h6 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--crispy-dark);
    }
    
    .all-commands-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 8px;
      padding: 12px;
      background: #f8f9fa;
    }
    
    .all-commands-list .command-item {
      padding: 12px;
      margin-bottom: 12px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-left: 3px solid var(--crispy-red);
    }
    
    .all-commands-list .command-item:last-child {
      margin-bottom: 0;
    }
    
    .all-commands-list .command-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .all-commands-list .command-title {
      font-weight: 600;
      color: var(--crispy-dark);
    }
    
    .all-commands-list .command-time {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .all-commands-list .command-details {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    /* Scrollbar styling */
    .commands-list::-webkit-scrollbar,
    .all-commands-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .commands-list::-webkit-scrollbar-track,
    .all-commands-list::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    
    .commands-list::-webkit-scrollbar-thumb,
    .all-commands-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
    }
    
    .commands-list::-webkit-scrollbar-thumb:hover,
    .all-commands-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }
    
    /* Storage Indicator */
    .storage-indicator {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .storage-warning {
      background: rgba(220, 53, 69, 0.9) !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Duplicate warning */
    .duplicate-warning {
      font-size: 0.85rem;
      display: none;
    }
    
    .duplicate-warning.show {
      display: block;
    }
    
    /* Input icon styling */
    .input-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--crispy-red);
      pointer-events: none;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    /* Print styles */
    @media print{
      #dock, .tickets-header .btn, .action-buttons, .navbar, .modal, .notification, .commands-window, .storage-indicator { display:none !important; }
      body{background:#fff}
      .card-ghost{box-shadow:none;border:1px solid #ddd;}
    }
    
    /* Responsive styles */
    @media (max-width: 1200px){
      .container-page{max-width:100%;padding:0 16px;}
    }
    @media (max-width: 992px){
      #reports{grid-template-columns:1fr;}
      .branch-analysis-grid{grid-template-columns:1fr;}
      .branch-stats{grid-template-columns:repeat(2,1fr);}
      .summary-grid{grid-template-columns:1fr;}
      .chart-row{grid-template-columns:1fr;}
      .refund-grid{grid-template-columns:1fr;}
      .compensation-analysis-grid{grid-template-columns:1fr;}
      .rejection-analysis-grid{grid-template-columns:1fr;}
      .all-commands-container { 
        margin-top: 160px;
        margin-right: 0;
      }
    }
    @media (max-width: 768px){
      .stats-grid{grid-template-columns:1fr;}
      .platform-cards{grid-template-columns:1fr;}
      .tickets-header .filters{flex-direction:column;align-items:stretch;}
      .tickets-header .search-input,.tickets-header .filter-select{min-width:100%;}
      .tickets-header .action-buttons{justify-content:stretch;}
      .tickets-header .action-buttons .btn{flex:1;}
      .tickets-table{font-size:0.85rem;}
      .ticket-actions{justify-content:center;}
      #dock{right:16px;bottom:16px;}
      .dock-panel{width:180px;}
      .dock-panel button{min-width:160px;font-size:0.9rem;}
      .commands-window {
        width: 280px;
        right: 16px;
        bottom: 16px;
      }
      .all-commands-container { 
        margin-top: 140px;
        margin-right: 0;
      }
    }
    @media (max-width: 576px){
      .container-page{padding:0 12px;}
      .card-ghost{padding:16px;}
      .stat-card h2{font-size:2rem;}
      .platform-card h3{font-size:1.8rem;}
      .report-card{padding:16px;}
      .tickets-table th,.tickets-table td{padding:10px 8px;}
      .ticket-issue{max-width:150px;}
      .all-commands-container { 
        margin-top: 120px;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Heatmap container -->
  <div id="heatmapContainer"></div>
  
  <!-- Storage Indicator -->
  <div id="storageIndicator" class="storage-indicator">0% storage used</div>
  
  <!-- Enhanced Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container container-page">
      <a class="navbar-brand" href="#"><i class="bi bi-fire-fill me-2" style="font-size:1.6rem"></i> Crispy Chicken — Compensation Tickets</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-white fw-semibold" href="#">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <main class="container-page">
    <!-- Enhanced Stats Section -->
    <section class="stats-grid">
      <div class="stat-card text-center">
        <div class="text-muted">Total Cases</div>
        <h2 id="totalTickets">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#0d6efd;">
        <div class="text-muted">Open</div>
        <h2 id="openTickets" style="color:#0d6efd;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#ffc107;">
        <div class="text-muted">Sent</div>
        <h2 id="sentTickets" style="color:#ffc107;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#198754;">
        <div class="text-muted">Closed</div>
        <h2 id="closedTickets" style="color:#198754;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#28a745;">
        <div class="text-muted">Resolved Disputes</div>
        <h2 id="resolvedDisputes" style="color:#28a745;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#17a2b8;">
        <div class="text-muted">Active Compensations</div>
        <h2 id="activeCompensations" style="color:#17a2b8;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Total Compensation</div>
        <h2 id="totalCompensationAmount" style="color:#dc3545;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Rejected</div>
        <h2 id="rejectedTickets" style="color:#dc3545;">0</h2>
      </div>
    </section>
    
    <!-- Summary Section -->
    <section class="summary-section">
      <div class="summary-header">
        <h5>Dashboard Summary</h5>
        <div class="text-muted">
          <i class="bi bi-calendar3 me-1"></i>
          <span id="summaryDate"></span>
        </div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <h6>Financial Overview</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="totalOriginalAmount">0</div>
              <div class="metric-label">Total Original Amount</div>
              <div class="metric-change" id="originalAmountChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalCompensation">0</div>
              <div class="metric-label">Total Compensation</div>
              <div class="metric-change" id="compensationChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalRefunded">0</div>
              <div class="metric-label">Total Refunded</div>
              <div class="metric-change" id="refundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="netCompensation">0</div>
              <div class="metric-label">Net Compensation</div>
              <div class="metric-change" id="netCompensationChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="amountChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Platform Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="noonTickets">0</div>
              <div class="metric-label">Noon Cases</div>
              <div class="metric-change" id="noonTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemTickets">0</div>
              <div class="metric-label">Careem Cases</div>
              <div class="metric-change" id="careemTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="noonRefunded">0</div>
              <div class="metric-label">Noon Refunded</div>
              <div class="metric-change" id="noonRefundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemRefunded">0</div>
              <div class="metric-label">Careem Refunded</div>
              <div class="metric-change" id="careemRefundedChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="platformTicketsChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="platformCompensationChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Branch Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="topBranch">-</div>
              <div class="metric-label">Top Branch</div>
              <div class="metric-change" id="topBranchCases">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="topCase">-</div>
              <div class="metric-label">Top Case</div>
              <div class="metric-change" id="topCaseCount">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="caseRate">0%</div>
              <div class="metric-label">Case Rate</div>
              <div class="metric-change" id="caseRateChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="avgOriginalAmount">0</div>
              <div class="metric-label">Avg. Original Amount</div>
              <div class="metric-change" id="avgOriginalAmountChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="branchCasesChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="caseTypesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Platform Cards -->
    <section class="platform-cards">
      <div class="platform-card">
        <div class="text-muted">Noon Cases</div>
        <h3 id="noonCount">0</h3>
        <div class="percentage" id="noonPercentage">0%</div>
      </div>
      <div class="platform-card">
        <div class="text-muted">Careem Cases</div>
        <h3 id="careemCount">0</h3>
        <div class="percentage" id="careemPercentage">0%</div>
      </div>
    </section>
    
    <!-- Enhanced Reports Section -->
    <section id="reports">
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Top Branches by Cases</h5>
          <small class="text-muted" id="topBranchLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="branchChart"></canvas>
        </div>
      </div>
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Case Types Breakdown</h5>
          <small class="text-muted" id="topCaseLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="caseChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Case Analysis Section -->
    <section class="case-analysis-section">
      <div class="case-analysis-header">
        <h5>Case Analysis Causing Compensation</h5>
        <div id="caseAnalysisBadge" class="case-badge badge-high">High Level</div>
      </div>
      <div id="branchAnalysisContainer"></div>
    </section>
    
    <!-- Compensation Analysis Section -->
    <section class="compensation-analysis-section">
      <div class="compensation-analysis-header">
        <h5>Compensation Analysis by Type</h5>
        <div class="text-muted">
          <i class="bi bi-bar-chart me-1"></i>
          Breakdown of compensation cases
        </div>
      </div>
      <div id="compensationAnalysisContainer"></div>
    </section>
    
    <!-- Rejection Analysis Section -->
    <section class="rejection-analysis-section">
      <div class="rejection-analysis-header">
        <h5>Rejection Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-x-circle me-1"></i>
          Analysis of rejected compensation cases
        </div>
      </div>
      <div id="rejectionAnalysisContainer"></div>
    </section>
    
    <!-- Refund Analysis Section -->
    <section class="refund-analysis-section">
      <div class="refund-analysis-header">
        <h5>Refund Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-arrow-repeat me-1"></i>
          Refunded Compensation Tracking
        </div>
      </div>
      <div class="refund-grid">
        <div class="refund-card">
          <h6>Overall Refunds</h6>
          <div class="refund-metrics">
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="totalRefundedAmount">0</div>
              <div class="refund-metric-label">Total Refunded Amount</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundedCasesCount">0</div>
              <div class="refund-metric-label">Refunded Cases</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundRate">0%</div>
              <div class="refund-metric-label">Refund Rate</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="avgRefundedAmount">0</div>
              <div class="refund-metric-label">Avg. Refunded Amount</div>
            </div>
          </div>
        </div>
        
        <div class="refund-card">
          <h6>Refunds by Branch</h6>
          <div class="refund-chart-container">
            <canvas id="refundBranchChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="refund-table-container">
        <table class="refund-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Branch</th>
              <th>Original Amount</th>
              <th>Compensation</th>
              <th>Refunded Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="refundTableBody">
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- Enhanced Tickets Section -->
    <section class="tickets-section">
      <div class="tickets-header">
        <h5>Compensation Cases</h5>
        <div class="filters">
          <input id="searchInput" class="form-control search-input" placeholder="Search case / branch / issue" />
          <select id="filterBranch" class="form-select filter-select">
            <option value="">All Branches</option>
          </select>
          <select id="filterPlatform" class="form-select filter-select">
            <option value="">All Platforms</option>
            <option>Noon</option>
            <option>Careem</option>
          </select>
          <select id="filterStatus" class="form-select filter-select">
            <option value="">All Status</option>
            <option>Open</option>
            <option>Sent</option>
            <option>Closed</option>
            <option>Rejected</option>
          </select>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle me-1"></i> Add
            </button>
            <button class="btn btn-outline-secondary" onclick="addSample()">
              <i class="bi bi-flask me-1"></i> Sample
            </button>
          </div>
        </div>
      </div>
      <div id="ticketsContainer"></div>
    </section>
    
    <!-- Commands Section -->
    <section class="commands-section">
      <div class="commands-container">
        <!-- Fixed Commands Window (Last 3 commands) -->
        <div id="commandsWindow" class="commands-window">
          <div class="commands-header">
            <h6><i class="bi bi-terminal me-1"></i> Last Commands</h6>
            <button class="btn btn-sm btn-outline-light" onclick="clearCommands()">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div id="commandsList" class="commands-list">
            <!-- Last 3 commands will be shown here -->
          </div>
        </div>
        
        <!-- Scrollable All Commands -->
        <div class="all-commands-container">
          <h6><i class="bi bi-list-ul me-1"></i> All Commands</h6>
          <div id="allCommandsList" class="all-commands-list">
            <!-- All commands will be shown here -->
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Enhanced Modal -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Compensation Case</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="ticketForm">
            <input type="hidden" id="editingId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
                  Order ID
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <input id="f_orderId" class="form-control" placeholder="مثل: CR12345" required>
                  <i class="bi bi-barcode input-icon"></i>
                </div>
                <div id="duplicateWarning" class="duplicate-warning text-danger mt-1"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  Order Date & Time
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <input id="f_orderDate" type="datetime-local" class="form-control" required>
                  <i class="bi bi-calendar3 input-icon"></i>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  Branch
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <select id="f_branch" class="form-select" required>
                    <option value="">اختر الفرع</option>
                  </select>
                  <i class="bi bi-building input-icon"></i>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  Platform
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <select id="f_platform" class="form-select" required>
                    <option value="">اختر المنصة</option>
                    <option>Noon</option>
                    <option>Careem</option>
                  </select>
                  <i class="bi bi-globe input-icon"></i>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">
                  Case Description
                  <span class="required">*</span>
                </label>
                <textarea id="f_issue" class="form-control autogrow" required></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  Original Amount (AED)
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <input id="f_originalAmount" type="number" min="0" step="0.01" class="form-control" required>
                  <i class="bi bi-currency-exchange input-icon"></i>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">
                  Compensation (AED)
                  <span class="required">*</span>
                </label>
                <div class="input-with-icon">
                  <input id="f_compensation" type="number" min="0" step="0.01" class="form-control" required>
                  <i class="bi bi-cash-stack input-icon"></i>
                </div>
              </div>
              
              <!-- Refund Section -->
              <div class="col-md-6">
                <label class="form-label">Refunded Amount (AED)</label>
                <div class="input-with-icon">
                  <input id="f_refundedAmount" type="number" min="0" step="0.01" class="form-control" value="0">
                  <i class="bi bi-arrow-return-left input-icon"></i>
                </div>
                <div class="form-check mt-2">
                  <input id="f_isRefunded" type="checkbox" class="form-check-input">
                  <label class="form-check-label" for="f_isRefunded">Mark as refunded</label>
                </div>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Refund Date</label>
                <div class="input-with-icon">
                  <input id="f_refundDate" type="date" class="form-control">
                  <i class="bi bi-calendar-check input-icon"></i>
                </div>
              </div>
              
              <!-- Evidence Section -->
              <div class="col-12">
                <label class="form-label">Evidence</label>
                <div class="image-upload-container" onclick="document.getElementById('f_evidenceImage').click()">
                  <i class="bi bi-cloud-upload" style="font-size:2rem;color:#ccc"></i>
                  <p class="mb-0 mt-2">Click to upload image</p>
                  <input type="file" id="f_evidenceImage" accept="image/*" onchange="handleImageUpload(event)">
                  <img id="imagePreview" class="image-preview" style="display:none">
                </div>
                
                <div class="short-link-container">
                  <label class="form-label">Short Link</label>
                  <div style="position:relative;">
                    <input id="f_shortLink" type="text" class="form-control short-link-input" placeholder="Click 'Generate' to create short link" readonly>
                    <button type="button" class="short-link-button" onclick="generateShortLink()">
                      <i class="bi bi-link-45deg"></i> Generate
                    </button>
                  </div>
                </div>
                
                <div class="form-check mt-2">
                  <input id="f_noEvidence" type="checkbox" class="form-check-input">
                  <label class="form-check-label" for="f_noEvidence">No evidence</label>
                </div>
              </div>
              
              <div class="col-12 mt-3 d-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-danger">Save</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Issue Modal -->
  <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Case Details</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="issueText" style="white-space:pre-wrap;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Daily Branch Summary Modal -->
  <div class="modal fade" id="dailySummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Daily Branch Summary</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body daily-summary-modal">
          <div id="dailySummaryContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="exportDailySummary()">Export Summary</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Storage Cleanup Modal -->
  <div class="modal fade" id="cleanupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Storage Cleanup</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Your browser storage is almost full. Please choose a cleanup option:</p>
          <div class="d-grid gap-2">
            <button class="btn btn-warning" onclick="cleanBase64Images(); bootstrap.Modal.getInstance(document.getElementById('cleanupModal')).hide();">
              <i class="bi bi-image me-2"></i>Remove All Images
            </button>
            <button class="btn btn-danger" onclick="removeOldCases(); bootstrap.Modal.getInstance(document.getElementById('cleanupModal')).hide();">
              <i class="bi bi-trash me-2"></i>Remove Cases Older Than 3 Months
            </button>
            <button class="btn btn-outline-secondary" onclick="resetAll(); bootstrap.Modal.getInstance(document.getElementById('cleanupModal')).hide();">
              <i class="bi bi-arrow-clockwise me-2"></i>Reset All Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rejection Modal -->
  <div class="modal fade" id="rejectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">رفض تعويض</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="rejectionForm">
            <div class="mb-3">
              <label class="form-label">اختر الحالة</label>
              <select id="rejectionCase" class="form-select" required>
                <option value="">اختر حالة</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">سبب الرفض</label>
              <select id="rejectionReason" class="form-select" required>
                <option value="">اختر السبب</option>
                <option value="no_evidence">لا يوجد دليل</option>
                <option value="incorrect_claim">الادعاء غير صحيح</option>
                <option value="driver_fault">خطأ السائق</option>
                <option value="customer_error">خطأ العميل</option>
                <option value="other">أسباب أخرى</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">ملاحظات إضافية</label>
              <textarea id="rejectionNotes" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input id="sendEmail" type="checkbox" class="form-check-input" checked>
                <label class="form-check-label" for="sendEmail">إرسال بريد إلكتروني</label>
              </div>
              <div class="form-check">
                <input id="sendWhatsApp" type="checkbox" class="form-check-input">
                <label class="form-check-label" for="sendWhatsApp">إرسال عبر واتساب</label>
              </div>
            </div>
            
            <div class="d-flex justify-content-end gap-2">
              <button type="submit" class="btn btn-danger">رفض التعويض</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- Enhanced Dock -->
  <div id="dock" title="Drag me">
    <div id="dockPanel" class="dock-panel" role="toolbar" aria-hidden="true">
      <button class="btn btn-danger" onclick="openAddModal()" title="New Case">
        <i class="bi bi-plus-circle me-1"></i> New Case
      </button>
      <button class="btn btn-outline-primary" onclick="addSample()" title="Add sample cases">
        <i class="bi bi-flask me-1"></i> Add Sample
      </button>
      <button class="btn btn-outline-secondary" onclick="showDailySummary()" title="Daily branch summary">
        <i class="bi bi-calendar-day me-1"></i> Daily Summary
      </button>
      <button class="btn btn-outline-danger" onclick="openRejectionModal()" title="Reject compensation">
        <i class="bi bi-x-circle me-1"></i> رفض تعويض
      </button>
      <button class="btn btn-outline-secondary" onclick="resetAll()" title="Reset all data">
        <i class="bi bi-arrow-clockwise me-1"></i> Reset
      </button>
      <button class="btn btn-outline-dark" onclick="printReport()" title="Print report">
        <i class="bi bi-printer me-1"></i> Print
      </button>
      <button class="btn btn-success" onclick="exportExcel()" title="Export Excel (XLSX)">
        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Export Excel
      </button>
      <button class="btn btn-warning" onclick="exportPDF()" title="Export PDF">
        <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
      </button>
      <button class="btn btn-primary" onclick="exportDashboardSummary()" title="Dashboard Summary PDF">
        <i class="bi bi-file-text me-1"></i> Dashboard PDF
      </button>
      <button id="heatmapToggleBtn" class="btn btn-outline-danger" onclick="toggleHeatmap()" title="Toggle Heatmap">
        <i class="bi bi-activity me-1"></i> Heatmap
      </button>
      <button class="btn btn-outline-secondary" onclick="exportUsabilityLog()" title="Export user interactions">
        <i class="bi bi-box-arrow-up-right me-1"></i> Export Log
      </button>
      <button class="btn btn-outline-info" onclick="clearCommands()" title="Clear commands">
        <i class="bi bi-trash me-1"></i> Clear Commands
      </button>
      <button class="btn btn-outline-info" onclick="showStorageInfo()" title="Storage Info">
        <i class="bi bi-hdd me-1"></i> Storage
      </button>
    </div>
    <button id="dockToggle" class="dock-toggle" title="Open actions">
      <i class="bi bi-gear-fill"></i>
    </button>
  </div>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.js"></script>
  <script>
  // ===== State & initial data =====
  let tickets = JSON.parse(localStorage.getItem('crispyTickets')) || [];
  const branchWhats = {
    "Crispy Chicken Khalidiya":"971569494764",
    "Crispy Chicken Muroor":"971505414641",
    "Crispy Chicken Shabiya 11":"971562690688",
    "Crispy Chicken Al Barsha":"971569659524",
    "Crispy Chicken Al Satwa":"971567970685",
    "Crispy Chicken Electra":"971563866859",
    "Crispy Chicken Hamdan":"971556886650",
    "Crispy Chicken-Al Khalidiya":"971569494764"
  };
  const branchesList = Object.keys(branchWhats);
  
  // ===== DOM refs =====
  const ticketsContainer = document.getElementById('ticketsContainer');
  const searchInput = document.getElementById('searchInput');
  const filterBranch = document.getElementById('filterBranch');
  const filterPlatform = document.getElementById('filterPlatform');
  const filterStatus = document.getElementById('filterStatus');
  const toastContainer = document.getElementById('toastContainer');
  const dockToggle = document.getElementById('dockToggle');
  const dockPanel = document.getElementById('dockPanel');
  const dock = document.getElementById('dock');
  const heatmapContainer = document.getElementById('heatmapContainer');
  
  // Charts
  let branchChart = null, caseChart = null;
  let amountChart = null, statusChart = null;
  let platformTicketsChart = null, platformCompensationChart = null;
  let branchCasesChart = null, caseTypesChart = null;
  let refundBranchChart = null;
  
  // Heatmap
  let heatmapInstance = null;
  let heatmapVisible = false;
  const interactions = [];
  
  // Commands tracking
  let commands = [];
  const MAX_COMMANDS_VISIBLE = 3;
  
  // ===== WhatsApp Notification Function =====
  function notifyBranch(ticket) {
    const branchNumber = branchWhats[ticket.branch];
    if (!branchNumber) {
      console.warn(`WhatsApp number not found for branch: ${ticket.branch}`);
      return;
    }
    
    const message = `🔔 إشعار حالة جديدة 🔔

معرف الطلب: ${ticket.orderId}
الفرع: ${ticket.branch}
المنصة: ${ticket.platform}
الوصف: ${ticket.issue}
المبلغ الأصلي: ${ticket.originalAmount} درهم
التعويض: ${ticket.compensation} درهم
التاريخ: ${new Date().toLocaleDateString('ar-SA')}

يرجى مراجعة الحالة وتأكيد التعامل معها`;

    // Open WhatsApp with pre-filled message
    window.open(`https://wa.me/${branchNumber}?text=${encodeURIComponent(message)}`, '_blank');
  }
  
  // ===== Toast Notification Function =====
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-header">
        <i class="bi bi-${getToastIcon(type)} me-2"></i>
        <strong class="me-auto">${getToastTitle(type)}</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
      autohide: true,
      delay: 5000
    });
    
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }
  
  function getToastIcon(type) {
    const icons = {
      success: 'check-circle',
      error: 'exclamation-triangle',
      warning: 'exclamation-triangle',
      info: 'info-circle'
    };
    return icons[type] || 'info-circle';
  }
  
  function getToastTitle(type) {
    const titles = {
      success: 'نجاح',
      error: 'خطأ',
      warning: 'تحذير',
      info: 'معلومات'
    };
    return titles[type] || 'معلومات';
  }
  
  // ===== Form Validation Function =====
  function validateForm() {
    const orderId = document.getElementById('f_orderId').value.trim();
    const orderDate = document.getElementById('f_orderDate').value;
    const branch = document.getElementById('f_branch').value;
    const platform = document.getElementById('f_platform').value;
    const issue = document.getElementById('f_issue').value.trim();
    
    // Check required fields
    if (!orderId || !orderDate || !branch || !platform || !issue) {
      showToast('جميع الحقول المطلوبة يجب ملؤها', 'error');
      return false;
    }
    
    // Check order ID format
    if (!isValidOrderId(orderId)) {
      showToast('معرف الطلب يجب أن يكون على الشكل CR12345 أو ORD12345', 'error');
      return false;
    }
    
    // Check for duplicates
    const isDuplicate = checkDuplicateOrder(orderId, platform);
    if (isDuplicate) {
      showToast('معرف الطلب موجود مسبقاً لهذه المنصة', 'error');
      return false;
    }
    
    // Check amounts
    const originalAmount = parseFloat(document.getElementById('f_originalAmount').value);
    const compensation = parseFloat(document.getElementById('f_compensation').value);
    
    if (originalAmount <= 0) {
      showToast('المبلغ الأصلي يجب أن يكون أكبر من صفر', 'error');
      return false;
    }
    
    if (compensation < 0 || compensation > originalAmount) {
      showToast('مبلغ التعويض يجب أن يكون بين 0 والمبلغ الأصلي', 'error');
      return false;
    }
    
    return true;
  }
  
  function isValidOrderId(orderId) {
    const patterns = [
      /^CR\d{5}$/,  // CR12345
      /^ORD\d{5}$/  // ORD12345
    ];
    return patterns.some(pattern => pattern.test(orderId));
  }
  
  // ===== Init setup =====
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing application...');
    
    populateBranchFilters();
    
    // Load data from localStorage with error handling
    try {
      const storedTickets = localStorage.getItem('crispyTickets');
      if (storedTickets) {
        tickets = JSON.parse(storedTickets);
        console.log('Loaded tickets:', tickets.length);
      } else {
        console.log('No stored tickets found');
      }
    } catch (error) {
      console.error('Error loading tickets from localStorage:', error);
      tickets = [];
    }
    
    // If no data, add samples
    if (tickets.length === 0) {
      console.log('No tickets found, adding sample data...');
      addSample();
    } else {
      // If data exists, update the interface
      renderAll();
    }
    
    setupListeners();
    initHeatmap();
    updateSummaryDate();
    
    // Initialize commands display
    updateCommandsDisplay();
    
    // Initialize storage indicator
    updateStorageIndicator();
    
    console.log('Application initialized successfully');
  });
  
  // ===== Storage Management Functions =====
  
  // Check storage quota
  function checkStorageQuota() {
    try {
      const data = JSON.stringify(tickets);
      const dataString = 'crispyTickets=' + data;
      
      // Check if data exceeds typical localStorage limits (5MB)
      if (dataString.length > 4.5 * 1024 * 1024) { // 4.5MB limit
        console.warn('Storage quota approaching limit:', (dataString.length / 1024 / 1024).toFixed(2) + 'MB');
        return false;
      }
      return true;
    } catch (error) {
      console.error('Error checking storage quota:', error);
      return false;
    }
  }
  
  // Update storage indicator
  function updateStorageIndicator() {
    try {
      const data = JSON.stringify(tickets);
      const dataSize = new Blob([data]).size;
      const usedMB = dataSize / 1024 / 1024;
      const usedPercent = (usedMB / 5) * 100; // Assuming 5MB limit
      
      let indicator = document.getElementById('storageIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'storageIndicator';
        indicator.className = 'storage-indicator';
        document.body.appendChild(indicator);
      }
      
      indicator.textContent = `${usedPercent.toFixed(0)}% storage used`;
      
      if (usedPercent > 80) {
        indicator.classList.add('storage-warning');
      } else {
        indicator.classList.remove('storage-warning');
      }
    } catch (error) {
      console.error('Error updating storage indicator:', error);
    }
  }
  
  // Show storage info
  function showStorageInfo() {
    try {
      const data = JSON.stringify(tickets);
      const dataSize = new Blob([data]).size;
      const usedMB = (dataSize / 1024 / 1024).toFixed(2);
      const quotaMB = (localStorage.remainingSpace || 5).toFixed(2); // Approximate
      const freeMB = (quotaMB - usedMB).toFixed(2);
      
      alert(`Storage Usage:\nUsed: ${usedMB} MB\nFree: ${freeMB} MB\nTotal Cases: ${tickets.length}`);
    } catch (error) {
      console.error('Error getting storage info:', error);
      alert('Error getting storage information');
    }
  }
  
  // Clean base64 images
  function cleanBase64Images() {
    let cleanedCount = 0;
    tickets = tickets.map(ticket => {
      if (ticket.evidence && ticket.evidence.startsWith('data:image')) {
        cleanedCount++;
        return { ...ticket, evidence: 'None' };
      }
      return ticket;
    });
    
    if (cleanedCount > 0) {
      if (save()) {
        renderAll();
        showToast(`Cleaned ${cleanedCount} images. Storage freed.`, 'success');
      }
    } else {
      showToast('No base64 images found to clean.', 'info');
    }
  }
  
  // Remove old cases
  function removeOldCases() {
    const monthsToKeep = 3; // Keep last 3 months
    const cutoffDate = new Date();
    cutoffDate.setMonth(cutoffDate.getMonth() - monthsToKeep);
    
    const originalCount = tickets.length;
    tickets = tickets.filter(ticket => {
      const ticketDate = new Date(ticket.orderDate || ticket.dateCreated || Date.now());
      return ticketDate > cutoffDate;
    });
    
    const removedCount = originalCount - tickets.length;
    
    if (removedCount > 0) {
      if (save()) {
        renderAll();
        showToast(`Removed ${removedCount} old cases. Storage freed.`, 'success');
      }
    } else {
      showToast('No old cases found to remove.', 'info');
    }
  }
  
  // Offer storage cleanup
  function offerStorageCleanup() {
    if (confirm('Storage is full. Would you like to clean up old cases or images?')) {
      // Show a modal with cleanup options
      const cleanupModal = new bootstrap.Modal(document.getElementById('cleanupModal'));
      cleanupModal.show();
    }
  }
  
  // ===== Commands tracking functions =====
  function addCommand(title, details = '') {
    const now = new Date();
    const command = {
      id: Date.now(),
      title,
      details,
      time: now.toLocaleTimeString()
    };
    
    commands.unshift(command);
    
    // Keep only last 50 commands to prevent memory issues
    if (commands.length > 50) {
      commands = commands.slice(0, 50);
    }
    
    updateCommandsDisplay();
  }
  
  function updateCommandsDisplay() {
    // Update fixed window (last 3 commands)
    const commandsList = document.getElementById('commandsList');
    const lastCommands = commands.slice(0, MAX_COMMANDS_VISIBLE);
    
    commandsList.innerHTML = lastCommands.map(cmd => `
      <div class="command-item">
        <div>${cmd.title}</div>
        <div class="command-time">${cmd.time}</div>
      </div>
    `).join('');
    
    // Update all commands list
    const allCommandsList = document.getElementById('allCommandsList');
    allCommandsList.innerHTML = commands.map(cmd => `
      <div class="command-item">
        <div class="command-header">
          <div class="command-title">${cmd.title}</div>
          <div class="command-time">${cmd.time}</div>
        </div>
        ${cmd.details ? `<div class="command-details">${cmd.details}</div>` : ''}
      </div>
    `).join('');
  }
  
  function clearCommands() {
    if (confirm('Clear all command history?')) {
      commands = [];
      updateCommandsDisplay();
      showToast('Command history cleared', 'success');
    }
  }
  
  // ===== Populate branch selects =====
  function populateBranchFilters() {
    // branch select in filters and modal
    filterBranch.innerHTML = '<option value="">All Branches</option>';
    const fBranch = document.getElementById('f_branch');
    fBranch.innerHTML = '<option value="">اختر الفرع</option>';
    branchesList.forEach(b => {
      const opt1 = document.createElement('option'); opt1.value = b; opt1.textContent = b; filterBranch.appendChild(opt1);
      const opt2 = document.createElement('option'); opt2.value = b; opt2.textContent = b; fBranch.appendChild(opt2);
    });
  }
  
  // ===== Utility =====
  function save() {
    try {
      // Check storage quota before saving
      if (!checkStorageQuota()) {
        showToast('Storage quota exceeded. Please clean up old cases or images.', 'error');
        offerStorageCleanup();
        return false;
      }
      
      localStorage.setItem('crispyTickets', JSON.stringify(tickets));
      console.log('Saved tickets:', tickets.length);
      return true;
    } catch (error) {
      console.error('Error saving tickets to localStorage:', error);
      
      // Handle specific quota exceeded error
      if (error.name === 'QuotaExceededError' || 
          error.message.includes('quota') || 
          error.message.includes('exceeded')) {
        showToast('Storage full! Please clean up old cases or images.', 'error');
        offerStorageCleanup();
      } else {
        showToast('Error saving data', 'error');
      }
      return false;
    }
  }
  
  function formatDateISO(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    return d.toLocaleString();
  }
  
  function updateSummaryDate() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('summaryDate').textContent = now.toLocaleDateString('en-US', options);
  }
  
  // ===== Generate Short Link =====
  function generateShortLink() {
    const ticketId = Date.now().toString();
    const shortLink = `https://crispy.ch/t/${ticketId.slice(-6)}`;
    document.getElementById('f_shortLink').value = shortLink;
    showToast('Short link generated', 'success');
  }
  
  // ===== Handle Image Upload =====
  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      // Check file size (limit to 1MB)
      if (file.size > 1024 * 1024) {
        showToast('Image size must be less than 1MB', 'error');
        return;
      }
      
      // Check storage before uploading
      if (!checkStorageQuota()) {
        showToast('Not enough storage space. Please clean up first.', 'error');
        offerStorageCleanup();
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        
        // Store base64 data in a hidden field
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'f_evidenceBase64';
        hiddenInput.value = e.target.result;
        document.getElementById('ticketForm').appendChild(hiddenInput);
        
        showToast('Image uploaded successfully', 'success');
      };
      reader.readAsDataURL(file);
    }
  }
  
  // ===== Show Daily Summary =====
  function showDailySummary() {
    const today = new Date().toISOString().split('T')[0];
    const todayTickets = tickets.filter(t => t.orderDate.startsWith(today));
    
    // Group by branch
    const branchSummary = {};
    todayTickets.forEach(ticket => {
      if (!branchSummary[ticket.branch]) {
        branchSummary[ticket.branch] = {
          totalCases: 0,
          totalCompensation: 0,
          totalRefunded: 0,
          cases: []
        };
      }
      branchSummary[ticket.branch].totalCases++;
      branchSummary[ticket.branch].totalCompensation += ticket.compensation || 0;
      branchSummary[ticket.branch].totalRefunded += ticket.refundedAmount || 0;
      branchSummary[ticket.branch].cases.push(ticket);
    });
    
    // Generate HTML for daily summary
    let html = '';
    Object.keys(branchSummary).forEach(branch => {
      const summary = branchSummary[branch];
      html += `
        <div class="daily-branch-item">
          <div class="daily-branch-header">
            <div class="daily-branch-name">${branch}</div>
            <div class="daily-branch-stats">
              <div class="daily-stat">
                <div class="daily-stat-value">${summary.totalCases}</div>
                <div class="daily-stat-label">Cases</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">AED ${summary.totalCompensation.toFixed(2)}</div>
                <div class="daily-stat-label">Compensation</div>
              </div>
              <div class="daily-stat">
                <div class="daily-stat-value">AED ${summary.totalRefunded.toFixed(2)}</div>
                <div class="daily-stat-label">Refunded</div>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <h6 class="mb-2">Cases:</h6>
            <ul class="list-group">
      `;
      
      summary.cases.forEach(ticket => {
        const compensationClass = ticket.compensation > 25 ? 'list-group-item-danger' : '';
        const refundedClass = ticket.isRefunded ? 'list-group-item-success' : '';
        const rowClass = compensationClass + (refundedClass ? ' ' + refundedClass : '');
        
        html += `
          <li class="list-group-item ${rowClass} d-flex justify-content-between align-items-center">
            <div>
              <strong>${ticket.orderId}</strong> - ${ticket.issue.substring(0, 50)}...
              <div class="text-muted small">
                Original: AED ${ticket.originalAmount || 0} | 
                Compensation: AED ${ticket.compensation || 0} | 
                Refunded: AED ${ticket.refundedAmount || 0}
              </div>
            </div>
            <div>
              <span class="badge bg-${ticket.status === 'Open' ? 'primary' : ticket.status === 'Sent' ? 'warning' : 'success'}">${ticket.status}</span>
              ${ticket.isRefunded ? '<span class="badge bg-success ms-1">Refunded</span>' : ''}
            </div>
          </li>
        `;
      });
      
      html += `
            </ul>
          </div>
        </div>
      `;
    });
    
    document.getElementById('dailySummaryContent').innerHTML = html;
    new bootstrap.Modal(document.getElementById('dailySummaryModal')).show();
  }
  
  // ===== Export Daily Summary =====
  function exportDailySummary() {
    const content = document.getElementById('dailySummaryContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>Daily Branch Summary</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            .daily-branch-item { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
            .daily-branch-name { font-weight: bold; font-size: 1.2rem; }
            .daily-stat { text-align: center; }
            .daily-stat-value { font-weight: bold; font-size: 1.1rem; }
            .list-group-item-danger { background-color: #ffebee; }
            .list-group-item-success { background-color: #d4edda; }
          </style>
        </head>
        <body>
          <h1>Daily Branch Summary</h1>
          <p>Generated on: ${new Date().toLocaleString()}</p>
          ${content}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
  
  // ===== Render =====
  function renderAll() {
    try {
      console.log('Rendering dashboard...');
      renderTickets();
      updateStats();
      updatePlatformStats();
      renderCharts();
      renderCaseAnalysis();
      renderCompensationAnalysis();
      renderRejectionAnalysis();
      renderRefundAnalysis();
      renderSummary();
      updateStorageIndicator();
      console.log('Dashboard rendered successfully');
    } catch (error) {
      console.error('Error rendering dashboard:', error);
      showToast('Error rendering dashboard', 'error');
    }
  }
  
  function filteredTickets() {
    const q = searchInput.value.trim().toLowerCase();
    const b = filterBranch.value;
    const p = filterPlatform.value;
    const s = filterStatus.value;
    return tickets.filter(t => {
      if (b && t.branch !== b) return false;
      if (p && t.platform !== p) return false;
      if (s && t.status !== s) return false;
      if (!q) return true;
      return (t.orderId || '').toString().toLowerCase().includes(q) ||
             (t.branch || '').toLowerCase().includes(q) ||
             (t.issue || '').toLowerCase().includes(q);
    });
  }
  
  function renderTickets() {
    const data = filteredTickets();
    if (data.length === 0) {
      ticketsContainer.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-inbox" style="font-size: 48px; color: #ddd;"></i>
          <h5 class="mt-3 text-muted">لا توجد حالات</h5>
          <p class="text-muted">أضف حالة تعويض جديدة للبدء</p>
          <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus-circle me-2"></i>إضافة حالة جديدة
          </button>
        </div>
      `;
      return;
    }
    
    let html = `
      <div class="table-responsive">
        <table class="tickets-table">
          <thead>
            <tr>
              <th>معرف الطلب</th>
              <th>التاريخ</th>
              <th>الفرع</th>
              <th>المنصة</th>
              <th>الحالة</th>
              <th>المبلغ الأصلي</th>
              <th>التعويض</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    data.forEach((ticket, index) => {
      const rowClass = ticket.compensation > 25 ? 'highlight-row' : '';
      
      html += `
        <tr class="${rowClass}">
          <td>
            <span class="fw-bold">${ticket.orderId}</span>
          </td>
          <td>${formatDateISO(ticket.orderDate)}</td>
          <td>${ticket.branch}</td>
          <td>
            <span class="badge bg-${ticket.platform === 'Noon' ? 'warning' : 'info'}">
              ${ticket.platform}
            </span>
          </td>
          <td>
            <span class="status-badge status-${ticket.status.toLowerCase()}">
              <i class="bi bi-${getStatusIcon(ticket.status)}"></i>
              ${ticket.status}
            </span>
          </td>
          <td>AED ${Number(ticket.originalAmount || 0).toFixed(2)}</td>
          <td>
            <span class="fw-bold ${ticket.compensation > 25 ? 'text-danger' : ''}">
              AED ${Number(ticket.compensation || 0).toFixed(2)}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="editTicket('${ticket.id}')" title="تعديل">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-success" onclick="sendWhatsApp('${ticket.id}')" title="واتساب">
                <i class="bi bi-whatsapp"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="openRejectionModalForCase('${ticket.id}')" title="رفض">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    ticketsContainer.innerHTML = html;
  }
  
  function getStatusIcon(status) {
    const icons = {
      'Open': 'clock',
      'Sent': 'send',
      'Closed': 'check-circle',
      'Rejected': 'x-circle'
    };
    return icons[status] || 'question-circle';
  }
  
  // ===== Stats & Platforms =====
  function updateStats() {
    const stats = {
      total: tickets.length,
      open: tickets.filter(t => t.status === 'Open').length,
      sent: tickets.filter(t => t.status === 'Sent').length,
      closed: tickets.filter(t => t.status === 'Closed').length,
      rejected: tickets.filter(t => t.status === 'Rejected').length,
      compensation: tickets.reduce((sum, t) => sum + (t.compensation || 0), 0)
    };
    
    // Update stats with animation
    updateStatElement('totalTickets', stats.total);
    updateStatElement('openTickets', stats.open);
    updateStatElement('sentTickets', stats.sent);
    updateStatElement('closedTickets', stats.closed);
    updateStatElement('rejectedTickets', stats.rejected);
    updateStatElement('totalCompensationAmount', `AED ${stats.compensation.toFixed(2)}`);
  }
  
  function updateStatElement(id, value) {
    const element = document.getElementById(id);
    if (!element) return;
    
    // Add animation effect
    element.style.opacity = '0';
    element.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      element.textContent = value;
      element.style.transition = 'all 0.5s ease';
      element.style.opacity = '1';
      element.style.transform = 'translateY(0)';
    }, 100);
  }
  
  function updatePlatformStats() {
    const total = Math.max(1, tickets.length);
    const noon = tickets.filter(t => t.platform === 'Noon').length;
    const careem = tickets.filter(t => t.platform === 'Careem').length;
    document.getElementById('noonCount').textContent = noon;
    document.getElementById('careemCount').textContent = careem;
    document.getElementById('noonPercentage').textContent = ((noon / total) * 100).toFixed(1) + '%';
    document.getElementById('careemPercentage').textContent = ((careem / total) * 100).toFixed(1) + '%';
  }
  
  // ===== Refund Analysis =====
  function renderRefundAnalysis() {
    // Calculate refund metrics
    const totalRefunded = tickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
    const refundedCases = tickets.filter(t => t.isRefunded).length;
    const refundRate = tickets.length > 0 ? (refundedCases / tickets.length) * 100 : 0;
    const avgRefunded = refundedCases > 0 ? totalRefunded / refundedCases : 0;
    
    // Update refund metrics
    document.getElementById('totalRefundedAmount').textContent = 'AED ' + totalRefunded.toFixed(2);
    document.getElementById('refundedCasesCount').textContent = refundedCases;
    document.getElementById('refundRate').textContent = refundRate.toFixed(1) + '%';
    document.getElementById('avgRefundedAmount').textContent = 'AED ' + avgRefunded.toFixed(2);
    
    // Platform refunds
    const noonRefunded = tickets.filter(t => t.platform === 'Noon' && t.isRefunded).length;
    const careemRefunded = tickets.filter(t => t.platform === 'Careem' && t.isRefunded).length;
    document.getElementById('noonRefunded').textContent = noonRefunded;
    document.getElementById('careemRefunded').textContent = careemRefunded;
    
    // Branch refunds chart
    const branchRefunds = {};
    tickets.forEach(t => {
      if (t.isRefunded) {
        branchRefunds[t.branch] = (branchRefunds[t.branch] || 0) + (t.refundedAmount || 0);
      }
    });
    
    const ctx = document.getElementById('refundBranchChart').getContext('2d');
    if (refundBranchChart) refundBranchChart.destroy();
    
    refundBranchChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(branchRefunds),
        datasets: [{
          label: 'Refunded Amount (AED)',
          data: Object.values(branchRefunds),
          backgroundColor: '#28a745'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    
    // Refund table
    const refundTableBody = document.getElementById('refundTableBody');
    refundTableBody.innerHTML = '';
    
    const refundedTickets = tickets.filter(t => t.isRefunded).sort((a, b) => 
      new Date(b.refundDate || 0) - new Date(a.refundDate || 0)
    );
    
    refundedTickets.forEach(ticket => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ticket.orderId}</td>
        <td>${ticket.branch}</td>
        <td>AED ${Number(ticket.originalAmount || 0).toFixed(2)}</td>
        <td>AED ${Number(ticket.compensation || 0).toFixed(2)}</td>
        <td>AED ${Number(ticket.refundedAmount || 0).toFixed(2)}</td>
        <td><span class="refund-status-badge status-refunded">Refunded</span></td>
        <td>${ticket.refundDate || '-'}</td>
      `;
      refundTableBody.appendChild(row);
    });
    
    if (refundedTickets.length === 0) {
      refundTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-muted">No refunded cases found</td>
        </tr>
      `;
    }
  }
  
  // ===== Compensation Analysis =====
  function analyzeCompensations() {
    const compensationTypes = {
      'Missing/Incorrect': 0,
      'Spilled/Damaged': 0,
      'Late Delivery': 0,
      'Food Quality': 0,
      'Other': 0
    };
    
    const compensationAmounts = {
      'Missing/Incorrect': 0,
      'Spilled/Damaged': 0,
      'Late Delivery': 0,
      'Food Quality': 0,
      'Other': 0
    };
    
    tickets.forEach(ticket => {
      if (ticket.compensation > 0) {
        const type = classifyCase(ticket.issue);
        compensationTypes[type] += 1;
        compensationAmounts[type] += ticket.compensation;
      }
    });
    
    return { compensationTypes, compensationAmounts };
  }
  
  function renderCompensationAnalysis() {
    const analysis = analyzeCompensations();
    
    // Create HTML for display
    let html = '<div class="compensation-analysis-grid">';
    
    Object.keys(analysis.compensationTypes).forEach(type => {
      html += `
        <div class="compensation-card">
          <h6>${type}</h6>
          <div class="compensation-stats">
            <div class="stat-item">
              <div class="stat-value">${analysis.compensationTypes[type]}</div>
              <div class="stat-label">Cases</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">AED ${analysis.compensationAmounts[type].toFixed(2)}</div>
              <div class="stat-label">Total Amount</div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    
    document.getElementById('compensationAnalysisContainer').innerHTML = html;
  }
  
  // ===== Rejection Analysis =====
  function analyzeRejections() {
    const rejectionReasons = {
      'no_evidence': 0,
      'incorrect_claim': 0,
      'driver_fault': 0,
      'customer_error': 0,
      'other': 0
    };
    
    const rejectionAmounts = {
      'no_evidence': 0,
      'incorrect_claim': 0,
      'driver_fault': 0,
      'customer_error': 0,
      'other': 0
    };
    
    tickets.forEach(ticket => {
      if (ticket.status === 'Rejected' && ticket.rejectionReason) {
        const reason = ticket.rejectionReason;
        rejectionReasons[reason] = (rejectionReasons[reason] || 0) + 1;
        rejectionAmounts[reason] = (rejectionAmounts[reason] || 0) + (ticket.compensation || 0);
      }
    });
    
    return { rejectionReasons, rejectionAmounts };
  }
  
  function renderRejectionAnalysis() {
    const analysis = analyzeRejections();
    const rejectedCases = tickets.filter(t => t.status === 'Rejected');
    
    // Create HTML for display
    let html = '<div class="rejection-analysis-grid">';
    
    Object.keys(analysis.rejectionReasons).forEach(reason => {
      const count = analysis.rejectionReasons[reason];
      const amount = analysis.rejectionAmounts[reason];
      
      if (count > 0) {
        html += `
          <div class="rejection-card">
            <h6>${getReasonLabel(reason)}</h6>
            <div class="rejection-stats">
              <div class="rejection-metric-item">
                <div class="rejection-metric-value">${count}</div>
                <div class="rejection-metric-label">Cases</div>
              </div>
              <div class="rejection-metric-item">
                <div class="rejection-metric-value">AED ${amount.toFixed(2)}</div>
                <div class="rejection-metric-label">Amount Saved</div>
              </div>
            </div>
          </div>
        `;
      }
    });
    
    // Add summary card
    html += `
      <div class="rejection-card">
        <h6>Summary</h6>
        <div class="rejection-stats">
          <div class="rejection-metric-item">
            <div class="rejection-metric-value">${rejectedCases.length}</div>
            <div class="rejection-metric-label">Total Rejected</div>
          </div>
          <div class="rejection-metric-item">
            <div class="rejection-metric-value">AED ${rejectedCases.reduce((sum, t) => sum + (t.compensation || 0), 0).toFixed(2)}</div>
            <div class="rejection-metric-label">Total Saved</div>
          </div>
        </div>
      </div>
    `;
    
    html += '</div>';
    
    document.getElementById('rejectionAnalysisContainer').innerHTML = html;
  }
  
  function getReasonLabel(reason) {
    const labels = {
      no_evidence: 'لا يوجد دليل',
      incorrect_claim: 'ادعاء غير صحيح',
      driver_fault: 'خطأ السائق',
      customer_error: 'خطأ العميل',
      other: 'أسباب أخرى'
    };
    return labels[reason] || reason;
  }
  
  // ===== Summary Section =====
  function renderSummary() {
    // Financial Overview
    const totalOriginal = tickets.reduce((sum, t) => sum + (t.originalAmount || 0), 0);
    const totalComp = tickets.reduce((sum, t) => sum + (t.compensation || 0), 0);
    const totalRefunded = tickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
    const netCompensation = totalComp - totalRefunded;
    const avgComp = tickets.filter(t => t.compensation > 0).length > 0 
      ? totalComp / tickets.filter(t => t.compensation > 0).length 
      : 0;
    const compensationRate = totalOriginal > 0 ? (totalComp / totalOriginal) * 100 : 0;
    
    document.getElementById('totalOriginalAmount').textContent = 'AED ' + totalOriginal.toFixed(2);
    document.getElementById('totalCompensation').textContent = 'AED ' + totalComp.toFixed(2);
    document.getElementById('totalRefunded').textContent = 'AED ' + totalRefunded.toFixed(2);
    document.getElementById('netCompensation').textContent = 'AED ' + netCompensation.toFixed(2);
    document.getElementById('compensationRate').textContent = compensationRate.toFixed(1) + '%';
    
    // Platform Performance
    const noonTickets = tickets.filter(t => t.platform === 'Noon').length;
    const careemTickets = tickets.filter(t => t.platform === 'Careem').length;
    const noonComp = tickets.filter(t => t.platform === 'Noon').reduce((sum, t) => sum + (t.compensation || 0), 0);
    const careemComp = tickets.filter(t => t.platform === 'Careem').reduce((sum, t) => sum + (t.compensation || 0), 0);
    const noonRef = tickets.filter(t => t.platform === 'Noon' && t.isRefunded).reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
    const careemRef = tickets.filter(t => t.platform === 'Careem' && t.isRefunded).reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
    
    document.getElementById('noonTickets').textContent = noonTickets;
    document.getElementById('careemTickets').textContent = careemTickets;
    document.getElementById('noonRefunded').textContent = 'AED ' + noonRef.toFixed(2);
    document.getElementById('careemRefunded').textContent = 'AED ' + careemRef.toFixed(2);
    
    // Branch Performance
    const branchCounts = {};
    tickets.forEach(t => {
      branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
    });
    const topBranch = Object.keys(branchCounts).reduce((a, b) => branchCounts[a] > branchCounts[b] ? a : b, '');
    const caseCounts = {};
    tickets.forEach(t => {
      const type = classifyCase(t.issue);
      caseCounts[type] = (caseCounts[type] || 0) + 1;
    });
    const topCase = Object.keys(caseCounts).reduce((a, b) => caseCounts[a] > caseCounts[b] ? a : b, '');
    const caseRate = tickets.filter(t => t.compensation > 0).length / tickets.length * 100;
    const avgOriginal = tickets.reduce((sum, t) => sum + (t.originalAmount || 0), 0) / tickets.length;
    
    document.getElementById('topBranch').textContent = topBranch || '-';
    document.getElementById('topCase').textContent = topCase || '-';
    document.getElementById('caseRate').textContent = caseRate.toFixed(1) + '%';
    document.getElementById('avgOriginalAmount').textContent = 'AED ' + avgOriginal.toFixed(2);
    
    // Update summary charts
    updateSummaryCharts();
  }
  
  function updateSummaryCharts() {
    // Amount Chart
    const ctx1 = document.getElementById('amountChart').getContext('2d');
    if (amountChart) amountChart.destroy();
    amountChart = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['Original Amount', 'Compensation', 'Refunded'],
        datasets: [{
          data: [
            tickets.reduce((sum, t) => sum + (t.originalAmount || 0), 0),
            tickets.reduce((sum, t) => sum + (t.compensation || 0), 0),
            tickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0)
          ],
          backgroundColor: ['#0d6efd', '#dc3545', '#28a745']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 } }
          }
        }
      }
    });
    
    // Status Chart
    const ctx2 = document.getElementById('statusChart').getContext('2d');
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: ['Open', 'Sent', 'Closed', 'Rejected'],
        datasets: [{
          data: [
            tickets.filter(t => t.status === 'Open').length,
            tickets.filter(t => t.status === 'Sent').length,
            tickets.filter(t => t.status === 'Closed').length,
            tickets.filter(t => t.status === 'Rejected').length
          ],
          backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#dc3545']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    
    // Platform Tickets Chart
    const ctx3 = document.getElementById('platformTicketsChart').getContext('2d');
    if (platformTicketsChart) platformTicketsChart.destroy();
    platformTicketsChart = new Chart(ctx3, {
      type: 'pie',
      data: {
        labels: ['Noon', 'Careem'],
        datasets: [{
          data: [
            tickets.filter(t => t.platform === 'Noon').length,
            tickets.filter(t => t.platform === 'Careem').length
          ],
          backgroundColor: ['#ff7043', '#7e57c2']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 } }
          }
        }
      }
    });
    
    // Platform Compensation Chart
    const ctx4 = document.getElementById('platformCompensationChart').getContext('2d');
    if (platformCompensationChart) platformCompensationChart.destroy();
    platformCompensationChart = new Chart(ctx4, {
      type: 'bar',
      data: {
        labels: ['Noon', 'Careem'],
        datasets: [
          {
            label: 'Compensation (AED)',
            data: [
              tickets.filter(t => t.platform === 'Noon').reduce((sum, t) => sum + (t.compensation || 0), 0),
              tickets.filter(t => t.platform === 'Careem').reduce((sum, t) => sum + (t.compensation || 0), 0)
            ],
            backgroundColor: ['#ff7043', '#7e57c2']
          },
          {
            label: 'Refunded (AED)',
            data: [
              tickets.filter(t => t.platform === 'Noon' && t.isRefunded).reduce((sum, t) => sum + (t.refundedAmount || 0), 0),
              tickets.filter(t => t.platform === 'Careem' && t.isRefunded).reduce((sum, t) => sum + (t.refundedAmount || 0), 0)
            ],
            backgroundColor: ['#28a745', '#20c997']
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 } }
          }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    
    // Branch Cases Chart
    const ctx5 = document.getElementById('branchCasesChart').getContext('2d');
    if (branchCasesChart) branchCasesChart.destroy();
    const branchCounts = {};
    tickets.forEach(t => {
      branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
    });
    branchCasesChart = new Chart(ctx5, {
      type: 'bar',
      data: {
        labels: Object.keys(branchCounts),
        datasets: [{
          data: Object.values(branchCounts),
          backgroundColor: '#d32f2f'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true }
        }
      }
    });
    
    // Case Types Chart
    const ctx6 = document.getElementById('caseTypesChart').getContext('2d');
    if (caseTypesChart) caseTypesChart.destroy();
    const caseCounts = {};
    tickets.forEach(t => {
      const type = classifyCase(t.issue);
      caseCounts[type] = (caseCounts[type] || 0) + 1;
    });
    caseTypesChart = new Chart(ctx6, {
      type: 'doughnut',
      data: {
        labels: Object.keys(caseCounts),
        datasets: [{
          data: Object.values(caseCounts),
          backgroundColor: ['#d32f2f', '#ff7043', '#66bb6a', '#42a5f5', '#ab47bc', '#78909c']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 } }
          }
        }
      }
    });
  }
  
  // ===== Charts =====
  function renderCharts() {
    const byBranch = {};
    const byCase = {};
    tickets.forEach(t => {
      byBranch[t.branch] = (byBranch[t.branch] || 0) + 1;
      const type = classifyCase(t.issue);
      byCase[type] = (byCase[type] || 0) + 1;
    });
    
    const branchLabels = Object.keys(byBranch);
    const branchData = Object.values(byBranch);
    const caseLabels = Object.keys(byCase);
    const caseData = Object.values(byCase);
    
    // branchChart
    if (!branchChart) {
      branchChart = new Chart(document.getElementById('branchChart'), {
        type: 'bar',
        data: {
          labels: branchLabels,
          datasets: [{
            label: 'Cases',
            data: branchData,
            backgroundColor: 'rgba(211, 47, 47, 0.78)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      branchChart.data.labels = branchLabels;
      branchChart.data.datasets[0].data = branchData;
      branchChart.update();
    }
    
    if (!caseChart) {
      caseChart = new Chart(document.getElementById('caseChart'), {
        type: 'doughnut',
        data: {
          labels: caseLabels,
          datasets: [{
            data: caseData,
            backgroundColor: [
              'rgba(211, 47, 47, 0.78)',
              'rgba(255, 112, 67, 0.78)',
              'rgba(76, 175, 80, 0.78)',
              'rgba(33, 150, 243, 0.78)',
              'rgba(156, 39, 176, 0.78)',
              'rgba(96, 125, 139, 0.78)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: { size: 12 },
                padding: 15
              }
            }
          }
        }
      });
    } else {
      caseChart.data.labels = caseLabels;
      caseChart.data.datasets[0].data = caseData;
      caseChart.update();
    }
    
    document.getElementById('topBranchLabel').textContent = branchLabels.length ? branchLabels[0] : '';
    document.getElementById('topCaseLabel').textContent = caseLabels.length ? caseLabels[0] : '';
  }
  
  // ===== Case Analysis =====
  function renderCaseAnalysis() {
    const branchData = analyzeCases();
    const container = document.getElementById('branchAnalysisContainer');
    const branches = Object.keys(branchData);
    
    // Calculate overall case level
    const avgCaseRate = branches.reduce((sum, branch) => sum + branchData[branch].caseRate, 0) / branches.length;
    const badge = document.getElementById('caseAnalysisBadge');
    
    if (avgCaseRate > 30) {
      badge.className = 'case-badge badge-high';
      badge.textContent = 'High Level';
    } else if (avgCaseRate > 15) {
      badge.className = 'case-badge badge-medium';
      badge.textContent = 'Medium Level';
    } else {
      badge.className = 'case-badge badge-low';
      badge.textContent = 'Low Level';
    }
    
    // Create HTML for analysis
    let html = '<div class="branch-analysis-grid">';
    
    branches.forEach(branch => {
      const data = branchData[branch];
      const maxCases = Math.max(...Object.values(data.cases));
      
      html += `
        <div class="branch-card">
          <h6>${branch}</h6>
          <div class="branch-stats">
            <div class="branch-stat-item">
              <div class="branch-stat-value">${data.totalCases}</div>
              <div class="branch-stat-label">Total Cases</div>
            </div>
            <div class="branch-stat-item">
              <div class="branch-stat-value">${data.compensationCases}</div>
              <div class="branch-stat-label">Compensation Cases</div>
            </div>
            <div class="branch-stat-item">
              <div class="branch-stat-value">${data.caseRate.toFixed(1)}%</div>
              <div class="branch-stat-label">Case Rate</div>
            </div>
            <div class="branch-stat-item">
              <div class="branch-stat-value">${data.totalCompensation.toFixed(0)}</div>
              <div class="branch-stat-label">Total Comp</div>
            </div>
          </div>
          
          <div class="case-reasons">
            <h6>Case Reasons:</h6>
      `;
      
      // Display case reasons
      Object.entries(data.cases).forEach(([caseType, count]) => {
        const percentage = (count / data.totalCases) * 100;
        html += `
          <div class="case-reason-item">
            <div class="case-reason-info">
              <div class="case-reason-name">${caseType}</div>
              <div class="case-reason-count">${count} (${percentage.toFixed(1)}%)</div>
            </div>
            <div class="case-reason-bar">
              <div class="case-reason-progress" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }
  
  function analyzeCases() {
    const branchData = {};
    
    tickets.forEach(ticket => {
      if (!branchData[ticket.branch]) {
        branchData[ticket.branch] = {
          totalCases: 0,
          compensationCases: 0,
          totalCompensation: 0,
          cases: {}
        };
      }
      
      branchData[ticket.branch].totalCases++;
      
      // If there's compensation, it's a compensation case
      if (ticket.compensation > 0) {
        branchData[ticket.branch].compensationCases++;
        branchData[ticket.branch].totalCompensation += ticket.compensation;
      }
      
      // Classify case type
      const caseType = classifyCase(ticket.issue);
      if (!branchData[ticket.branch].cases[caseType]) {
        branchData[ticket.branch].cases[caseType] = 0;
      }
      branchData[ticket.branch].cases[caseType]++;
    });
    
    // Calculate rates and levels
    const branches = Object.keys(branchData);
    branches.forEach(branch => {
      const data = branchData[branch];
      data.caseRate = (data.compensationCases / data.totalCases) * 100;
      data.avgCompensation = data.compensationCases > 0 ? data.totalCompensation / data.compensationCases : 0;
      
      // Determine case level
      if (data.caseRate > 30) {
        data.caseLevel = 'high';
      } else if (data.caseRate > 15) {
        data.caseLevel = 'medium';
      } else {
        data.caseLevel = 'low';
      }
    });
    
    return branchData;
  }
  
  function classifyCase(text = '') {
    const t = (text || '').toLowerCase();
    
    // More detailed classification
    if (/cold|temperature|ice|frozen/.test(t)) return 'Cold Food';
    if (/late|delay|time/.test(t)) return 'Late Delivery';
    if (/wrong|incorrect|different|missing/.test(t)) return 'Missing/Incorrect';
    if (/spilled|damaged|broken/.test(t)) return 'Spilled/Damaged';
    if (/quality|taste|bad|spoiled|raw/.test(t)) return 'Food Quality';
    if (/rude|attitude|behavior|service/.test(t)) return 'Service Issue';
    if (/app|website|technical|glitch/.test(t)) return 'Technical Issue';
    return 'Other';
  }
  
  // ===== Enhanced dispute templates =====
  function getTemplateType(ticket) {
    const issue = (ticket.issue || '').toLowerCase();
    
    // If there's video evidence
    if (ticket.evidence && ticket.evidence !== 'None' && ticket.evidence.startsWith('data:image')) {
      return 'video_proof';
    }
    
    // If the dispute is about missing or incorrect item
    if (/missing|incorrect|different/.test(issue)) {
      if (!ticket.evidence || ticket.evidence === 'None') {
        return 'no_evidence';
      }
      return 'missing_incorrect';
    }
    
    // If the dispute is about spill/damage due to delivery driver
    if (/spilled|damaged/.test(issue)) {
      return 'driver_fault';
    }
    
    // Default template
    return 'default';
  }
  
  // ===== Enhanced Actions: Add / Edit / Close / Sample / Reset =====
  function openAddModal() {
    console.log('Opening add modal...');
    document.getElementById('modalTitle').textContent = 'Add Compensation Case';
    document.getElementById('editingId').value = '';
    document.getElementById('ticketForm').reset();
    
    // Clear image preview and base64 data
    document.getElementById('imagePreview').style.display = 'none';
    const base64Input = document.getElementById('f_evidenceBase64');
    if (base64Input) base64Input.remove();
    
    const nowLocal = new Date().toISOString().slice(0, 16);
    document.getElementById('f_orderDate').value = nowLocal;
    new bootstrap.Modal(document.getElementById('ticketModal')).show();
    
    // Track command
    addCommand('Open Add Modal');
  }
  
  document.getElementById('ticketForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('Form submitted...');
    
    // Validate form first
    if (!validateForm()) {
      return;
    }
    
    const id = document.getElementById('editingId').value;
    const payload = {
      orderId: document.getElementById('f_orderId').value.trim(),
      orderDate: document.getElementById('f_orderDate').value,
      branch: document.getElementById('f_branch').value,
      platform: document.getElementById('f_platform').value,
      issue: document.getElementById('f_issue').value.trim(),
      originalAmount: Number(document.getElementById('f_originalAmount').value || 0),
      compensation: Number(document.getElementById('f_compensation').value || 0),
      refundedAmount: Number(document.getElementById('f_refundedAmount').value || 0),
      isRefunded: document.getElementById('f_isRefunded').checked,
      refundDate: document.getElementById('f_refundDate').value || null,
      evidence: document.getElementById('f_noEvidence').checked ? 'None' : 
                (document.getElementById('f_shortLink').value || 
                 document.getElementById('f_evidenceBase64')?.value || 'None'),
      status: 'Open'
    };
    
    console.log('Form payload:', payload);
    
    if (id) {
      // Update existing ticket
      const idx = tickets.findIndex(t => t.id === id);
      if (idx > -1) { 
        tickets[idx] = { ...tickets[idx], ...payload }; 
        showToast('Case updated', 'success'); 
        // Track command
        addCommand('Update Ticket', `Updated Order ${payload.orderId}`);
      }
    } else {
      // Add new ticket
      const newTicket = { 
        id: Date.now().toString(), 
        ...payload,
        dateCreated: new Date().toISOString()
      };
      tickets.unshift(newTicket); 
      
      // Send WhatsApp notification to branch
      notifyBranch(newTicket);
      
      showToast('Case added and branch notified', 'success');
      // Track command
      addCommand('Add Ticket', `Added Order ${payload.orderId}`);
    }
    
    console.log('Tickets before save:', tickets.length);
    
    if (save()) {
      console.log('Data saved successfully');
      renderAll();
      bootstrap.Modal.getInstance(document.getElementById('ticketModal')).hide();
    } else {
      showToast('Error saving data', 'error');
    }
  });
  
  function editTicket(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    
    document.getElementById('editingId').value = t.id;
    document.getElementById('f_orderId').value = t.orderId || '';
    document.getElementById('f_orderDate').value = t.orderDate || '';
    document.getElementById('f_branch').value = t.branch || '';
    document.getElementById('f_platform').value = t.platform || '';
    document.getElementById('f_issue').value = t.issue || '';
    document.getElementById('f_originalAmount').value = t.originalAmount || 0;
    document.getElementById('f_compensation').value = t.compensation || 0;
    document.getElementById('f_refundedAmount').value = t.refundedAmount || 0;
    document.getElementById('f_isRefunded').checked = t.isRefunded || false;
    document.getElementById('f_refundDate').value = t.refundDate || '';
    
    // Handle evidence
    if (t.evidence && t.evidence !== 'None') {
      // If it's a base64 image
      if (t.evidence.startsWith('data:image')) {
        document.getElementById('imagePreview').src = t.evidence;
        document.getElementById('imagePreview').style.display = 'block';
        
        const base64Input = document.createElement('input');
        base64Input.type = 'hidden';
        base64Input.id = 'f_evidenceBase64';
        base64Input.value = t.evidence;
        document.getElementById('ticketForm').appendChild(base64Input);
      } else if (t.evidence.startsWith('https://crispy.ch/t/')) {
        // If it's a short link
        document.getElementById('f_shortLink').value = t.evidence;
      } else {
        // If it's a regular URL
        document.getElementById('f_evidence').value = t.evidence;
      }
    } else {
      document.getElementById('f_noEvidence').checked = true;
    }
    
    autogrow(document.getElementById('f_issue'));
    new bootstrap.Modal(document.getElementById('ticketModal')).show();
    
    // Track command
    addCommand('Edit Ticket', `Editing Order ${t.orderId}`);
  }
  
  function closeTicket(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    t.status = 'Closed'; 
    save(); 
    renderAll(); 
    showToast('Case closed', 'success');
    
    // Track command
    addCommand('Close Ticket', `Order ${t.orderId} marked as Closed`);
  }
  
  function addSample() {
    console.log('Adding sample data...');
    try {
      const sample = [
        { 
          id: Date.now().toString() + 'a', 
          orderId: 'CR' + Math.floor(Math.random() * 900000 + 100000), 
          orderDate: new Date().toISOString(), 
          branch: 'Crispy Chicken Khalidiya', 
          platform: 'Careem', 
          issue: 'Food was cold and delivery was late', 
          originalAmount: 85.00,
          compensation: 25.00, 
          refundedAmount: 10.00,
          isRefunded: true,
          refundDate: new Date().toISOString().split('T')[0],
          evidence: 'None', 
          status: 'Open',
          dateCreated: new Date().toISOString()
        },
        { 
          id: Date.now().toString() + 'b', 
          orderId: 'ORD' + Math.floor(Math.random() * 900000 + 100000), 
          orderDate: new Date().toISOString(), 
          branch: 'Crispy Chicken Muroor', 
          platform: 'Noon', 
          issue: 'Wrong order items received', 
          originalAmount: 120.00,
          compensation: 45.00, 
          refundedAmount: 0,
          isRefunded: false,
          evidence: 'None', 
          status: 'Open',
          dateCreated: new Date().toISOString()
        }
      ];
      
      // Add new cases explicitly
      sample.forEach(newTicket => {
        tickets.unshift(newTicket);
      });
      
      console.log('After adding sample:', tickets.length);
      
      // Save data
      if (save()) {
        // Update interface
        renderAll();
        
        // Show notification
        showToast('Sample cases added successfully', 'success');
        
        // Track command
        addCommand('Add Sample Cases', `Added ${sample.length} sample cases`);
      } else {
        showToast('Error saving sample data', 'error');
      }
      
    } catch (error) {
      console.error('Error in addSample:', error);
      showToast('Error adding sample cases', 'error');
    }
  }
  
  function resetAll() {
    if (!confirm('Reset all data?')) return;
    localStorage.removeItem('crispyTickets'); 
    tickets = [];
    renderAll();
    showToast('Data reset', 'success');
    
    // Track command
    addCommand('Reset All Data');
  }
  
  // ===== Enhanced Communications with dispute templates =====
  function sendEmail(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    
    const templateType = getTemplateType(t);
    const subject = `Dispute Rejection – Order ${t.orderId}`;
    
    let body = '';
    
    switch (templateType) {
      case 'missing_incorrect':
        body = `Subject: Dispute Rejection – Order ${t.orderId}
Dear ${t.platform} Support Team,
This is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.
We have noted the deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}". After reviewing our records and attached video evidence, the order was fully prepared and delivered as requested.
We therefore reject this adjustment and request reversal.
Best regards,
${t.branch}`;
        break;
        
      case 'driver_fault':
        body = `Subject: Dispute Rejection – Order ${t.orderId}
Dear ${t.platform} Support Team,
This is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.
The deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "Spilled / Damaged" cannot be applied, as the order was properly packed and handed over in perfect condition. The damage occurred during delivery due to driver mishandling and is not the restaurant's responsibility.
We kindly request reversal of this adjustment.
Best regards,
${t.branch}`;
        break;
        
      case 'no_evidence':
        body = `Subject: Dispute Rejection – Order ${t.orderId}
Dear ${t.platform} Support Team,
This is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.
We have noted the deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}". No verifiable evidence has been provided to justify this adjustment, as required under platform policy and UAE Consumer Protection Law.
Therefore, we reject this deduction and request immediate reversal.
Best regards,
${t.branch}`;
        break;
        
      case 'video_proof':
        body = `Subject: Dispute Rejection – Order ${t.orderId}
Dear ${t.platform} Support Team,
This is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}.
The deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}" is rejected. The attached video clearly shows the order was fully prepared and delivered correctly.
Please reverse the adjustment accordingly.
Best regards,
${t.branch}`;
        break;
      
      default:
        body = `Order ID: ${t.orderId}\nDate: ${formatDateISO(t.orderDate)}\nBranch: ${t.branch}\nPlatform: ${t.platform}\nCase: ${t.issue}\nOriginal Amount: AED ${Number(t.originalAmount || 0).toFixed(2)}\nCompensation: AED ${Number(t.compensation || 0).toFixed(2)}\nRefunded: AED ${Number(t.refundedAmount || 0).toFixed(2)}\nStatus: ${t.status}`;
    }
    
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    t.status = 'Sent';
    save();
    renderAll();
    showToast('Email client opened', 'success');
    
    // Track command
    addCommand('Send Email', `Email sent for Order ${t.orderId} (${t.platform})`);
  }
  
  function sendWhatsApp(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    
    const templateType = getTemplateType(t);
    const bn = branchWhats[t.branch] || '';
    
    let message = '';
    
    switch (templateType) {
      case 'missing_incorrect':
        message = `Dispute Rejection - Order ${t.orderId}\nDear ${t.platform} Support Team,\n\nThis is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.\n\nWe have noted the deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}". After reviewing our records and attached video evidence, the order was fully prepared and delivered as requested.\n\nWe therefore reject this adjustment and request reversal.\n\nBest regards,\n${t.branch}`;
        break;
        
      case 'driver_fault':
        message = `Dispute Rejection - Order ${t.orderId}\nDear ${t.platform} Support Team,\n\nThis is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.\n\nThe deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "Spilled / Damaged" cannot be applied, as the order was properly packed and handed over in perfect condition. The damage occurred during delivery due to driver mishandling and is not the restaurant's responsibility.\n\nWe kindly request reversal of this adjustment.\n\nBest regards,\n${t.branch}`;
        break;
        
      case 'no_evidence':
        message = `Dispute Rejection - Order ${t.orderId}\nDear ${t.platform} Support Team,\n\nThis is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}, with a basket amount of AED ${Number(t.originalAmount || 0).toFixed(2)}.\n\nWe have noted the deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}". No verifiable evidence has been provided to justify this adjustment, as required under platform policy and UAE Consumer Protection Law.\n\nTherefore, we reject this deduction and request immediate reversal.\n\nBest regards,\n${t.branch}`;
        break;
        
      case 'video_proof':
        message = `Dispute Rejection - Order ${t.orderId}\nDear ${t.platform} Support Team,\n\nThis is regarding Order ${t.orderId} from ${t.branch} on ${formatDateISO(t.orderDate)}.\n\nThe deduction of AED ${Number(t.compensation || 0).toFixed(2)} for "${t.issue}" is rejected. The attached video clearly shows the order was fully prepared and delivered correctly.\n\nPlease reverse the adjustment accordingly.\n\nBest regards,\n${t.branch}`;
        break;
      
      default:
        message = `Order ID: ${t.orderId}\nDate: ${formatDateISO(t.orderDate)}\nBranch: ${t.branch}\nPlatform: ${t.platform}\nCase: ${t.issue}\nOriginal Amount: AED ${Number(t.originalAmount || 0).toFixed(2)}\nCompensation: AED ${Number(t.compensation || 0).toFixed(2)}\nRefunded: AED ${Number(t.refundedAmount || 0).toFixed(2)}\nStatus: ${t.status}`;
    }
    
    if (bn) {
      window.open(`https://wa.me/${bn}?text=${encodeURIComponent(message)}`, '_blank');
    } else {
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    t.status = 'Sent';
    save();
    renderAll();
    showToast('WhatsApp opened', 'success');
    
    // Track command
    addCommand('Send WhatsApp', `WhatsApp message sent for Order ${t.orderId}`);
  }
  
  // ===== Rejection functionality =====
  function openRejectionModal() {
    // Fill with only open cases
    const openCases = tickets.filter(t => t.status === 'Open' || t.status === 'Sent');
    const caseSelect = document.getElementById('rejectionCase');
    caseSelect.innerHTML = '<option value="">اختر حالة</option>';
    
    openCases.forEach(ticket => {
      const option = document.createElement('option');
      option.value = ticket.id;
      option.textContent = `${ticket.orderId} - ${ticket.branch} (${ticket.platform})`;
      caseSelect.appendChild(option);
    });
    
    new bootstrap.Modal(document.getElementById('rejectionModal')).show();
    addCommand('Open Rejection Modal');
  }
  
  function openRejectionModalForCase(caseId) {
    // Fill the case directly
    const ticket = tickets.find(t => t.id === caseId);
    if (!ticket) return;
    
    document.getElementById('rejectionCase').value = ticket.id;
    document.getElementById('rejectionReason').value = '';
    document.getElementById('rejectionNotes').value = '';
    document.getElementById('sendEmail').checked = true;
    document.getElementById('sendWhatsApp').checked = false;
    
    new bootstrap.Modal(document.getElementById('rejectionModal')).show();
    addCommand('Open Rejection Modal for Case', `Order ${ticket.orderId}`);
  }
  
  document.getElementById('rejectionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const caseId = document.getElementById('rejectionCase').value;
    const reason = document.getElementById('rejectionReason').value;
    const notes = document.getElementById('rejectionNotes').value;
    const sendEmail = document.getElementById('sendEmail').checked;
    const sendWhatsApp = document.getElementById('sendWhatsApp').checked;
    
    const ticket = tickets.find(t => t.id === caseId);
    if (!ticket) return;
    
    // Update ticket status to "Rejected"
    ticket.status = 'Rejected';
    ticket.rejectionReason = reason;
    ticket.rejectionNotes = notes;
    ticket.rejectionDate = new Date().toISOString();
    
    // Create rejection message
    const rejectionMessage = generateRejectionMessage(ticket, reason, notes);
    
    // Send email if selected
    if (sendEmail) {
      sendRejectionEmail(ticket, rejectionMessage);
    }
    
    // Send WhatsApp if selected
    if (sendWhatsApp) {
      sendRejectionWhatsApp(ticket, rejectionMessage);
    }
    
    // Save data
    save();
    renderAll();
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('rejectionModal')).hide();
    
    // Show success notification
    showToast('تم رفض التعويض بنجاح', 'success');
    
    // Track command
    addCommand('Reject Compensation', `تم رفض تعويض الحالة ${ticket.orderId}`);
  });
  
  function generateRejectionMessage(ticket, reason, notes) {
    const templates = {
      no_evidence: `بخصوص الحالة رقم ${ticket.orderId}، نحن نرفض طلب التعويض لعدم وجود دليل يثبت الادعاء. وفقًا لسياسة المنصة وقانون حماية المستهلك في الإمارات، يجب تقديم دليل مادي لدعم المطالبة التعويضية.`,
      incorrect_claim: `بخصوص الحالة رقم ${ticket.orderId}، نحن نرفض طلب التعويض لأن الادعاء غير صحيح. السجلات تظهر أن الطلب تمت معالجته بشكل صحيح وتم تسليمه كما هو مطلوب.`,
      driver_fault: `بخصوص الحالة رقم ${ticket.orderId}، نحن نرفض طلب التعويض لأن المشكلة ناتجة عن خطأ السائق أثناء التوصيل. المطعم لا يتحمل مسؤولية الأضرار الناتجة عن التعامل غير السليم من قبل السائق.`,
      customer_error: `بخصوص الحالة رقم ${ticket.orderId}، نحن نرفض طلب التعويض لأن المشكلة ناتجة عن خطأ من العميل. الطلب تمت معالجته وفقًا للمعلومات المقدمة من العميل.`,
      other: `بخصوص الحالة رقم ${ticket.orderId}، نحن نرفض طلب التعويض للأسباب التالية: ${notes}`
    };
    
    const baseMessage = `مرحباً،
نحن نكتب فيما يخص طلب التعويض الخاص بالطلب رقم ${ticket.orderId} بتاريخ ${formatDateISO(ticket.orderDate)} من مطعم ${ticket.branch} عبر منصة ${ticket.platform}.
بعد مراجعة السجلات والتحقق من الحالة، نرى أن هذا الطلب لا يستحق التعويض، وذلك للأسباب التالية:
${templates[reason] || notes}
نحن نرفض هذا الطلب ونطلب إلغاء التعويض المطبق.
مع خالص التقدير،
${ticket.branch}`;
    return baseMessage;
  }
  
  function sendRejectionEmail(ticket, message) {
    const subject = `رفض طلب التعويض - Order ${ticket.orderId}`;
    const emailBody = message;
    
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
  }
  
  function sendRejectionWhatsApp(ticket, message) {
    const branchNumber = branchWhats[ticket.branch] || '';
    
    if (branchNumber) {
      const whatsappUrl = `https://wa.me/${branchNumber}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    } else {
      // Use default number if no specific branch number
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }
  }
  
  // ===== Other actions =====
  function copyTicket(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    const txt = `Order ID: ${t.orderId}\nDate: ${formatDateISO(t.orderDate)}\nBranch: ${t.branch}\nPlatform: ${t.platform}\nCase: ${t.issue}\nOriginal Amount: AED ${Number(t.originalAmount || 0).toFixed(2)}\nCompensation: AED ${Number(t.compensation || 0).toFixed(2)}\nRefunded: AED ${Number(t.refundedAmount || 0).toFixed(2)}`;
    navigator.clipboard.writeText(txt).then(() => showToast('Copied to clipboard', 'success'), () => showToast('Copy failed', 'error'));
    
    // Track command
    addCommand('Copy Ticket', `Copied details for Order ${t.orderId}`);
  }
  
  // ===== Issue modal =====
  function openIssueModal(id) {
    const t = tickets.find(x => x.id === id); 
    if (!t) return;
    document.getElementById('issueText').textContent = t.issue;
    new bootstrap.Modal(document.getElementById('issueModal')).show();
    
    // Track command
    addCommand('View Issue', `Viewing issue details for Order ${t.orderId}`);
  }
  
  // ===== Dock logic =====
  dockToggle.addEventListener('click', () => {
    dockPanel.classList.toggle('show');
  });
  
  // Draggable dock
  (function() {
    let dragging = false, offsetX = 0, offsetY = 0;
    dock.addEventListener('mousedown', (e) => {
      if (e.target.id === 'dockToggle' || e.target.closest('.dock-panel')) return;
      dragging = true;
      const rect = dock.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      dock.style.transition = 'none';
      document.body.style.userSelect = 'none';
    });
    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      dock.style.left = (e.clientX - offsetX) + 'px';
      dock.style.top = (e.clientY - offsetY) + 'px';
      dock.style.right = 'auto'; dock.style.bottom = 'auto';
    });
    document.addEventListener('mouseup', () => { 
      dragging = false; 
      document.body.style.userSelect = 'auto'; 
      dock.style.transition = ''; 
    });
  })();
  
  // ===== Auto-grow textarea =====
  function autogrow(el) { 
    if (!el) return; 
    el.style.height = 'auto'; 
    el.style.height = (el.scrollHeight) + 'px'; 
  }
  document.addEventListener('input', (e) => { 
    if (e.target && e.target.matches('textarea.autogrow')) autogrow(e.target); 
  });
  
  // ===== Search & filters =====
  searchInput.addEventListener('input', debounce(() => renderTickets(), 200));
  filterBranch.addEventListener('change', () => renderTickets());
  filterPlatform.addEventListener('change', () => renderTickets());
  filterStatus.addEventListener('change', () => renderTickets());
  function debounce(fn, ms = 200) { 
    let t; 
    return (...a) => { 
      clearTimeout(t); 
      t = setTimeout(() => fn(...a), ms); 
    }; 
  }
  
  // ===== Check for duplicate order IDs =====
  function checkDuplicateOrder(orderId, platform, excludeId = null) {
    const filteredTickets = excludeId 
      ? tickets.filter(t => t.id !== excludeId)
      : tickets;
    
    return filteredTickets.some(ticket => {
      if (platform === 'Careem' && ticket.orderId === orderId) {
        return true;
      }
      if (platform === 'Noon' && ticket.orderId === orderId) {
        return true;
      }
      return false;
    });
  }
  
  // ===== Check for duplicates while typing =====
  document.getElementById('f_orderId').addEventListener('input', function(e) {
    const orderId = e.target.value.trim();
    const platform = document.getElementById('f_platform').value;
    const id = document.getElementById('editingId').value;
    
    if (!orderId || !platform) {
      document.getElementById('duplicateWarning').classList.remove('show');
      return;
    }
    
    const isDuplicate = checkDuplicateOrder(orderId, platform, id);
    
    if (isDuplicate) {
      document.getElementById('duplicateWarning').classList.add('show');
      document.getElementById('duplicateWarning').textContent = 'This order ID already exists!';
    } else {
      document.getElementById('duplicateWarning').classList.remove('show');
    }
  });
  
  document.getElementById('f_platform').addEventListener('change', function(e) {
    const orderId = document.getElementById('f_orderId').value.trim();
    const id = document.getElementById('editingId').value;
    
    if (!orderId) {
      document.getElementById('duplicateWarning').classList.remove('show');
      return;
    }
    
    const isDuplicate = checkDuplicateOrder(orderId, e.target.value, id);
    
    if (isDuplicate) {
      document.getElementById('duplicateWarning').classList.add('show');
      document.getElementById('duplicateWarning').textContent = 'This order ID already exists!';
    } else {
      document.getElementById('duplicateWarning').classList.remove('show');
    }
  });
  
  // ===== Export functions =====
  function exportExcel() {
    const wb = XLSX.utils.book_new();
    const data = tickets.map(t => ({
      OrderID: t.orderId,
      OrderDate: t.orderDate,
      Branch: t.branch,
      Platform: t.platform,
      Case: t.issue,
      OriginalAmount: t.originalAmount,
      Compensation: t.compensation,
      RefundedAmount: t.refundedAmount,
      IsRefunded: t.isRefunded,
      RefundDate: t.refundDate,
      Evidence: t.evidence,
      Status: t.status,
      RejectionReason: t.rejectionReason,
      RejectionNotes: t.rejectionNotes,
      DateCreated: t.dateCreated || ''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Cases");
    XLSX.writeFile(wb, `compensation_cases_${new Date().toISOString().slice(0, 10)}.xlsx`);
    
    // Track command
    addCommand('Export Excel', `Exported ${tickets.length} cases to Excel`);
  }
  
  async function exportPDF() {
    try {
      dockPanel.classList.remove('show');
      dockToggle.style.display = 'none';
      await sleep(150);
      const el = document.querySelector('#ticketsContainer');
      const canvas = await html2canvas(el, { scale: 1.5, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 20;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      pdf.save(`cases_${new Date().toISOString().slice(0, 10)}.pdf`);
      
      // Track command
      addCommand('Export PDF', `Exported cases to PDF`);
    } catch (err) { 
      console.error(err); 
      showToast('PDF export failed', 'error'); 
    } finally { 
      dockToggle.style.display = 'flex'; 
    }
  }
  
  async function exportDashboardSummary() {
    try {
      dockPanel.classList.remove('show'); 
      dockToggle.style.display = 'none';
      await sleep(200);
      const summaryEl = document.querySelector('.summary-section');
      const reportsEl = document.getElementById('reports');
      const ticketsEl = document.getElementById('ticketsContainer');
      const caseAnalysisEl = document.querySelector('.case-analysis-section');
      const refundAnalysisEl = document.querySelector('.refund-analysis-section');
      const compensationAnalysisEl = document.querySelector('.compensation-analysis-section');
      const rejectionAnalysisEl = document.querySelector('.rejection-analysis-section');
      
      // Render each section to canvas
      const canvas1 = await html2canvas(summaryEl, { scale: 1.5, useCORS: true });
      const canvas2 = await html2canvas(reportsEl, { scale: 1.5, useCORS: true });
      const canvas3 = await html2canvas(ticketsEl, { scale: 1.5, useCORS: true });
      const canvas4 = await html2canvas(caseAnalysisEl, { scale: 1.5, useCORS: true });
      const canvas5 = await html2canvas(refundAnalysisEl, { scale: 1.5, useCORS: true });
      const canvas6 = await html2canvas(compensationAnalysisEl, { scale: 1.5, useCORS: true });
      const canvas7 = await html2canvas(rejectionAnalysisEl, { scale: 1.5, useCORS: true });
      
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageW = pdf.internal.pageSize.getWidth();
      
      // First page: summary
      pdf.addPage();
      const img1 = canvas1.toDataURL('image/png');
      const img1Props = pdf.getImageProperties(img1);
      const img1W = pageW - 20;
      const img1H = img1Props.height * img1W / img1Props.width;
      pdf.addImage(img1, 'PNG', 10, 10, img1W, img1H);
      
      // Second page: reports
      pdf.addPage();
      const img2 = canvas2.toDataURL('image/png');
      const img2Props = pdf.getImageProperties(img2);
      const img2W = pageW - 20;
      const img2H = img2Props.height * img2W / img2Props.width;
      pdf.addImage(img2, 'PNG', 10, 10, img2W, img2H);
      
      // Third page: cases table
      pdf.addPage();
      const img3 = canvas3.toDataURL('image/png');
      const img3Props = pdf.getImageProperties(img3);
      const img3W = pageW - 20;
      const img3H = img3Props.height * img3W / img3Props.width;
      pdf.addImage(img3, 'PNG', 10, 10, img3W, img3H);
      
      // Fourth page: case analysis
      pdf.addPage();
      const img4 = canvas4.toDataURL('image/png');
      const img4Props = pdf.getImageProperties(img4);
      const img4W = pageW - 20;
      const img4H = img4Props.height * img4W / img4Props.width;
      pdf.addImage(img4, 'PNG', 10, 10, img4W, img4H);
      
      // Fifth page: refund analysis
      pdf.addPage();
      const img5 = canvas5.toDataURL('image/png');
      const img5Props = pdf.getImageProperties(img5);
      const img5W = pageW - 20;
      const img5H = img5Props.height * img5W / img5Props.width;
      pdf.addImage(img5, 'PNG', 10, 10, img5W, img5H);
      
      // Sixth page: compensation analysis
      pdf.addPage();
      const img6 = canvas6.toDataURL('image/png');
      const img6Props = pdf.getImageProperties(img6);
      const img6W = pageW - 20;
      const img6H = img6Props.height * img6W / img6Props.width;
      pdf.addImage(img6, 'PNG', 10, 10, img6W, img6H);
      
      // Seventh page: rejection analysis
      pdf.addPage();
      const img7 = canvas7.toDataURL('image/png');
      const img7Props = pdf.getImageProperties(img7);
      const img7W = pageW - 20;
      const img7H = img7Props.height * img7W / img7Props.width;
      pdf.addImage(img7, 'PNG', 10, 10, img7W, img7H);
      
      pdf.save(`dashboard_summary_${new Date().toISOString().slice(0, 10)}.pdf`);
      
      // Track command
      addCommand('Export Dashboard PDF', `Exported dashboard summary to PDF`);
    } catch (err) { 
      console.error(err); 
      showToast('Dashboard PDF export failed', 'error'); 
    } finally { 
      dockToggle.style.display = 'flex'; 
    }
  }
  
  // ===== Usability heatmap & export log =====
  function initHeatmap() {
    heatmapInstance = h337.create({ 
      container: heatmapContainer, 
      radius: 35, 
      maxOpacity: 0.6, 
      minOpacity: 0.05, 
      blur: 0.75 
    });
    document.addEventListener('click', (e) => recordInteraction(e));
    document.addEventListener('mousemove', throttle((e) => recordMouseMove(e), 120));
  }
  
  function toggleHeatmap() {
    heatmapVisible = !heatmapVisible;
    heatmapContainer.style.display = heatmapVisible ? 'block' : 'none';
    document.getElementById('heatmapToggleBtn').classList.toggle('active', heatmapVisible);
    
    // Track command
    addCommand('Toggle Heatmap', `Heatmap ${heatmapVisible ? 'enabled' : 'disabled'}`);
  }
  
  function recordInteraction(e) {
    const el = e.target;
    const entry = { 
      t: Date.now(), 
      type: 'click', 
      x: e.clientX, 
      y: e.clientY, 
      tag: el.tagName, 
      id: el.id || null, 
      cls: el.className || null 
    };
    interactions.push(entry);
    if (interactions.length > 500) interactions.shift();
    if (heatmapInstance) heatmapInstance.addData({ x: e.clientX, y: e.clientY, value: 1 });
  }
  
  function recordMouseMove(e) {
    if (!heatmapVisible) return;
    if (heatmapInstance) heatmapInstance.addData({ x: e.clientX, y: e.clientY, value: 0.15 });
  }
  
  function exportUsabilityLog() {
    const data = JSON.stringify({ at: new Date().toISOString(), interactions }, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `usability_log_${new Date().toISOString().slice(0, 10)}.json`; 
    a.click(); 
    URL.revokeObjectURL(url);
    showToast('Usability log exported', 'success');
    
    // Track command
    addCommand('Export Usability Log', 'Exported user interaction log');
  }
  
  // ===== Setup listeners =====
  function setupListeners() {
    // Close dock on outside click
    document.addEventListener('click', (e) => {
      if (!dock.contains(e.target) && dockPanel.classList.contains('show')) {
        dockPanel.classList.remove('show');
      }
    });
    
    // Auto-grow init
    document.querySelectorAll('textarea.autogrow').forEach(t => autogrow(t));
    
    // Populate branch selects
    populateBranchFilters();
  }
  
  // ===== Helpers =====
  function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }
  function escapeHtml(s = '') { 
    return (s + '').replace(/[&<>"']/g, c => ({ 
      '&': '&amp;', 
      '<': '&lt;', 
      '>': '&gt;', 
      '"': '&quot;', 
      "'": '&#39;' 
    }[c])); 
  }
  function throttle(fn, ms) { 
    let last = 0; 
    return function(...a) { 
      const now = Date.now(); 
      if (now - last > ms) { 
        last = now; 
        fn(...a); 
      } 
    }; 
  }
  
  // Print function
  function printReport() {
    window.print();
    addCommand('Print Report');
  }
  </script>
</body>
</html>
